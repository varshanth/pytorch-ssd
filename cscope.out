cscope 15 $HOME/Downloads/pytorch-ssd               0000173709
	@convert_to_caffe2_models.py

1 
äom
 
	gvisiÚ
.
	gssd
.
vgg_ssd
 
impÜt
 
ü—‹_vgg_ssd


2 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd
 
impÜt
 
ü—‹_mob’‘v1_ssd


3 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd_l™e
 
impÜt
 
ü—‹_mob’‘v1_ssd_l™e


4 
äom
 
	gvisiÚ
.
	gssd
.
squ“z’‘_ssd_l™e
 
impÜt
 
ü—‹_squ“z’‘_ssd_l™e


6 
impÜt
 
sys


7 
impÜt
 
	gtÜch
.
Únx


8 
äom
 
	gÿfã2
.
	gpythÚ
.
	gÚnx
.
back’d
 
impÜt
 
Cafã2Back’d
 
as
 
c2


9 
impÜt
 
Únx


12 
Ën
(
sys
.
¬gv
) < 3:

13 
´št
('Usage:…ython convert_to_caffe2_models.py <netype: mobilenet-v1-ssd|others> <model…ath>')

14 
sys
.
	$ex™
(0)

15 
Ãt_ty³
 = 
sys
.
¬gv
[1]

16 
mod–_·th
 = 
sys
.
¬gv
[2]

18 
Ïb–_·th
 = 
sys
.
¬gv
[3]

20 
şass_Çmes
 = [
Çme
.
	$¡r
(è
Çme
 
š
 
	`İ’
(
Ïb–_·th
).
	`»adlšes
()]

21 
num_şas£s
 = 
	$Ën
(
şass_Çmes
)

23 
Ãt_ty³
 == 'vgg16-ssd':

24 
Ãt
 = 
	`ü—‹_vgg_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

25 
–if
 
Ãt_ty³
 == 'mb1-ssd':

26 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

27 
–if
 
Ãt_ty³
 == 'mb1-ssd-lite':

28 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

29 
–if
 
Ãt_ty³
 == 'sq-ssd-lite':

30 
Ãt
 = 
	`ü—‹_squ“z’‘_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

32 
	`´št
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

33 
sys
.
	$ex™
(1)

34 
Ãt
.
	$lßd
(
mod–_·th
)

35 
Ãt
.
	$ev®
()

37 
mod–_·th
 = 
f
"models/{net_type}.onnx"

38 
š™_Ãt_·th
 = 
f
"models/{net_type}_init_net.pb"

39 
š™_Ãt_txt_·th
 = 
f
"models/{net_type}_init_net.pbtxt"

40 
´ediù_Ãt_·th
 = 
f
"models/{net_type}_predict_net.pb"

41 
´ediù_Ãt_txt_·th
 = 
f
"models/{net_type}_predict_net.pbtxt"

43 
dummy_šput
 = 
tÜch
.
	$¿ndn
(1, 3, 300, 300)

44 
tÜch
.
Únx
.
	`expÜt
(
Ãt
, 
dummy_šput
, 
mod–_·th
, 
v”bo£
=
F®£
, 
ouut_Çmes
=['scores', 'boxes'])

46 
mod–
 = 
Únx
.
	$lßd
(
mod–_·th
)

47 
š™_Ãt
, 
´ediù_Ãt
 = 
c2
.
	$Únx_g¿ph_to_ÿfã2_Ãt
(
mod–
)

49 
	`´št
(
f
"Savehe model in binary formatohe files {init_net_path}‡nd {predict_net_path}.")

51 
w™h
 
	`İ’
(
š™_Ãt_·th
, "wb"è
as
 
fİ’
:

52 
fİ’
.
	`wr™e
(
š™_Ãt
.
	$S”ŸlizeToSŒšg
())

53 
w™h
 
	`İ’
(
´ediù_Ãt_·th
, "wb"è
as
 
fİ’
:

54 
fİ’
.
	`wr™e
(
´ediù_Ãt
.
	$S”ŸlizeToSŒšg
())

56 
	`´št
(
f
"Savehe model inxt formatohe files {init_net_txt_path}‡nd {predict_net_txt_path}. ")

57 
w™h
 
	`İ’
(
š™_Ãt_txt_·th
, 'w'è
as
 
f
:

58 
f
.
	`wr™e
(
	$¡r
(
š™_Ãt
))

60 
w™h
 
	`İ’
(
´ediù_Ãt_txt_·th
, 'w'è
as
 
f
:

61 
f
.
	`wr™e
(
	`¡r
(
´ediù_Ãt
))

	@draw_eval_results.py

1 
impÜt
 
sys


2 
impÜt
 
cv2


3 
impÜt
 
·ndas
 
as
 
pd


4 
impÜt
 
os


6 
	gev®_»suÉ_fe
 = 
sys
.
¬gv
[1]

7 
image_dœ
 = 
sys
.
¬gv
[2]

8 
ouut_dœ
 = 
sys
.
¬gv
[3]

9 
th»shŞd
 = (
sys
.
¬gv
[4])

11 
nÙ
 
os
.
·th
.
	$exi¡s
(
ouut_dœ
):

12 
os
.
	$mkdœ
(
ouut_dœ
)

14 
r
 = 
pd
.
	`»ad_csv
(
ev®_»suÉ_fe
, 
d–im™”
=" ", 
Çmes
=["ImageID", "Prob", "x1", "y1", "x2", "y2"])

15 
r
['x1'] =„['x1'].
	$a¡y³
()

16 
r
['y1'] =„['y1'].
	$a¡y³
()

17 
r
['x2'] =„['x2'].
	$a¡y³
()

18 
r
['y2'] =„['y2'].
	$a¡y³
()

21 
image_id
, 
g
 
š
 
r
.
	`groupby
('ImageID'):

22 
image
 = 
cv2
.
	`im»ad
(
os
.
·th
.
	`još
(
image_dœ
, 
image_id
 + ".jpg"))

23 
row
 
š
 
g
.
	$™”tu¶es
():

24 
row
.
Prob
 < 
th»shŞd
:

26 
cv2
.
	`»ùªgË
(
image
, (
row
.
x1
,„ow.
y1
), (row.
x2
,„ow.
y2
), (255, 255, 0), 4)

27 
Ïb–
 = 
f
"{row.Prob:.2f}"

28 
cv2
.
	`putText
(
image
, 
Ïb–
,

29 (
row
.
x1
 + 20,„ow.
y1
 + 40),

30 
cv2
.
FONT_HERSHEY_SIMPLEX
,

31 1, #fÚˆ
sÿË


33 2è#lš
ty³


34 
cv2
.
	`imwr™e
(
os
.
·th
.
	`još
(
ouut_dœ
, 
image_id
 + ".jpg"), 
image
)

35 
	`´št
(
f
"Task Done. Processed {r.shape[0]} bounding boxes.")

	@eval_ssd.py

1 
impÜt
 
tÜch


2 
äom
 
	gvisiÚ
.
	gssd
.
vgg_ssd
 
impÜt
 
	gü—‹_vgg_ssd
, 
ü—‹_vgg_ssd_´ediùÜ


3 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd
 
impÜt
 
	gü—‹_mob’‘v1_ssd
, 
ü—‹_mob’‘v1_ssd_´ediùÜ


4 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v1_ssd_l™e
, 
ü—‹_mob’‘v1_ssd_l™e_´ediùÜ


5 
äom
 
	gvisiÚ
.
	gssd
.
squ“z’‘_ssd_l™e
 
impÜt
 
	gü—‹_squ“z’‘_ssd_l™e
, 
ü—‹_squ“z’‘_ssd_l™e_´ediùÜ


6 
äom
 
	gvisiÚ
.
	gd©a£ts
.
voc_d©a£t
 
impÜt
 
VOCD©a£t


7 
äom
 
	gvisiÚ
.
	gd©a£ts
.
İ’_images
 
impÜt
 
O³nImagesD©a£t


8 
äom
 
	gvisiÚ
.
uts
 
impÜt
 
	gbox_uts
, 
m—su»m’ts


9 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
	g¡r2boŞ
, 
Tim”


10 
impÜt
 
¬g·r£


11 
impÜt
 
·thlib


12 
impÜt
 
numpy
 
as
 
Å


13 
impÜt
 
loggšg


14 
impÜt
 
sys


15 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘_v2_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v2_ssd_l™e
, 
ü—‹_mob’‘v2_ssd_l™e_´ediùÜ


18 
	g·r£r
 = 
¬g·r£
.
Argum’tP¬£r
(
desütiÚ
="SSD Evaluation on VOC Dataset.")

19 
·r£r
.
add_¬gum’t
('--net', ="vgg16-ssd",

20 
h–p
="The‚etwork‡rchitecture, it should be of mb1-ssd, mb1-ssd-lite, mb2-ssd-lite or vgg16-ssd.")

21 
·r£r
.
add_¬gum’t
("--Œašed_mod–", 
ty³
=
¡r
)

23 
·r£r
.
add_¬gum’t
("--d©a£t_ty³", ="voc", 
ty³
=
¡r
,

24 
h–p
='Specify datasetype. Currently support voc‡nd open_images.')

25 
·r£r
.
add_¬gum’t
("--d©a£t", 
ty³
=
¡r
, 
h–p
="The„oot directory ofhe VOC dataset or Open Images dataset.")

26 
·r£r
.
add_¬gum’t
("--Ïb–_fe", 
ty³
=
¡r
, 
h–p
="The†abel file…ath.")

27 
·r£r
.
add_¬gum’t
("--u£_cuda", 
ty³
=
¡r2boŞ
, =
True
)

28 
·r£r
.
add_¬gum’t
("--u£_2007_m‘ric", 
ty³
=
¡r2boŞ
, =
True
)

29 
·r£r
.
add_¬gum’t
("--nms_m‘hod", 
ty³
=
¡r
, ="hard")

30 
·r£r
.
add_¬gum’t
("--iou_th»shŞd", 
ty³
=, =0.5, 
h–p
="Thehreshold of Intersection over Union.")

31 
·r£r
.
add_¬gum’t
("--ev®_dœ", ="ev®_»suÉs", 
ty³
=
¡r
, 
h–p
="The directoryo storeƒvaluation„esults.")

32 
·r£r
.
add_¬gum’t
('--mb2_width_muÉ', =1.0, 
ty³
=,

33 
h–p
='Width Multiplifier for MobilenetV2')

34 
¬gs
 = 
·r£r
.
	$·r£_¬gs
()

35 
DEVICE
 = 
tÜch
.
	`deviû
("cuda:0" tÜch.
cuda
.
	$is_avaabË
(è
ªd
 
¬gs
.
u£_cuda
 "cpu")

38 
def
 
	$group_ªnÙ©iÚ_by_şass
(
d©a£t
):

39 
Œue_ÿ£_¡©
 = {
	}
}

40 
®l_gt_boxes
 = {}

41 
®l_difficuÉ_ÿ£s
 = {}

42 
i
 
š
 
¿nge
(
	$Ën
(
d©a£t
)):

43 
image_id
, 
ªnÙ©iÚ
 = 
d©a£t
.
	$g‘_ªnÙ©iÚ
(
i
)

44 
gt_boxes
, 
şas£s
, 
is_difficuÉ
 = 
ªnÙ©iÚ


45 
gt_boxes
 = 
tÜch
.
	$äom_numpy
(
gt_boxes
)

46 
i
, 
difficuÉ
 
š
 
	$’um”©e
(
is_difficuÉ
):

47 
şass_šdex
 = (
şas£s
[
i
])

48 
gt_box
 = 
gt_boxes
[
i
]

49 
nÙ
 
difficuÉ
:

50 
Œue_ÿ£_¡©
[
şass_šdex
] =rue_ÿ£_¡©.
	`g‘
(class_index, 0) + 1

52 
şass_šdex
 
nÙ
 
š
 
®l_gt_boxes
:

53 
®l_gt_boxes
[
şass_šdex
] = {
	}
}

54 
image_id
 
nÙ
 
š
 
®l_gt_boxes
[
şass_šdex
]:

55 
®l_gt_boxes
[
şass_šdex
][
image_id
] = []

56 
®l_gt_boxes
[
şass_šdex
][
image_id
].
	$­³nd
(
gt_box
)

57 
şass_šdex
 
nÙ
 
š
 
®l_difficuÉ_ÿ£s
:

58 
®l_difficuÉ_ÿ£s
[
şass_šdex
]={
	}
}

59 
image_id
 
nÙ
 
š
 
®l_difficuÉ_ÿ£s
[
şass_šdex
]:

60 
®l_difficuÉ_ÿ£s
[
şass_šdex
][
image_id
] = []

61 
®l_difficuÉ_ÿ£s
[
şass_šdex
][
image_id
].
	$­³nd
(
difficuÉ
)

63 
şass_šdex
 
š
 
®l_gt_boxes
:

64 
image_id
 
š
 
®l_gt_boxes
[
şass_šdex
]:

65 
®l_gt_boxes
[
şass_šdex
][
image_id
] = 
tÜch
.
	$¡ack
(
®l_gt_boxes
[
şass_šdex
][
image_id
])

66 
şass_šdex
 
š
 
®l_difficuÉ_ÿ£s
:

67 
image_id
 
š
 
®l_difficuÉ_ÿ£s
[
şass_šdex
]:

68 
®l_gt_boxes
[
şass_šdex
][
image_id
] = 
tÜch
.
	$‹nsÜ
(
®l_gt_boxes
[
şass_šdex
][
image_id
])

69  
Œue_ÿ£_¡©
, 
®l_gt_boxes
, 
®l_difficuÉ_ÿ£s


72 
def
 
	$compu‹_av”age_´ecisiÚ_³r_şass
(
num_Œue_ÿ£s
, 
gt_boxes
, 
difficuÉ_ÿ£s
,

73 
´ediùiÚ_fe
, 
iou_th»shŞd
, 
u£_2007_m‘ric
):

74 
w™h
 
	$İ’
(
´ediùiÚ_fe
è
as
 
f
:

75 
image_ids
 = []

76 
boxes
 = []

77 
scÜes
 = []

78 
lše
 
š
 
f
:

79 
t
 = 
lše
.
	`r¡r
().
	`¥l™
(" ")

80 
image_ids
.
	$­³nd
(
t
[0])

81 
scÜes
.
	`­³nd
((
t
[1]))

82 
box
 = 
tÜch
.
	`‹nsÜ
([(
v
èv 
š
 
t
[2:]]).
	$unsqu“ze
(0)

83 
box
 -ğ1.0 #cÚv”ˆ
to
 
pythÚ
 
fÜm©
 
wh”e
 
šdexes
 
¡¬t
 
äom
 0

84 
boxes
.
	$­³nd
(
box
)

85 
scÜes
 = 
Å
.
	$¬¿y
(
scÜes
)

86 
sÜ‹d_šdexes
 = 
Å
.
	`¬gsÜt
(-
scÜes
)

87 
boxes
 = [boxes[
i
] ˜
š
 
sÜ‹d_šdexes
]

88 
image_ids
 = [image_ids[
i
] ˜
š
 
sÜ‹d_šdexes
]

89 
Œue_pos™ive
 = 
Å
.
	`z”os
(
	$Ën
(
image_ids
))

90 
çl£_pos™ive
 = 
Å
.
	`z”os
(
	$Ën
(
image_ids
))

91 
m©ched
 = 
	$£t
()

92 
i
, 
image_id
 
š
 
	$’um”©e
(
image_ids
):

93 
box
 = 
boxes
[
i
]

94 
image_id
 
nÙ
 
š
 
gt_boxes
:

95 
çl£_pos™ive
[
i
] = 1

98 
gt_box
 = 
gt_boxes
[
image_id
]

99 
ious
 = 
box_uts
.
	$iou_of
(
box
, 
gt_box
)

100 
max_iou
 = 
tÜch
.
	`max
(
ious
).
	$™em
()

101 
max_¬g
 = 
tÜch
.
	`¬gmax
(
ious
).
	$™em
()

102 
max_iou
 > 
iou_th»shŞd
:

103 
difficuÉ_ÿ£s
[
image_id
][
max_¬g
] == 0:

104 ià(
image_id
, 
max_¬g
è
nÙ
 
š
 
m©ched
:

105 
Œue_pos™ive
[
i
] = 1

106 
m©ched
.
	`add
((
image_id
, 
max_¬g
))

108 
çl£_pos™ive
[
i
] = 1

110 
çl£_pos™ive
[
i
] = 1

112 
Œue_pos™ive
 =rue_pos™ive.
	$cumsum
()

113 
çl£_pos™ive
 = f®£_pos™ive.
	$cumsum
()

114 
´ecisiÚ
 = 
Œue_pos™ive
 / (Œue_pos™iv+ 
çl£_pos™ive
)

115 
»ÿÎ
 = 
Œue_pos™ive
 / 
num_Œue_ÿ£s


116 
u£_2007_m‘ric
:

117  
m—su»m’ts
.
	$compu‹_voc2007_av”age_´ecisiÚ
(
´ecisiÚ
, 
»ÿÎ
)

119  
m—su»m’ts
.
	$compu‹_av”age_´ecisiÚ
(
´ecisiÚ
, 
»ÿÎ
)

122 
__Çme__
 == '__main__':

123 
ev®_·th
 = 
·thlib
.
	$P©h
(
¬gs
.
ev®_dœ
)

124 
ev®_·th
.
	$mkdœ
(
exi¡_ok
=
True
)

125 
tim”
 = 
	$Tim”
()

126 
şass_Çmes
 = [
Çme
.
	$¡r
(è
Çme
 
š
 
	`İ’
(
¬gs
.
Ïb–_fe
).
	`»adlšes
()]

128 
¬gs
.
d©a£t_ty³
 == "voc":

129 
d©a£t
 = 
	$VOCD©a£t
(
¬gs
.
d©a£t
, 
is_‹¡
=
True
)

130 
–if
 
¬gs
.
d©a£t_ty³
 == 'open_images':

131 
d©a£t
 = 
	`O³nImagesD©a£t
(
¬gs
.d©a£t, 
d©a£t_ty³
="test")

133 
Œue_ÿ£_¡©
, 
®l_gb_boxes
, 
®l_difficuÉ_ÿ£s
 = 
	$group_ªnÙ©iÚ_by_şass
(
d©a£t
)

134 
¬gs
.
Ãt
 == 'vgg16-ssd':

135 
Ãt
 = 
	`ü—‹_vgg_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

136 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd':

137 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

138 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd-lite':

139 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

140 
–if
 
¬gs
.
Ãt
 == 'sq-ssd-lite':

141 
Ãt
 = 
	`ü—‹_squ“z’‘_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

142 
–if
 
¬gs
.
Ãt
 == 'mb2-ssd-lite':

143 
Ãt
 = 
	`ü—‹_mob’‘v2_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
width_muÉ
=
¬gs
.
mb2_width_muÉ
, 
is_‹¡
=
True
)

145 
loggšg
.
	`çl
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

146 
·r£r
.
	$´št_h–p
(
sys
.
¡d”r
)

147 
sys
.
	$ex™
(1)

149 
tim”
.
	`¡¬t
("Load Model")

150 
Ãt
.
	$lßd
(
¬gs
.
Œašed_mod–
)

151 
Ãt
 =‚‘.
	$to
(
DEVICE
)

152 
	`´št
(
f
'Itook {timer.end("Load Model")} secondso†oadhe model.')

153 
¬gs
.
Ãt
 == 'vgg16-ssd':

154 
´ediùÜ
 = 
	$ü—‹_vgg_ssd_´ediùÜ
(
Ãt
, 
nms_m‘hod
=
¬gs
.nms_m‘hod, 
deviû
=
DEVICE
)

155 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd':

156 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_´ediùÜ
(
Ãt
, 
nms_m‘hod
=
¬gs
.nms_m‘hod, 
deviû
=
DEVICE
)

157 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd-lite':

158 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_l™e_´ediùÜ
(
Ãt
, 
nms_m‘hod
=
¬gs
.nms_m‘hod, 
deviû
=
DEVICE
)

159 
–if
 
¬gs
.
Ãt
 == 'sq-ssd-lite':

160 
´ediùÜ
 = 
	$ü—‹_squ“z’‘_ssd_l™e_´ediùÜ
(
Ãt
,
nms_m‘hod
=
¬gs
.nms_m‘hod, 
deviû
=
DEVICE
)

161 
–if
 
¬gs
.
Ãt
 == 'mb2-ssd-lite':

162 
´ediùÜ
 = 
	$ü—‹_mob’‘v2_ssd_l™e_´ediùÜ
(
Ãt
, 
nms_m‘hod
=
¬gs
.nms_m‘hod, 
deviû
=
DEVICE
)

164 
loggšg
.
	`çl
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

165 
·r£r
.
	$´št_h–p
(
sys
.
¡d”r
)

166 
sys
.
	$ex™
(1)

168 
»suÉs
 = []

169 
i
 
š
 
	`¿nge
(
	$Ën
(
d©a£t
)):

170 
	`´št
("´oûs image", 
i
)

171 
tim”
.
	`¡¬t
("Load Image")

172 
image
 = 
d©a£t
.
	$g‘_image
(
i
)

173 
	`´št
("Lßd Image: {:4f} secÚds.".
	`fÜm©
(
tim”
.
	`’d
("Load Image")))

174 
tim”
.
	`¡¬t
("Predict")

175 
boxes
, 
Ïb–s
, 
´obs
 = 
´ediùÜ
.
	$´ediù
(
image
)

176 
	`´št
("P»diùiÚ: {:4f} secÚds.".
	`fÜm©
(
tim”
.
	`’d
("Predict")))

177 
šdexes
 = 
tÜch
.
	`Úes
(
Ïb–s
.
	`size
(0), 1, 
dty³
ñÜch.
æßt32
è* 
i


178 
»suÉs
.
	`­³nd
(
tÜch
.
	`ÿt
([

179 
šdexes
.
	`»sh­e
(-1, 1),

180 
Ïb–s
.
	`»sh­e
(-1, 1).(),

181 
´obs
.
	`»sh­e
(-1, 1),

182 
boxes
 + 1.0 #matlab's indexes start from 1

183 ], 
dim
=1))

184 
»suÉs
 = 
tÜch
.
	$ÿt
(
»suÉs
)

185 
şass_šdex
, 
şass_Çme
 
š
 
	$’um”©e
(
şass_Çmes
):

186 
şass_šdex
 =ğ0:  #ignÜ
background


187 
´ediùiÚ_·th
 = 
ev®_·th
 / 
f
"det_test_{class_name}.txt"

188 
w™h
 
	`İ’
(
´ediùiÚ_·th
, "w"è
as
 
f
:

189 
sub
 = 
»suÉs
[»suÉs[:, 1] =ğ
şass_šdex
, :]

190 
i
 
š
 
	`¿nge
(
sub
.
	$size
(0)):

191 
´ob_box
 = 
sub
[
i
, 2:].
	$numpy
()

192 
image_id
 = 
d©a£t
.
ids
[(
sub
[
i
, 0])]

193 
	`´št
(

194 
image_id
 + " " + " ".
	`još
([
	$¡r
(
v
èv 
š
 
´ob_box
]),

195 
fe
=
f


197 
­s
 = []

198 
	`´št
("\n\nAverage Precision Per-class:")

199 
şass_šdex
, 
şass_Çme
 
š
 
	$’um”©e
(
şass_Çmes
):

200 
şass_šdex
 == 0:

202 
´ediùiÚ_·th
 = 
ev®_·th
 / 
f
"det_test_{class_name}.txt"

203 
­
 = 
	$compu‹_av”age_´ecisiÚ_³r_şass
(

204 
Œue_ÿ£_¡©
[
şass_šdex
],

205 
®l_gb_boxes
[
şass_šdex
],

206 
®l_difficuÉ_ÿ£s
[
şass_šdex
],

207 
´ediùiÚ_·th
,

208 
¬gs
.
iou_th»shŞd
,

209 
¬gs
.
u£_2007_m‘ric


211 
­s
.
	$­³nd
(
­
)

212 
	`´št
(
f
"{class_name}: {ap}")

214 
	`´št
(
f
"\nAverage Precision Across All Classes:{sum(aps)/len(aps)}")

	@extract_tf_weights.py

1 
impÜt
 
‹nsÜæow
 
as
 
tf


2 
äom
 
	g‹nsÜæow
.
	gpythÚ
.
¶©fÜm
 
impÜt
 
gfe


3 
äom
 
	g‹nsÜæow
.
	gpythÚ
.
äamewÜk
 
impÜt
 
‹nsÜ_ut


4 
impÜt
 
sys


5 
impÜt
 
pickË


8 
def
 
	$»ad_weights
(
äoz’_mod–
):

9 
weights
 = {
	}
}

10 
w™h
 
tf
.
	$SessiÚ
(è
as
 
£ss
:

11 
w™h
 
gfe
.
	`Fa¡GFe
(
äoz’_mod–
, 'rb'è
as
 
f
:

12 
g¿ph_def
 = 
tf
.
	$G¿phDef
()

13 
g¿ph_def
.
	`P¬£FromSŒšg
(
f
.
	$»ad
())

14 
tf
.
	$impÜt_g¿ph_def
(
g¿ph_def
)

15 
n
 
š
 
g¿ph_def
.
node
:

16 
n
.
İ
 == 'Const':

17 
weights
[
n
.
Çme
] = 
‹nsÜ_ut
.
	`MakeNd¬¿y
Ò.
©Œ
['v®ue'].
‹nsÜ
)

18 
	`´št
("Name:", 
n
.
Çme
, "Sh­e:", 
weights
[n.Çme].
sh­e
)

19  
weights


22 
	`Ën
(
sys
.
¬gv
) < 3:

23 
	`´št
("Usage:…ythonƒxtract_tf_weights.py <frozen_model.pb> <weights_file.pickle>")

25 
äoz’_mod–
 = 
sys
.
¬gv
[1]

26 
weights_fe
 = 
sys
.
¬gv
[2]

28 
weights
 = 
	$»ad_weights
(
äoz’_mod–
)

29 
w™h
 
	`İ’
(
weights_fe
, "wb"è
as
 
f
:

30 
pickË
.
	$dump
(
weights
, 
f
)

31 
	`´št
(
f
"Saved weightso {weights_file}.")

	@open_images_downloader.py

1 
impÜt
 
time


2 
impÜt
 
bÙo3


3 
äom
 
bÙocÜe
 
impÜt
 
UNSIGNED


4 
äom
 
	gbÙocÜe
.
cÚfig
 
impÜt
 
CÚfig


5 
impÜt
 
bÙocÜe


6 
impÜt
 
loggšg


7 
äom
 
muÉroûssšg
 
impÜt
 
	gPoŞ
, 
Mªag”


8 
impÜt
 
·ndas
 
as
 
pd


9 
impÜt
 
os


10 
impÜt
 
¬g·r£


11 
impÜt
 
sys


12 
impÜt
 
funùoŞs


13 
äom
 
u¾lib
 
impÜt
 
»que¡


16 
	gs3
 = 
bÙo3
.
ş›Á
('s3', 
cÚfig
=
	$CÚfig
(
sigÇtu»_v”siÚ
=
UNSIGNED
))

19 
def
 
	$dowÆßd
(
buck‘
, 
roÙ
, 
»Œy
, 
couÁ”
, 
lock
, 
·th
):

20 
i
 = 0

21 
¤c
 = 
·th


22 
de¡
 = 
f
"{root}/{path}"

23 
i
 < 
»Œy
:

24 
Œy
:

25 
nÙ
 
os
.
·th
.
	$exi¡s
(
de¡
):

26 
s3
.
	$dowÆßd_fe
(
buck‘
, 
¤c
, 
de¡
)

28 
loggšg
.
	`šfo
(
f
"{dest}‡lreadyƒxists.")

29 
w™h
 
lock
:

30 
couÁ”
.
v®ue
 += 1

31 
couÁ”
.
v®ue
 % 100 == 0:

32 
loggšg
.
	`w¬nšg
(
f
"Downloaded {counter.value} images.")

34 
exû±
 
bÙocÜe
.
exû±iÚs
.
Cl›ÁE¼Ü
 
as
 
e
:

35 
e
.
»¥Ú£
['Error']['Code'] == "404":

36 
loggšg
.
	`w¬nšg
(
f
"The file s3://{bucket}/{src} does‚otƒxist.")

38 
i
 += 1

39 
loggšg
.
	`w¬nšg
(
f
"Sleep {i}‡ndry‡gain.")

40 
time
.
	$¦“p
(
i
)

41 
loggšg
.
	`w¬nšg
(
f
"Failedo downloadhe file s3://{bucket}/{src}. Exception: {e}")

44 
def
 
	$b©ch_dowÆßd
(
buck‘
, 
fe_·ths
, 
roÙ
, 
num_wÜk”s
=10, 
»Œy
=10):

45 
w™h
 
	$PoŞ
(
num_wÜk”s
è
as
 
p
:

46 
m
 = 
	$Mªag”
()

47 
couÁ”
 = 
m
.
	`V®ue
('i', 0)

48 
lock
 = 
m
.
	$Lock
()

49 
dowÆßd_
 = 
funùoŞs
.
	$·¹Ÿl
(
dowÆßd
, 
buck‘
, 
roÙ
, 
»Œy
, 
couÁ”
, 
lock
)

50 
p
.
	$m­
(
dowÆßd_
, 
fe_·ths
)

53 
def
 
	$h‰p_dowÆßd
(
u¾
, 
·th
):

54 
w™h
 
»que¡
.
	$u¾İ’
(
u¾
è
as
 
f
:

55 
w™h
 
	`İ’
(
·th
, "wb"è
as
 
fout
:

56 
buf
 = 
f
.
	$»ad
(1024)

57 
buf
:

58 
fout
.
	$wr™e
(
buf
)

59 
buf
 = 
f
.
	$»ad
(1024)

62 
def
 
	$log_couÁs
(
v®ues
):

63 
k
, 
couÁ
 
š
 
v®ues
.
	`v®ue_couÁs
().
	$™”™ems
():

64 
loggšg
.
	`w¬nšg
(
f
"{k}: {count}/{len(values)} = {count/len(values):.2f}.")

67 
def
 
	$·r£_¬gs
():

68 
·r£r
 = 
¬g·r£
.
	`Argum’tP¬£r
(

69 
desütiÚ
='Dowload open image dataset by class.')

71 
·r£r
.
	`add_¬gum’t
("--roÙ", 
ty³
=
¡r
,

72 
h–p
='The„oot directoryhat you wanto storehe open image data.')

73 
·r£r
.
	`add_¬gum’t
("šşude_d•iùiÚ", 
aùiÚ
="store_true",

74 
h–p
="Do you wanto include drawings or depictions?")

75 
·r£r
.
	`add_¬gum’t
("--şass_Çmes", 
ty³
=
¡r
,

76 
h–p
="the classes you wanto download.")

77 
·r£r
.
	`add_¬gum’t
("--num_wÜk”s", 
ty³
=, =10,

78 
h–p
="the classes you wanto download.")

79 
·r£r
.
	`add_¬gum’t
("--»Œy", 
ty³
=, =10,

80 
h–p
="retryimes when downloading.")

81 
·r£r
.
	`add_¬gum’t
("--f‹r_fe", 
ty³
=
¡r
, ="",

82 
h–p
="This file specifieshe image ids you wantoƒxclude.")

83 
·r£r
.
	`add_¬gum’t
('--»move_ov”Ïµed', 
aùiÚ
='store_true',

84 
h–p
="Remove single boxes covered by group boxes.")

85  
·r£r
.
	$·r£_¬gs
()

88 
__Çme__
 == '__main__':

89 
loggšg
.
	`basicCÚfig
(
¡»am
=
sys
.
¡dout
, 
Ëv–
öoggšg.
WARNING
,

90 
fÜm©
='%(asctime)s - %(name)s - %(message)s')

92 
¬gs
 = 
	$·r£_¬gs
()

93 
buck‘
 = "open-images-dataset"

94 
Çmes
 = [
e
.
	$¡r
(è
e
 
š
 
¬gs
.
şass_Çmes
.
	`¥l™
(",")]

95 
şass_Çmes
 = []

96 
group_f‹rs
 = []

97 
³rûÁages
 = []

98 
Çme
 
š
 
Çmes
:

99 
t
 = 
Çme
.
	`¥l™
(":")

100 
şass_Çmes
.
	`­³nd
(
t
[0].
	$¡r
())

101 
	`Ën
(
t
è>ğ2 
ªd
[1].
	$¡r
():

102 
group_f‹rs
.
	`­³nd
(
t
[1].
	$¡r
())

104 
group_f‹rs
.
	`­³nd
("")

105 
	`Ën
(
t
è>ğ3 
ªd
[2].
	$¡r
():

106 
³rûÁages
.
	`­³nd
((
t
[2].
	$¡r
()))

108 
³rûÁages
.
	$­³nd
(1.0)

110 
nÙ
 
os
.
·th
.
	$exi¡s
(
¬gs
.
roÙ
):

111 
os
.
	$makedœs
(
¬gs
.
roÙ
)

113 
exşuded_images
 = 
	$£t
()

114 
¬gs
.
f‹r_fe
:

115 
lše
 
š
 
	$İ’
(
¬gs
.
f‹r_fe
):

116 
img_id
 = 
lše
.
	$¡r
()

117 
nÙ
 
img_id
:

119 
exşuded_images
.
	$add
(
img_id
)

121 
şass_desütiÚ_fe
 = 
os
.
·th
.
	`još
(
¬gs
.
roÙ
, "class-descriptions-boxable.csv")

122 
nÙ
 
os
.
·th
.
	$exi¡s
(
şass_desütiÚ_fe
):

123 
u¾
 = "https://storage.googleapis.com/openimages/2018_04/class-descriptions-boxable.csv"

124 
loggšg
.
	`w¬nšg
(
f
"Download {url}.")

125 
	$h‰p_dowÆßd
(
u¾
, 
şass_desütiÚ_fe
)

127 
şass_desütiÚs
 = 
pd
.
	`»ad_csv
(
şass_desütiÚ_fe
,

128 
Çmes
=["id", "ClassName"])

129 
şass_desütiÚs
 = cÏss_desütiÚs[şass_desütiÚs['CÏssName'].
	`isš
(
şass_Çmes
)]

131 
image_fes
 = []

132 
d©a£t_ty³
 
š
 ["train", "validation", "test"]:

133 
image_dœ
 = 
os
.
·th
.
	$još
(
¬gs
.
roÙ
, 
d©a£t_ty³
)

134 
os
.
	$makedœs
(
image_dœ
, 
exi¡_ok
=
True
)

136 
ªnÙ©iÚ_fe
 = 
f
"{args.root}/{dataset_type}-annotations-bbox.csv"

137 
nÙ
 
os
.
·th
.
	$exi¡s
(
ªnÙ©iÚ_fe
):

138 
u¾
 = 
f
"https://storage.googleapis.com/openimages/2018_04/{dataset_type}/{dataset_type}-annotations-bbox.csv"

139 
loggšg
.
	`w¬nšg
(
f
"Download {url}.")

140 
	$h‰p_dowÆßd
(
u¾
, 
ªnÙ©iÚ_fe
)

141 
loggšg
.
	`w¬nšg
(
f
"Read‡nnotation file {annotation_file}")

142 
ªnÙ©iÚs
 = 
pd
.
	$»ad_csv
(
ªnÙ©iÚ_fe
)

143 
ªnÙ©iÚs
 = 
pd
.
	`m”ge
×ÂÙ©iÚs, 
şass_desütiÚs
,

144 
Ëá_Ú
="Lab–Name", 
right_Ú
="id",

145 
how
="inner")

146 
nÙ
 
¬gs
.
šşude_d•iùiÚ
:

147 
ªnÙ©iÚs
 =‡ÂÙ©iÚs.
loc
[annotations['IsDepiction'] != 1, :]

149 
f‹»d
 = []

150 
şass_Çme
, 
group_f‹r
, 
³rûÁage
 
š
 
	$z
(
şass_Çmes
, 
group_f‹rs
, 
³rûÁages
):

151 
sub
 = 
ªnÙ©iÚs
.
loc
[ªnÙ©iÚs['CÏssName'] =ğ
şass_Çme
, :]

152 
exşuded_images
 |ğ
	`£t
(
sub
['ImageID'].
	`§m¶e
(
äac
=1 - 
³rûÁage
))

154 
group_f‹r
 == '~group':

155 
exşuded_images
 |ğ
	`£t
(
sub
.
loc
[sub['IsGroupOf'] == 1, 'ImageID'])

156 
–if
 
group_f‹r
 == 'group':

157 
exşuded_images
 |ğ
	`£t
(
sub
.
loc
[sub['IsGroupOf'] == 0, 'ImageID'])

158 
f‹»d
.
	$­³nd
(
sub
)

160 
ªnÙ©iÚs
 = 
pd
.
	$cÚÿt
(
f‹»d
)

161 
ªnÙ©iÚs
 =‡ÂÙ©iÚs.
loc
[~ªnÙ©iÚs['ImageID'].
	`isš
(
exşuded_images
), :]

164 
¬gs
.
»move_ov”Ïµed
:

165 
images_w™h_group
 = 
ªnÙ©iÚs
.
loc
[annotations['IsGroupOf'] == 1, 'ImageID']

166 
ªnÙ©iÚs
 =‡ÂÙ©iÚs.
loc
[~×ÂÙ©iÚs['ImageID'].
	`isš
(
	`£t
(
images_w™h_group
)) & (annotations['IsGroupOf'] == 0)), :]

167 
ªnÙ©iÚs
 =‡ÂÙ©iÚs.
	$§m¶e
(
äac
=1.0)

169 
loggšg
.
	`w¬nšg
(
f
"{dataset_type} bounding boxes size: {annotations.shape[0]}")

170 
loggšg
.
	`w¬nšg
("Approximate Image Stats: ")

171 
	`log_couÁs
(
ªnÙ©iÚs
.
	`drİ_du¶iÿ‹s
(["ImageID", "ClassName"])["ClassName"])

172 
loggšg
.
	`w¬nšg
("Label distribution: ")

173 
	`log_couÁs
(
ªnÙ©iÚs
['ClassName'])

175 
loggšg
.
	`w¬nšg
(
f
"Shuffle dataset.")

178 
sub_ªnÙ©iÚ_fe
 = 
f
"{args.root}/sub-{dataset_type}-annotations-bbox.csv"

179 
loggšg
.
	`w¬nšg
(
f
"Save {dataset_type} datao {sub_annotation_file}.")

180 
ªnÙ©iÚs
.
	$to_csv
(
sub_ªnÙ©iÚ_fe
, 
šdex
=
F®£
)

181 
image_fes
.
	`ex‹nd
(
f
"{d©a£t_ty³}/{id}.jpg" 
id
 
š
 
	`£t
(
ªnÙ©iÚs
['ImageID']))

182 
loggšg
.
	`w¬nšg
(
f
"Start downloading {len(image_files)} images.")

183 
	$b©ch_dowÆßd
(
buck‘
, 
image_fes
, 
¬gs
.
roÙ
,‡rgs.
num_wÜk”s
,‡rgs.
»Œy
)

184 
loggšg
.
	`w¬nšg
("Task Done.")

	@prune_alexnet.py

1 
impÜt
 
tÜch


2 
impÜt
 
	gtÜch
.
Â
 
as
‚n

3 
impÜt
 
	gtÜch
.
İtim
 
as
 optim

4 
äom
 
	gtÜch
.
İtim
 
impÜt
 
Ì_scheduËr


5 
äom
 
tÜchvisiÚ
 
impÜt
 
	gd©a£ts
, 
ŒªsfÜms


6 
impÜt
 
¬g·r£


7 
impÜt
 
loggšg


8 
impÜt
 
sys


9 
äom
 
‹nsÜbßrdX
 
impÜt
 
Summ¬yWr™”


11 
äom
 
	gvisiÚ
.
	g´uÂšg
.
´uÂ”
 
impÜt
 
Mod–PruÂ”


12 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
¡r2boŞ


13 
äom
 
	gvisiÚ
.
	gÂ
.
®exÃt
 
impÜt
‡lexnet

16 
	g·r£r
 = 
¬g·r£
.
Argum’tP¬£r
(
desütiÚ
='Demonstration of Pruning AlexNet')

18 
·r£r
.
add_¬gum’t
("--Œaš", 
de¡
="Œaš", 
aùiÚ
="store_true")

19 
·r£r
.
add_¬gum’t
("--´uÃ_cÚv", 
de¡
="´uÃ_cÚv", 
aùiÚ
="store_true")

20 
·r£r
.
add_¬gum’t
("--´uÃ_lš—r", 
de¡
="´uÃ_lš—r", 
aùiÚ
="store_true")

21 
·r£r
.
add_¬gum’t
("--Œašed_mod–", 
ty³
=
¡r
)

22 
·r£r
.
add_¬gum’t
('--d©a£t', 
ty³
=
¡r
, 
h–p
='Dataset directory…ath')

23 
·r£r
.
add_¬gum’t
('--v®id©iÚ_d©a£t', 
h–p
='Dataset directory…ath')

24 
·r£r
.
add_¬gum’t
('--b©ch_size', =12, 
ty³
=,

25 
h–p
='Batch size forraining')

26 
·r£r
.
add_¬gum’t
('--num_•ochs', =25, 
ty³
=,

27 
h–p
='number of batchesorain')

28 
·r£r
.
add_¬gum’t
('--num_»cov”y_b©ches', =2, 
ty³
=,

29 
h–p
='number of batchesoraino„ecoverhe‚etwork')

30 
·r£r
.
add_¬gum’t
('--»cov”y_Ë¬nšg_¿‹', =1e-4, 
ty³
=,

31 
h–p
='learning„ateo„ecoverhe‚etwork')

32 
·r£r
.
add_¬gum’t
('--»cov”y_b©ch_size', =32, 
ty³
=,

33 
h–p
='Batch size forraining')

35 #P¬am 
SGD


36 
·r£r
.
add_¬gum’t
('--Ë¬nšg_¿‹', =1e-3, 
ty³
=,

37 
h–p
='initial†earning„ate')

38 
·r£r
.
add_¬gum’t
('--mom’tum', =0.9, 
ty³
=,

39 
h–p
='Momentum value for optim')

40 
·r£r
.
add_¬gum’t
('--weight_deÿy', =5e-4, 
ty³
=,

41 
h–p
='Weight decay for SGD')

42 
·r£r
.
add_¬gum’t
('--gamma', =0.1, 
ty³
=,

43 
h–p
='Gamma update for SGD')

45 #P¬am 
Prunšg


46 
·r£r
.
add_¬gum’t
('--´uÃ_cÚv_num', =1, 
ty³
=,

47 
h–p
='the‚umber of conv filters you wanto…rune in very iteration.')

48 
·r£r
.
add_¬gum’t
('--´uÃ_lš—r_num', =2, 
ty³
=,

49 
h–p
='the‚umber of†inear filters you wanto…rune in very iteration.')

50 
·r£r
.
add_¬gum’t
('--wšdow', =10, 
ty³
=,

51 
h–p
='Window size forrackingraining‡ccuracy.')

53 
·r£r
.
add_¬gum’t
('--u£_cuda', =
True
, 
ty³
=
¡r2boŞ
,

54 
h–p
='Use CUDAorain model')

57 
¬gs
 = 
·r£r
.
	$·r£_¬gs
()

58 
DEVICE
 = 
tÜch
.
	`deviû
("cuda:0" tÜch.
cuda
.
	$is_avaabË
(è
ªd
 
¬gs
.
u£_cuda
 "cpu")

59 
ıu_deviû
 = 
tÜch
.
	`deviû
("cpu")

62 
¬gs
.
u£_cuda
 
ªd
 
tÜch
.
cuda
.
	$is_avaabË
():

63 
tÜch
.
back’ds
.
cudÂ
.
b’chm¬k
 = 
True


66 
def
 
	$Œaš_•och
(
Ãt
, 
d©a_™”
, 
num_•ochs
=1, 
İtimiz”
=
NÚe
):

67 
Ãt
 =‚‘.
	$to
(
DEVICE
)

68 
Ãt
.
	$Œaš
()

69 
ü™”iÚ
 = 
Â
.
	$CrossEÁrİyLoss
()

71 
num
 = 0

72 
i
 
š
 
	$¿nge
(
num_•ochs
):

73 
šputs
, 
Ïb–s
 = 
	$Ãxt
(
d©a_™”
)

74 
šputs
 = iÅuts.
	$to
(
DEVICE
)

75 
Ïb–s
 =†ab–s.
	$to
(
DEVICE
)

76 
İtimiz”
:

77 
İtimiz”
.
	$z”o_g¿d
()

79 
ouuts
 = 
	$Ãt
(
šputs
)

81 
_
, 
´eds
 = 
tÜch
.
	$max
(
ouuts
, 1)

82 
loss
 = 
	$ü™”iÚ
(
ouuts
, 
Ïb–s
)

83 
loss
.
	$backw¬d
()

84 
İtimiz”
:

85 
İtimiz”
.
	$¡•
()

86 
Œaš_loss
 = 
loss
.
	`™em
(è* 
šputs
.
	$size
(0)

87 
Œaš_accu¿cy
 = 
tÜch
.
	`sum
(
´eds
 =ğ
Ïb–s
.
d©a
).
	$™em
()

88 
num
 +ğ
šputs
.
	$size
(0)

89 
Œaš_loss
 /ğ
num


90 
Œaš_accu¿cy
 /ğ
num


91 
loggšg
.
	`šfo
('T¿š Epoch Loss:{:.4f}, Accu¿cy:{:.4f}'.
	$fÜm©
(
Œaš_loss
, 
Œaš_accu¿cy
))

92  
Œaš_loss
, 
Œaš_accu¿cy


95 
def
 
	$Œaš
(
Ãt
, 
Œaš_lßd”
, 
v®_lßd”
, 
num_•ochs
, 
Ë¬nšg_¿‹
, 
§ve_mod–
=
True
):

96 
Ãt
 =‚‘.
	$to
(
DEVICE
)

97 
Ãt
.
	$Œaš
()

98 
ü™”iÚ
 = 
Â
.
	$CrossEÁrİyLoss
()

99 
İtimiz”
 = 
İtim
.
	`SGD
(
Ãt
.
	`·¿m‘”s
(), 
Ì
=
Ë¬nšg_¿‹
,

100 
mom’tum
=
¬gs
.mom’tum, 
weight_deÿy
=args.weight_decay)

101 
exp_Ì_scheduËr
 = 
Ì_scheduËr
.
	$S‹pLR
(
İtimiz”
, 
¡•_size
=7, 
gamma
=0.1)

103 
i
 
š
 
	$¿nge
(
num_•ochs
):

104 
Ãt
.
	$Œaš
()

105 
exp_Ì_scheduËr
.
	$¡•
()

106 
num
 = 0

107 
ruÂšg_loss
 = 0.0

108 
ruÂšg_cÜ»ùs
 = 0.0

109 
šputs
, 
Ïb–s
 
š
 
Œaš_lßd”
:

110 
šputs
 = iÅuts.
	$to
(
DEVICE
)

111 
Ïb–s
 =†ab–s.
	$to
(
DEVICE
)

112 
İtimiz”
.
	$z”o_g¿d
()

113 
ouuts
 = 
	$Ãt
(
šputs
)

115 
_
, 
´eds
 = 
tÜch
.
	$max
(
ouuts
, 1)

116 
loss
 = 
	$ü™”iÚ
(
ouuts
, 
Ïb–s
)

117 
loss
.
	$backw¬d
()

118 
İtimiz”
.
	$¡•
()

119 
ruÂšg_loss
 +ğ
loss
.
	`™em
(è* 
šputs
.
	$size
(0)

120 
ruÂšg_cÜ»ùs
 +ğ
tÜch
.
	`sum
(
´eds
 =ğ
Ïb–s
.
d©a
).
	$™em
()

121 
num
 +ğ
šputs
.
	$size
(0)

123 
loggšg
.
	`šfo
('Epoch: {}, T¿ššg Loss:{:.4f}, T¿ššg Accu¿cy:{:.4f}'.
	`fÜm©
(
i
, 
ruÂšg_loss
/
num
, 
ruÂšg_cÜ»ùs
/num))

124 
v®_loss
, 
v®_accu¿cy
 = 
	$ev®
(
Ãt
, 
v®_lßd”
)

125 
loggšg
.
	`šfo
('Epoch: {}, V® Loss:{:.4f}, V® Accu¿cy:{:.4f}'.
	$fÜm©
(
i
, 
v®_loss
, 
v®_accu¿cy
))

126 
§ve_mod–
:

127 
tÜch
.
	`§ve
(
Ãt
.
	`¡©e_diù
(), "mod–s/ªt-®exÃt-•och-{}-{:.4f}.±h".
	$fÜm©
(
i
, 
v®_accu¿cy
))

128  
v®_loss
, 
v®_accu¿cy


131 
def
 
	$ev®
(
Ãt
, 
lßd”
):

132 
Ãt
.
	$ev®
()

133 
ü™”iÚ
 = 
Â
.
	$CrossEÁrİyLoss
()

134 
ruÂšg_loss
 = 0.0

135 
ruÂšg_cÜ»ùs
 = 0

136 
num
 = 0

137 
šputs
, 
Ïb–s
 
š
 
lßd”
:

138 
šputs
 = iÅuts.
	$to
(
DEVICE
)

139 
Ïb–s
 =†ab–s.
	$to
(
DEVICE
)

140 
w™h
 
tÜch
.
	$£t_g¿d_’abËd
(
F®£
):

141 
ouuts
 = 
	$Ãt
(
šputs
)

143 
_
, 
´eds
 = 
tÜch
.
	$max
(
ouuts
, 1)

144 
loss
 = 
	$ü™”iÚ
(
ouuts
, 
Ïb–s
)

145 
ruÂšg_loss
 +ğ
loss
.
	`™em
(è* 
šputs
.
	$size
(0)

146 
ruÂšg_cÜ»ùs
 +ğ
tÜch
.
	`sum
(
´eds
 =ğ
Ïb–s
.
d©a
).
	$™em
()

147 
num
 +ğ
šputs
.
	$size
(0)

148 
ruÂšg_loss
 /ğ
num


149 
ruÂšg_cÜ»ùs
 =„uÂšg_cÜ»ù / 
num


150  
ruÂšg_loss
, 
ruÂšg_cÜ»ùs


153 
def
 
	$make_´uÂ”_lßd”
(
d©a£t
):

154 
lßd”
 = 
tÜch
.
uts
.
d©a
.
	$D©aLßd”
(
d©a£t
, 
b©ch_size
=
¬gs
.
»cov”y_b©ch_size
, 
shufæe
=
True
, 
num_wÜk”s
=1)

155 
True
:

156 
šputs
, 
Ïb–s
 
š
 
lßd”
:

157 
y›ld
 
šputs
, 
Ïb–s


159 
__Çme__
 == '__main__':

160 
loggšg
.
	`basicCÚfig
(
¡»am
=
sys
.
¡dout
, 
Ëv–
öoggšg.
INFO
,

161 
fÜm©
='%(asctime)s - %(name)s - %(levelname)s - %(message)s')

163 
Ãt
 = 
	$®exÃt
(
True
)

164 
Ãt
.
şassif›r
 = 
Â
.
	`Sequ’tŸl
(

165 
Â
.
	`Drİout
(),

166 
Â
.
	`Lš—r
(256 * 6 * 6, 4096),

167 
Â
.
	`ReLU
(
š¶aû
=
True
),

168 
Â
.
	`Drİout
(),

169 
Â
.
	`Lš—r
(4096, 4096),

170 
Â
.
	`ReLU
(
š¶aû
=
True
),

171 
Â
.
	`Lš—r
(4096, 2),

174 
Œaš_ŒªsfÜm
 = 
ŒªsfÜms
.
	`Compo£
([

175 
ŒªsfÜms
.
	`RªdomResizedCrİ
(224),

176 
ŒªsfÜms
.
	`RªdomHÜizÚlFl
(),

177 
ŒªsfÜms
.
	`ToT’sÜ
(),

178 
ŒªsfÜms
.
	`NÜm®ize
([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])

181 
v®_ŒªsfÜm
 = 
ŒªsfÜms
.
	`Compo£
([

182 
ŒªsfÜms
.
	`Resize
(256),

183 
ŒªsfÜms
.
	`C’‹rCrİ
(224),

184 
ŒªsfÜms
.
	`ToT’sÜ
(),

185 
ŒªsfÜms
.
	`NÜm®ize
([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])

188 
Œaš_d©a£t
 = 
d©a£ts
.
	$ImageFŞd”
(
¬gs
.
d©a£t
, 
Œaš_ŒªsfÜm
)

189 
v®_d©a£t
 = 
d©a£ts
.
	$ImageFŞd”
(
¬gs
.
v®id©iÚ_d©a£t
, 
v®_ŒªsfÜm
)

190 
loggšg
.
	`šfo
(
f
"Training dataset size: {len(train_dataset)}.")

191 
loggšg
.
	`šfo
(
f
"Validation Dataset size: {len(val_dataset)}.")

193 
Œaš_lßd”
 = 
tÜch
.
uts
.
d©a
.
	$D©aLßd”
(
Œaš_d©a£t
, 
b©ch_size
=
¬gs
.b©ch_size, 
shufæe
=
True
, 
num_wÜk”s
=4)

194 
v®_lßd”
 = 
tÜch
.
uts
.
d©a
.
	`D©aLßd”
(
v®_d©a£t
, 
b©ch_size
=
	`Ën
(v®_d©a£t), 
shufæe
=
F®£
, 
num_wÜk”s
=1)

195 
wr™”
 = 
	$Summ¬yWr™”
()

196 
¬gs
.
Œaš
:

197 
loggšg
.
	`šfo
("Startraining.")

198 
	$Œaš
(
Ãt
, 
Œaš_lßd”
, 
v®_lßd”
, 
¬gs
.
num_•ochs
,‡rgs.
Ë¬nšg_¿‹
)

199 
–if
 
¬gs
.
´uÃ_cÚv
 
Ü
‡rgs.
´uÃ_lš—r
:

200 
Ãt
.
	`lßd_¡©e_diù
(
tÜch
.
	$lßd
(
¬gs
.
Œašed_mod–
))

201 
´uÂ”_d©a_™”
 = 
	`™”
(
	$make_´uÂ”_lßd”
(
Œaš_d©a£t
))

202 
´uÂ”
 = 
	`Mod–PruÂ”
(
Ãt
, 
Ïmbda
 
mod–
: 
	`Œaš_•och
(mod–, 
´uÂ”_d©a_™”
),

203 
ignÜed_·ths
=[('şassif›r', '6')]è#dØ
nÙ
 
´uÃ
 
the
 
Ï¡
 
Ïy”
.

204 
num_f‹rs
 = 
´uÂ”
.
book
.
	$num_of_cÚv2d_f‹rs
()

205 
loggšg
.
	`šfo
(
f
"Number of Conv2d filters: {num_filters}")

207 
num_lš—r_f‹rs
 = 
´uÂ”
.
book
.
	$num_of_lš—r_f‹rs
()

208 
loggšg
.
	`šfo
(
f
"Number of Linear filters: {num_linear_filters}")

209 
¬gs
.
´uÃ_cÚv
:

210 
´uÃ_num
 = 
´uÂ”
.
book
.
	`num_of_cÚv2d_f‹rs
(è- 5 * (´uÂ”.book.
	$num_of_cÚv2d_moduËs
())

212 
´uÃ_num
 = 
´uÂ”
.
book
.
	`num_of_lš—r_f‹rs
(è- 5 * (´uÂ”.book.
	$num_of_lš—r_moduËs
())

213 
loggšg
.
	`šfo
(
f
"Number of Layerso Prune: {prune_num}")

214 
i
 = 0

215 
™”©iÚ
 = 0

216 
Œaš_d©a_™”
 = 
	`™”
(
	$make_´uÂ”_lßd”
(
Œaš_d©a£t
))

217 
İtimiz”
 = 
İtim
.
	`SGD
(
Ãt
.
	`·¿m‘”s
(), 
Ì
=
¬gs
.
»cov”y_Ë¬nšg_¿‹
,

218 
mom’tum
=
¬gs
.mom’tum, 
weight_deÿy
=args.weight_decay)

219 
i
 < 
´uÃ_num
:

220 
¬gs
.
´uÃ_cÚv
:

221 
´uÂ”
.
	$´uÃ_cÚv_Ïy”s
(
¬gs
.
´uÃ_cÚv_num
)

222 
i
 +ğ
¬gs
.
´uÃ_cÚv_num


224 
_
, 
accu¿cy_gaš
 = 
´uÂ”
.
	$´uÃ_lš—r_Ïy”s
(
¬gs
.
´uÃ_lš—r_num
)

225 
i
 +ğ
¬gs
.
´uÃ_lš—r_num


226 
™”©iÚ
 % 10 == 0:

227 
v®_loss
, 
v®_accu¿cy
 = 
	$ev®
(
´uÂ”
.
mod–
, 
v®_lßd”
)

228 
loggšg
.
	`šfo
(
f
"Prune: {i}/{prune_num}, After Pruning Evaluation Accuracy:{val_accuracy:.4f}.")

229 
v®_loss
, 
v®_accu¿cy
 = 
	$Œaš_•och
(
´uÂ”
.
mod–
, 
Œaš_d©a_™”
, 
¬gs
.
num_»cov”y_b©ches
, 
İtimiz”
)

230 
Çme
, 
·¿m
 
š
 
Ãt
.
	$Çmed_·¿m‘”s
():

231 
wr™”
.
	`add_hi¡og¿m
(
Çme
, 
·¿m
.
	`şÚe
().
	`ıu
().
d©a
.
	`numpy
(), 10)

232 
™”©iÚ
 % 10 == 0:

233 
dummy_šput
 = 
tÜch
.
	$¿nd
(1, 3, 224, 224)

234 
wr™”
.
	$add_g¿ph
(
Ãt
, 
dummy_šput
)

235 
v®_loss
, 
v®_accu¿cy
 = 
	$ev®
(
´uÂ”
.
mod–
, 
v®_lßd”
)

236 
loggšg
.
	`šfo
(
f
"Prune: {i}/{prune_num}, After Recovery Evaluation Accuracy:{val_accuracy:.4f}.")

237 
loggšg
.
	`šfo
(
f
"Prune: {i}/{prune_num}, Iteration: {iteration}, Save model.")

238 
w™h
 
	`İ’
(
f
"mod–s/®exÃt-´uÃd-{i}.txt", "w"è
as
 f:

239 
	$´št
(
´uÂ”
.
mod–
, 
fe
=
f
)

240 
tÜch
.
	`§ve
(
´uÂ”
.
mod–
.
	`¡©e_diù
(), 
f
"models/prunned-alexnet-{i}-{prune_num}-{val_accuracy:.4f}.pth")

241 
™”©iÚ
 += 1

243 
loggšg
.
	`çl
("You should specify --prune_conv, --prune_linear or --train.")

245 
wr™”
.
	`şo£
()

	@run_ssd_example.py

1 
äom
 
	gvisiÚ
.
	gssd
.
vgg_ssd
 
impÜt
 
	gü—‹_vgg_ssd
, 
ü—‹_vgg_ssd_´ediùÜ


2 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd
 
impÜt
 
	gü—‹_mob’‘v1_ssd
, 
ü—‹_mob’‘v1_ssd_´ediùÜ


3 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v1_ssd_l™e
, 
ü—‹_mob’‘v1_ssd_l™e_´ediùÜ


4 
äom
 
	gvisiÚ
.
	gssd
.
squ“z’‘_ssd_l™e
 
impÜt
 
	gü—‹_squ“z’‘_ssd_l™e
, 
ü—‹_squ“z’‘_ssd_l™e_´ediùÜ


5 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘_v2_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v2_ssd_l™e
, 
ü—‹_mob’‘v2_ssd_l™e_´ediùÜ


6 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
Tim”


7 
impÜt
 
cv2


8 
impÜt
 
sys


11 
Ën
(
sys
.
¬gv
) < 6:

12 
´št
('Usage:…ython„un_ssd_example.py <netype> <model…ath> <image…ath>')

13 
sys
.
	$ex™
(0)

14 
Ãt_ty³
 = 
sys
.
¬gv
[1]

15 
mod–_·th
 = 
sys
.
¬gv
[2]

16 
Ïb–_·th
 = 
sys
.
¬gv
[3]

17 
image_·th
 = 
sys
.
¬gv
[4]

18 
deviû
 = 
sys
.
¬gv
[5]

19 
deviû
 =ğ"" 
Ü
 deviû =ğ
NÚe
:

20 
deviû
 = "cpu"

23 
şass_Çmes
 = [
Çme
.
	$¡r
(è
Çme
 
š
 
	`İ’
(
Ïb–_·th
).
	`»adlšes
()]

25 
Ãt_ty³
 == 'vgg16-ssd':

26 
Ãt
 = 
	`ü—‹_vgg_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

27 
–if
 
Ãt_ty³
 == 'mb1-ssd':

28 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

29 
–if
 
Ãt_ty³
 == 'mb1-ssd-lite':

30 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

31 
–if
 
Ãt_ty³
 == 'mb2-ssd-lite':

32 
Ãt
 = 
	`ü—‹_mob’‘v2_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

33 
–if
 
Ãt_ty³
 == 'sq-ssd-lite':

34 
Ãt
 = 
	`ü—‹_squ“z’‘_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

36 
	`´št
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

37 
sys
.
	$ex™
(1)

38 
Ãt
.
	$lßd
(
mod–_·th
)

40 
Ãt_ty³
 == 'vgg16-ssd':

41 
´ediùÜ
 = 
	$ü—‹_vgg_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

42 
–if
 
Ãt_ty³
 == 'mb1-ssd':

43 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

44 
–if
 
Ãt_ty³
 == 'mb1-ssd-lite':

45 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

46 
–if
 
Ãt_ty³
 == 'mb2-ssd-lite':

47 
´ediùÜ
 = 
	$ü—‹_mob’‘v2_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

48 
–if
 
Ãt_ty³
 == 'sq-ssd-lite':

49 
´ediùÜ
 = 
	$ü—‹_squ“z’‘_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

51 
´ediùÜ
 = 
	$ü—‹_vgg_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
deviû
=device)

53 
Üig_image
 = 
cv2
.
	$im»ad
(
image_·th
)

54 
image
 = 
cv2
.
	$cvtCŞÜ
(
Üig_image
, 
cv2
.
COLOR_BGR2RGB
)

55 
boxes
, 
Ïb–s
, 
´obs
 = 
´ediùÜ
.
	$´ediù
(
image
, 10, 0.4)

57 
i
 
š
 
	`¿nge
(
boxes
.
	$size
(0)):

58 
box
 = 
boxes
[
i
, :]

59 
cv2
.
	`»ùªgË
(
Üig_image
, (
box
[0], box[1]), (box[2], box[3]), (255, 255, 0), 4)

60 #Ïb– = 
f
"""{voc_dataset.class_names[labels[i]]}: {probs[i]:.2f}"""

61 
Ïb–
 = 
f
"{class_names[labels[i]]}: {probs[i]:.2f}"

62 
cv2
.
	`putText
(
Üig_image
, 
Ïb–
,

63 (
box
[0] + 20, box[1] + 40),

64 
cv2
.
FONT_HERSHEY_SIMPLEX
,

65 1, #fÚˆ
sÿË


67 2è#lš
ty³


68 
·th
 = "run_ssd_example_output.jpg"

69 
cv2
.
	$imwr™e
(
·th
, 
Üig_image
)

70 
	`´št
(
f
"Found {len(probs)} objects. The output image is {path}")

	@run_ssd_live_caffe2.py

1 
impÜt
 
	gvisiÚ
.
	guts
.
box_uts_numpy
 
as
 
box_uts


2 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
Tim”


3 
äom
 
	gvisiÚ
.
	gssd
.
	gcÚfig
.
mob’‘v1_ssd_cÚfig
 
impÜt
 
	g¥ecs
, 
	gûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû


6 
impÜt
 
cv2


7 
impÜt
 
sys


8 
äom
 
	gÿfã2
.
pythÚ
 
impÜt
 
	gcÜe
, 
	gwÜk¥aû
, 
Ãt_´š‹r


9 
impÜt
 
numpy
 
as
 
Å


11 
	g´iÜs
 = 
box_uts
.
	$g’”©e_ssd_´iÜs
(
¥ecs
, 300)

12 
	`´št
('´iÜs.sh­e', 
´iÜs
.
sh­e
)

15 
def
 
	$lßd_mod–
(
š™_Ãt_·th
, 
´ediù_Ãt_·th
):

16 
w™h
 
	`İ’
(
š™_Ãt_·th
, "rb"è
as
 
f
:

17 
š™_Ãt
 = 
f
.
	$»ad
()

18 
w™h
 
	`İ’
(
´ediù_Ãt_·th
, "rb"è
as
 
f
:

19 
´ediù_Ãt
 = 
f
.
	$»ad
()

20 
p
 = 
wÜk¥aû
.
	$P»diùÜ
(
š™_Ãt
, 
´ediù_Ãt
)

21  
p


24 
def
 
	`´ediù
(
width
, 
height
, 
cÚfid’ûs
, 
boxes
, 
´ob_th»shŞd
, 
iou_th»shŞd
=0.5, 
tİ_k
=-1):

25 
boxes
 = boxes[0]

26 
cÚfid’ûs
 = confidences[0]

27 
picked_box_´obs
 = []

28 
picked_Ïb–s
 = []

29 
şass_šdex
 
š
 
	$¿nge
(1, 
cÚfid’ûs
.
sh­e
[1]):

30 
´obs
 = 
cÚfid’ûs
[:, 
şass_šdex
]

31 
mask
 = 
´obs
 > 
´ob_th»shŞd


32 
´obs
 =…robs[
mask
]

33 
´obs
.
sh­e
[0] == 0:

35 
sub£t_boxes
 = 
boxes
[
mask
, :]

36 
box_´obs
 = 
Å
.
	`cÚÿ‹Ç‹
([
sub£t_boxes
, 
´obs
.
	`»sh­e
(-1, 1)], 
axis
=1)

37 
box_´obs
 = 
box_uts
.
	$h¬d_nms
(
box_´obs
,

38 
iou_th»shŞd
=iou_threshold,

39 
tİ_k
=top_k,

41 
picked_box_´obs
.
	$­³nd
(
box_´obs
)

42 
picked_Ïb–s
.
	$ex‹nd
([
şass_šdex
] * 
box_´obs
.
sh­e
[0])

43 
nÙ
 
picked_box_´obs
:

44  
Å
.
	`¬¿y
([]),‚p.¬¿y([]),‚p.
	$¬¿y
([])

45 
picked_box_´obs
 = 
Å
.
	$cÚÿ‹Ç‹
(
picked_box_´obs
)

46 
picked_box_´obs
[:, 0] *ğ
width


47 
picked_box_´obs
[:, 1] *ğ
height


48 
picked_box_´obs
[:, 2] *ğ
width


49 
picked_box_´obs
[:, 3] *ğ
height


50  
picked_box_´obs
[:, :4].
	`a¡y³
(
Å
.
št32
),‚p.
	`¬¿y
(
picked_Ïb–s
),…icked_box_probs[:, 4]

53 
	`Ën
(
sys
.
¬gv
) < 2:

54 
	`´št
('Usage:…ython„un_ssd_live_caffe2.py init_net…redict_net')

55 
sys
.
	$ex™
(0)

56 
š™_Ãt_·th
 = 
sys
.
¬gv
[1]

57 
´ediù_Ãt_·th
 = 
sys
.
¬gv
[2]

58 
Ïb–_·th
 = 
sys
.
¬gv
[3]

60 
şass_Çmes
 = [
Çme
.
	$¡r
(è
Çme
 
š
 
	`İ’
(
Ïb–_·th
).
	`»adlšes
()]

61 
´ediùÜ
 = 
	$lßd_mod–
(
š™_Ãt_·th
, 
´ediù_Ãt_·th
)

63 
	`Ën
(
sys
.
¬gv
) >= 5:

64 
ÿp
 = 
cv2
.
	$VideoC­tu»
(
sys
.
¬gv
[4]è#ÿ±u» 
äom
 
fe


66 
ÿp
 = 
cv2
.
	$VideoC­tu»
(0è#ÿ±u» 
äom
 
ÿm”a


67 
ÿp
.
	$£t
(3, 1920)

68 
ÿp
.
	$£t
(4, 1080)

70 
tim”
 = 
	$Tim”
()

71 
True
:

72 
»t
, 
Üig_image
 = 
ÿp
.
	$»ad
()

73 
Üig_image
 
is
 
NÚe
:

75 
image
 = 
cv2
.
	$cvtCŞÜ
(
Üig_image
, 
cv2
.
COLOR_BGR2RGB
)

76 
image
 = 
cv2
.
	`»size
(image, (300, 300))

77 
image
 = image.
	$a¡y³
(
Å
.
æßt32
)

78 
image
 = (image - 127) / 128

79 
image
 = 
Å
.
	$Œª¥o£
(
image
, [2, 0, 1])

80 
image
 = 
Å
.
	$ex·nd_dims
(
image
, 
axis
=0)

81 
tim”
.
	$¡¬t
()

82 
cÚfid’ûs
, 
boxes
 = 
´ediùÜ
.
	`run
({'0': 
image
})

83 
š‹rv®
 = 
tim”
.
	$’d
()

84 
	`´št
('Inã»nû Time: {:.2f}s.'.
	$fÜm©
(
š‹rv®
))

85 
tim”
.
	$¡¬t
()

86 
boxes
, 
Ïb–s
, 
´obs
 = 
	$´ediù
(
Üig_image
.
sh­e
[1], orig_image.sh­e[0], 
cÚfid’ûs
, 
boxes
, 0.55)

87 
š‹rv®
 = 
tim”
.
	$’d
()

88 
	`´št
('NMS Time: {:.2f}s, D‘eù Objeùs: {:d}.'.
	$fÜm©
(
š‹rv®
, 
Ïb–s
.
sh­e
[0]))

89 
i
 
š
 
	$¿nge
(
boxes
.
sh­e
[0]):

90 
box
 = 
boxes
[
i
, :]

91 
Ïb–
 = 
f
"{class_names[labels[i]]}: {probs[i]:.2f}"

93 
cv2
.
	`»ùªgË
(
Üig_image
, (
box
[0], box[1]), (box[2], box[3]), (255, 255, 0), 4)

95 
cv2
.
	`putText
(
Üig_image
, 
Ïb–
,

96 (
box
[0]+20, box[1]+40),

97 
cv2
.
FONT_HERSHEY_SIMPLEX
,

98 1, #fÚˆ
sÿË


100 2è#lš
ty³


101 
cv2
.
	`imshow
('ªnÙ©ed', 
Üig_image
)

102 
cv2
.
	`wa™Key
(1è& 0xFF =ğ
	`Üd
('q'):

104 
ÿp
.
	$»Ëa£
()

105 
cv2
.
	`de¡royAÎWšdows
()

	@run_ssd_live_demo.py

1 
äom
 
	gvisiÚ
.
	gssd
.
vgg_ssd
 
impÜt
 
	gü—‹_vgg_ssd
, 
ü—‹_vgg_ssd_´ediùÜ


2 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd
 
impÜt
 
	gü—‹_mob’‘v1_ssd
, 
ü—‹_mob’‘v1_ssd_´ediùÜ


3 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v1_ssd_l™e
, 
ü—‹_mob’‘v1_ssd_l™e_´ediùÜ


4 
äom
 
	gvisiÚ
.
	gssd
.
squ“z’‘_ssd_l™e
 
impÜt
 
	gü—‹_squ“z’‘_ssd_l™e
, 
ü—‹_squ“z’‘_ssd_l™e_´ediùÜ


5 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘_v2_ssd_l™e
 
impÜt
 
	gü—‹_mob’‘v2_ssd_l™e
, 
ü—‹_mob’‘v2_ssd_l™e_´ediùÜ


6 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
Tim”


7 
impÜt
 
cv2


8 
impÜt
 
sys


10 
Ën
(
sys
.
¬gv
) < 4:

11 
´št
('Usage:…ython„un_ssd_example.py <netype> <model…ath> <label…ath> [video file]')

12 
sys
.
	$ex™
(0)

13 
Ãt_ty³
 = 
sys
.
¬gv
[1]

14 
mod–_·th
 = 
sys
.
¬gv
[2]

15 
Ïb–_·th
 = 
sys
.
¬gv
[3]

17 
	`Ën
(
sys
.
¬gv
) >= 5:

18 
ÿp
 = 
cv2
.
	$VideoC­tu»
(
sys
.
¬gv
[4]è#ÿ±u» 
äom
 
fe


20 
ÿp
 = 
cv2
.
	$VideoC­tu»
(0è#ÿ±u» 
äom
 
ÿm”a


21 
ÿp
.
	$£t
(3, 1920)

22 
ÿp
.
	$£t
(4, 1080)

24 
şass_Çmes
 = [
Çme
.
	$¡r
(è
Çme
 
š
 
	`İ’
(
Ïb–_·th
).
	`»adlšes
()]

25 
num_şas£s
 = 
	$Ën
(
şass_Çmes
)

28 
Ãt_ty³
 == 'vgg16-ssd':

29 
Ãt
 = 
	`ü—‹_vgg_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

30 
–if
 
Ãt_ty³
 == 'mb1-ssd':

31 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

32 
–if
 
Ãt_ty³
 == 'mb1-ssd-lite':

33 
Ãt
 = 
	`ü—‹_mob’‘v1_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

34 
–if
 
Ãt_ty³
 == 'mb2-ssd-lite':

35 
Ãt
 = 
	`ü—‹_mob’‘v2_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

36 
–if
 
Ãt_ty³
 == 'sq-ssd-lite':

37 
Ãt
 = 
	`ü—‹_squ“z’‘_ssd_l™e
(
	`Ën
(
şass_Çmes
), 
is_‹¡
=
True
)

39 
	`´št
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

40 
sys
.
	$ex™
(1)

41 
Ãt
.
	$lßd
(
mod–_·th
)

43 
Ãt_ty³
 == 'vgg16-ssd':

44 
´ediùÜ
 = 
	$ü—‹_vgg_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200)

45 
–if
 
Ãt_ty³
 == 'mb1-ssd':

46 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200)

47 
–if
 
Ãt_ty³
 == 'mb1-ssd-lite':

48 
´ediùÜ
 = 
	$ü—‹_mob’‘v1_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200)

49 
–if
 
Ãt_ty³
 == 'mb2-ssd-lite':

50 
´ediùÜ
 = 
	$ü—‹_mob’‘v2_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200)

51 
–if
 
Ãt_ty³
 == 'sq-ssd-lite':

52 
´ediùÜ
 = 
	$ü—‹_squ“z’‘_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200)

54 
	`´št
("The‚etype is wrong. It should be one of vgg16-ssd, mb1-ssd‡nd mb1-ssd-lite.")

55 
sys
.
	$ex™
(1)

58 
tim”
 = 
	$Tim”
()

59 
True
:

60 
»t
, 
Üig_image
 = 
ÿp
.
	$»ad
()

61 
Üig_image
 
is
 
NÚe
:

63 
image
 = 
cv2
.
	$cvtCŞÜ
(
Üig_image
, 
cv2
.
COLOR_BGR2RGB
)

64 
tim”
.
	$¡¬t
()

65 
boxes
, 
Ïb–s
, 
´obs
 = 
´ediùÜ
.
	$´ediù
(
image
, 10, 0.4)

66 
š‹rv®
 = 
tim”
.
	$’d
()

67 
	`´št
('Time: {:.2f}s, D‘eù Objeùs: {:d}.'.
	`fÜm©
(
š‹rv®
, 
Ïb–s
.
	$size
(0)))

68 
i
 
š
 
	`¿nge
(
boxes
.
	$size
(0)):

69 
box
 = 
boxes
[
i
, :]

70 
Ïb–
 = 
f
"{class_names[labels[i]]}: {probs[i]:.2f}"

71 
cv2
.
	`»ùªgË
(
Üig_image
, (
box
[0], box[1]), (box[2], box[3]), (255, 255, 0), 4)

73 
cv2
.
	`putText
(
Üig_image
, 
Ïb–
,

74 (
box
[0]+20, box[1]+40),

75 
cv2
.
FONT_HERSHEY_SIMPLEX
,

76 1, #fÚˆ
sÿË


78 2è#lš
ty³


79 
cv2
.
	`imshow
('ªnÙ©ed', 
Üig_image
)

80 
cv2
.
	`wa™Key
(1è& 0xFF =ğ
	`Üd
('q'):

82 
ÿp
.
	$»Ëa£
()

83 
cv2
.
	`de¡royAÎWšdows
()

	@train_ssd.py

1 
impÜt
 
¬g·r£


2 
impÜt
 
os


3 
impÜt
 
loggšg


4 
impÜt
 
sys


5 
impÜt
 
™”toŞs


7 
impÜt
 
tÜch


8 
äom
 
	gtÜch
.
	guts
.
d©a
 
impÜt
 
	gD©aLßd”
, 
CÚÿtD©a£t


9 
äom
 
	gtÜch
.
	gİtim
.
Ì_scheduËr
 
impÜt
 
	gCosšeAÂ—lšgLR
, 
MuÉiS‹pLR


11 
äom
 
	gvisiÚ
.
	guts
.
misc
 
impÜt
 
	g¡r2boŞ
, 
	gTim”
, 
	gä“ze_Ãt_Ïy”s
, 
¡Üe_Ïb–s


12 
äom
 
	gvisiÚ
.
	gssd
.
ssd
 
impÜt
 
M©chPriÜ


13 
äom
 
	gvisiÚ
.
	gssd
.
vgg_ssd
 
impÜt
 
ü—‹_vgg_ssd


14 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd
 
impÜt
 
ü—‹_mob’‘v1_ssd


15 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘v1_ssd_l™e
 
impÜt
 
ü—‹_mob’‘v1_ssd_l™e


16 
äom
 
	gvisiÚ
.
	gssd
.
mob’‘_v2_ssd_l™e
 
impÜt
 
ü—‹_mob’‘v2_ssd_l™e


17 
äom
 
	gvisiÚ
.
	gssd
.
squ“z’‘_ssd_l™e
 
impÜt
 
ü—‹_squ“z’‘_ssd_l™e


18 
äom
 
	gvisiÚ
.
	gd©a£ts
.
voc_d©a£t
 
impÜt
 
VOCD©a£t


19 
äom
 
	gvisiÚ
.
	gd©a£ts
.
İ’_images
 
impÜt
 
O³nImagesD©a£t


20 
äom
 
	gvisiÚ
.
	gd©a£ts
.
how_çr_am_i
 
impÜt
 
HowF¬AmID©a£t


21 
äom
 
	gvisiÚ
.
	gÂ
.
muÉibox_loss
 
impÜt
 
MuÉiboxLoss


22 
äom
 
	gvisiÚ
.
	gssd
.
cÚfig
 
impÜt
 
vgg_ssd_cÚfig


23 
äom
 
	gvisiÚ
.
	gssd
.
cÚfig
 
impÜt
 
mob’‘v1_ssd_cÚfig


24 
äom
 
	gvisiÚ
.
	gssd
.
cÚfig
 
impÜt
 
squ“z’‘_ssd_cÚfig


25 
äom
 
	gvisiÚ
.
	gssd
.
d©a_´•roûssšg
 
impÜt
 
	gT¿šAugm’tiÚ
, 
Te¡T¿nsfÜm


27 
	g·r£r
 = 
¬g·r£
.
Argum’tP¬£r
(

28 
desütiÚ
='Single Shot MultiBox Detector Training With Pytorch')

30 
·r£r
.
add_¬gum’t
("--d©a£t_ty³", ="voc", 
ty³
=
¡r
,

31 
h–p
='Specify datasetype. Currently support voc‡nd open_images.')

33 
·r£r
.
add_¬gum’t
('--d©a£ts', 
Çrgs
='+', 
h–p
='Dataset directory…ath')

34 
·r£r
.
add_¬gum’t
('--v®id©iÚ_d©a£t', 
h–p
='Dataset directory…ath')

35 
·r£r
.
add_¬gum’t
('--b®ªû_d©a', 
aùiÚ
='store_true',

36 
h–p
="Balanceraining data by down-sampling more frequent†abels.")

39 
·r£r
.
add_¬gum’t
('--net', ="vgg16-ssd",

40 
h–p
="The‚etwork‡rchitecture, it can be mb1-ssd, mb1-lite-ssd, mb2-ssd-lite or vgg16-ssd.")

41 
·r£r
.
add_¬gum’t
('--ä“ze_ba£_Ãt', 
aùiÚ
='store_true',

42 
h–p
="Freeze base‚et†ayers.")

43 
·r£r
.
add_¬gum’t
('--ä“ze_Ãt', 
aùiÚ
='store_true',

44 
h–p
="Freeze‡llhe†ayersƒxcepthe…rediction head.")

46 
·r£r
.
add_¬gum’t
('--mb2_width_muÉ', =1.0, 
ty³
=,

47 
h–p
='Width Multiplifier for MobilenetV2')

49 #P¬am 
SGD


50 
·r£r
.
add_¬gum’t
('--Ì', '--Ë¬nšg-¿‹', =1e-3, 
ty³
=,

51 
h–p
='initial†earning„ate')

52 
·r£r
.
add_¬gum’t
('--mom’tum', =0.9, 
ty³
=,

53 
h–p
='Momentum value for optim')

54 
·r£r
.
add_¬gum’t
('--weight_deÿy', =5e-4, 
ty³
=,

55 
h–p
='Weight decay for SGD')

56 
·r£r
.
add_¬gum’t
('--gamma', =0.1, 
ty³
=,

57 
h–p
='Gamma update for SGD')

58 
·r£r
.
add_¬gum’t
('--ba£_Ãt_Ì', =
NÚe
, 
ty³
=,

59 
h–p
='initial†earning„ate for base‚et.')

60 
·r£r
.
add_¬gum’t
('--exŒa_Ïy”s_Ì', =
NÚe
, 
ty³
=,

61 
h–p
='initial†earning„ate forhe†ayers‚ot in base‚et‡nd…rediction heads.')

64 #P¬am 
lßdšg
 
´‘¿šed
 
ba£Ãt
 
Ü
 
checkpošts
.

65 
·r£r
.
add_¬gum’t
('--base_net',

66 
h–p
='Pretrained base model')

67 
·r£r
.
add_¬gum’t
('--´‘¿šed_ssd', 
h–p
='Pre-trained base model')

68 
·r£r
.
add_¬gum’t
('--»sume', =
NÚe
, 
ty³
=
¡r
,

69 
h–p
='Checkpoint state_dict fileo„esumeraining from')

72 
·r£r
.
add_¬gum’t
('--scheduËr', ="muÉi-¡•", 
ty³
=
¡r
,

73 
h–p
="Scheduler for SGD. It can one of multi-step‡nd cosine")

75 #P¬am 
MuÉi
-
¡•
 
ScheduËr


76 
·r£r
.
add_¬gum’t
('--me¡Úes', ="80,100", 
ty³
=
¡r
,

77 
h–p
="milestones for MultiStepLR")

79 #P¬am 
Cosše
 
AÂ—lšg


80 
·r£r
.
add_¬gum’t
('--t_max', =120, 
ty³
=,

81 
h–p
='T_max value for Cosine Annealing Scheduler.')

83 #T¿š 
·¿ms


84 
·r£r
.
add_¬gum’t
('--b©ch_size', =32, 
ty³
=,

85 
h–p
='Batch size forraining')

86 
·r£r
.
add_¬gum’t
('--num_•ochs', =120, 
ty³
=,

87 
h–p
='the‚umberƒpochs')

88 
·r£r
.
add_¬gum’t
('--num_wÜk”s', =4, 
ty³
=,

89 
h–p
='Number of workers used in dataloading')

90 
·r£r
.
add_¬gum’t
('--v®id©iÚ_•ochs', =5, 
ty³
=,

91 
h–p
='the‚umberƒpochs')

92 
·r£r
.
add_¬gum’t
('--debug_¡•s', =100, 
ty³
=,

93 
h–p
='Sethe debug†og output frequency.')

94 
·r£r
.
add_¬gum’t
('--u£_cuda', =
True
, 
ty³
=
¡r2boŞ
,

95 
h–p
='Use CUDAorain model')

97 
·r£r
.
add_¬gum’t
('--checkpoint_folder', ='models/',

98 
h–p
='Directory for saving checkpoint models')

101 
loggšg
.
basicCÚfig
(
¡»am
=
sys
.
¡dout
, 
Ëv–
öoggšg.
INFO
,

102 
fÜm©
='%(asctime)s - %(name)s - %(levelname)s - %(message)s')

103 
¬gs
 = 
·r£r
.
	$·r£_¬gs
()

104 
DEVICE
 = 
tÜch
.
	`deviû
("cuda:0" tÜch.
cuda
.
	$is_avaabË
(è
ªd
 
¬gs
.
u£_cuda
 "cpu")

106 
¬gs
.
u£_cuda
 
ªd
 
tÜch
.
cuda
.
	$is_avaabË
():

107 
tÜch
.
back’ds
.
cudÂ
.
b’chm¬k
 = 
True


108 
loggšg
.
	`šfo
("Use Cuda.")

111 
def
 
	`Œaš
(
lßd”
, 
Ãt
, 
ü™”iÚ
, 
İtimiz”
, 
deviû
, 
debug_¡•s
=100, 
•och
=-1):

112 
Ãt
.
	$Œaš
(
True
)

113 
ruÂšg_loss
 = 0.0

114 
ruÂšg_»g»ssiÚ_loss
 = 0.0

115 
ruÂšg_şassifiÿtiÚ_loss
 = 0.0

116 #DISTANCE 
CHANGE


117 
ruÂšg_di¡_»g_loss
 = 0.0

118 
i
, 
d©a
 
š
 
	$’um”©e
(
lßd”
):

119 #DISTANCE 
CHANGE


120 
images
, 
boxes
, 
Ïb–s
, 
gt_di¡
 = 
d©a


121 
images
 = images.
	$to
(
deviû
)

122 
boxes
 = boxes.
	$to
(
deviû
)

123 
Ïb–s
 =†ab–s.
	$to
(
deviû
)

124 #DISTANCE 
CHANGE


125 
gt_di¡
 = gt_di¡.
	$to
(
deviû
)

127 
İtimiz”
.
	$z”o_g¿d
()

128 #DISTANCE 
CHANGE


129 
cÚfid’û
, 
loÿtiÚs
, 
´ed_di¡
 = 
	$Ãt
(
images
)

130 #DISTANCE 
CHANGE


131 
»g»ssiÚ_loss
, 
şassifiÿtiÚ_loss
, 
di¡_»g_loss
 = 
	$ü™”iÚ
(
cÚfid’û
, 
loÿtiÚs
, 
´ed_di¡
, 
Ïb–s
, 
boxes
, 
gt_di¡
è#TODO 
CHANGE
 
BOXES


132 #DISTANCE 
CHANGE


133 
loss
 = 
»g»ssiÚ_loss
 + 
şassifiÿtiÚ_loss
 + 
di¡_»g_loss


134 
loss
.
	$backw¬d
()

135 
İtimiz”
.
	$¡•
()

137 
ruÂšg_loss
 +ğ
loss
.
	$™em
()

138 
ruÂšg_»g»ssiÚ_loss
 +ğ
»g»ssiÚ_loss
.
	$™em
()

139 
ruÂšg_şassifiÿtiÚ_loss
 +ğ
şassifiÿtiÚ_loss
.
	$™em
()

140 #DISTANCE 
CHANGE


141 
ruÂšg_di¡_»g_loss
 +ğ
dis_»g_loss
.
	$™em
()

142 
i
 
ªd
 i % 
debug_¡•s
 == 0:

143 
avg_loss
 = 
ruÂšg_loss
 / 
debug_¡•s


144 
avg_»g_loss
 = 
ruÂšg_»g»ssiÚ_loss
 / 
debug_¡•s


145 
avg_şf_loss
 = 
ruÂšg_şassifiÿtiÚ_loss
 / 
debug_¡•s


146 #DISTANCE 
CHANGE


147 
avg_di¡_»g_loss
 = 
ruÂšg_di¡_»g_loss
 / 
debug_¡•s


148 #DISTANCE 
CHANGE


149 
loggšg
.
	`šfo
(

150 
f
"Epoch: {epoch}, Step: {i}, " +

151 
f
"Average Loss: {avg_loss:.4f}, " +

152 
f
"Average Regression Loss {avg_reg_loss:.4f}, " +

153 
f
"Average Classification Loss: {avg_clf_loss:.4f}" +

154 
f
"Average Distance Regression Loss: {avg_dist_reg_loss:.4f}"

156 
ruÂšg_loss
 = 0.0

157 
ruÂšg_»g»ssiÚ_loss
 = 0.0

158 
ruÂšg_şassifiÿtiÚ_loss
 = 0.0

159 #DISTANCE 
CHANGE


160 
ruÂšg_di¡_»g_loss
 = 0.0

163 
def
 
	$‹¡
(
lßd”
, 
Ãt
, 
ü™”iÚ
, 
deviû
):

164 
Ãt
.
	$ev®
()

165 
ruÂšg_loss
 = 0.0

166 
ruÂšg_»g»ssiÚ_loss
 = 0.0

167 
ruÂšg_şassifiÿtiÚ_loss
 = 0.0

168 #DISTANCE 
CHANGE


169 
ruÂšg_di¡_»g_loss
 = 0.0

170 
num
 = 0

171 
_
, 
d©a
 
š
 
	$’um”©e
(
lßd”
):

172 #DISTANCE 
CHANGE


173 
images
, 
boxes
, 
Ïb–s
, 
gt_di¡
 = 
d©a


174 
images
 = images.
	$to
(
deviû
)

175 
boxes
 = boxes.
	$to
(
deviû
)

176 
Ïb–s
 =†ab–s.
	$to
(
deviû
)

177 #DISTANCE 
CHANGE


178 
gt_di¡
 = gt_di¡.
	$to
(
deviû
)

179 
num
 += 1

181 
w™h
 
tÜch
.
	$no_g¿d
():

182 #DISTANCE 
CHANGE


183 
cÚfid’û
, 
loÿtiÚs
, 
´ed_di¡
 = 
	$Ãt
(
images
)

184 
»g»ssiÚ_loss
, 
şassifiÿtiÚ_loss
, 
di¡_»g_loss
 = 
	$ü™”iÚ
(
cÚfid’û
, 
loÿtiÚs
, 
´ed_di¡
, 
Ïb–s
, 
boxes
, 
gt_di¡
)

185 
loss
 = 
»g»ssiÚ_loss
 + 
şassifiÿtiÚ_loss
 + 
di¡_»g_loss


187 
ruÂšg_loss
 +ğ
loss
.
	$™em
()

188 
ruÂšg_»g»ssiÚ_loss
 +ğ
»g»ssiÚ_loss
.
	$™em
()

189 
ruÂšg_şassifiÿtiÚ_loss
 +ğ
şassifiÿtiÚ_loss
.
	$™em
()

190 #DISTANCE 
CHANGE


191 
ruÂšg_di¡_»g_loss
 +ğ
di¡_»g_loss
.
	$™em
()

192  
ruÂšg_loss
 / 
num
, 
ruÂšg_»g»ssiÚ_loss
 /‚um, 
ruÂšg_şassifiÿtiÚ_loss
 /‚um, 
ruÂšg_di¡_»g_loss
 /‚um

195 
__Çme__
 == '__main__':

196 
tim”
 = 
	$Tim”
()

198 
loggšg
.
	$šfo
(
¬gs
)

199 
¬gs
.
Ãt
 == 'vgg16-ssd':

200 
ü—‹_Ãt
 = 
ü—‹_vgg_ssd


201 
cÚfig
 = 
vgg_ssd_cÚfig


202 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd':

203 
ü—‹_Ãt
 = 
ü—‹_mob’‘v1_ssd


204 
cÚfig
 = 
mob’‘v1_ssd_cÚfig


205 
–if
 
¬gs
.
Ãt
 == 'mb1-ssd-lite':

206 
ü—‹_Ãt
 = 
ü—‹_mob’‘v1_ssd_l™e


207 
cÚfig
 = 
mob’‘v1_ssd_cÚfig


208 
–if
 
¬gs
.
Ãt
 == 'sq-ssd-lite':

209 
ü—‹_Ãt
 = 
ü—‹_squ“z’‘_ssd_l™e


210 
cÚfig
 = 
squ“z’‘_ssd_cÚfig


211 
–if
 
¬gs
.
Ãt
 == 'mb2-ssd-lite':

212 
ü—‹_Ãt
 = 
Ïmbda
 
num
: 
	$ü—‹_mob’‘v2_ssd_l™e
(
num
, 
width_muÉ
=
¬gs
.
mb2_width_muÉ
)

213 
cÚfig
 = 
mob’‘v1_ssd_cÚfig


215 
loggšg
.
	`çl
("The‚etype is wrong.")

216 
·r£r
.
	$´št_h–p
(
sys
.
¡d”r
)

217 
sys
.
	$ex™
(1)

218 
Œaš_ŒªsfÜm
 = 
	$T¿šAugm’tiÚ
(
cÚfig
.
image_size
, cÚfig.
image_m—n
, cÚfig.
image_¡d
)

219 
rg‘_ŒªsfÜm
 = 
	$M©chPriÜ
(
cÚfig
.
´iÜs
, cÚfig.
ûÁ”_v¬Ÿnû
,

220 
cÚfig
.
size_v¬Ÿnû
, 0.5)

222 
‹¡_ŒªsfÜm
 = 
	$Te¡T¿nsfÜm
(
cÚfig
.
image_size
, cÚfig.
image_m—n
, cÚfig.
image_¡d
)

224 
loggšg
.
	`šfo
("Prepareraining datasets.")

225 
d©a£ts
 = []

226 
d©a£t_·th
 
š
 
¬gs
.
d©a£ts
:

227 
¬gs
.
d©a£t_ty³
 == 'voc':

228 
d©a£t
 = 
	$VOCD©a£t
(
d©a£t_·th
, 
ŒªsfÜm
=
Œaš_ŒªsfÜm
,

229 
rg‘_ŒªsfÜm
=target_transform)

230 
Ïb–_fe
 = 
os
.
·th
.
	`još
(
¬gs
.
checkpošt_fŞd”
, "voc-model-labels.txt")

231 
	$¡Üe_Ïb–s
(
Ïb–_fe
, 
d©a£t
.
şass_Çmes
)

232 
num_şas£s
 = 
	$Ën
(
d©a£t
.
şass_Çmes
)

233 
–if
 
¬gs
.
d©a£t_ty³
 == 'open_images':

234 
d©a£t
 = 
	`O³nImagesD©a£t
(
d©a£t_·th
,

235 
ŒªsfÜm
=
Œaš_ŒªsfÜm
, 
rg‘_ŒªsfÜm
=target_transform,

236 
d©a£t_ty³
="Œaš", 
b®ªû_d©a
=
¬gs
.balance_data)

237 
Ïb–_fe
 = 
os
.
·th
.
	`još
(
¬gs
.
checkpošt_fŞd”
, "open-images-model-labels.txt")

238 
	$¡Üe_Ïb–s
(
Ïb–_fe
, 
d©a£t
.
şass_Çmes
)

239 
loggšg
.
	$šfo
(
d©a£t
)

240 
num_şas£s
 = 
	$Ën
(
d©a£t
.
şass_Çmes
)

241 #DISTANCE 
CHANGE


242 
–if
 
¬gs
.
d©a£t_ty³
 =='how_far_am_i':

243 
d©a£t
 = 
	`HowF¬AmID©a£t
(
d©a£t_·th
,

244 
ŒªsfÜm
=
Œaš_ŒªsfÜm
, 
rg‘_ŒªsfÜm
=target_transform,

245 
d©a£t_ty³
="train")

246 
Ïb–_fe
 = 
os
.
·th
.
	`još
(
¬gs
.
checkpošt_fŞd”
, "howfarami-model-labels.txt")

247 
	$¡Üe_Ïb–s
(
Ïb–_fe
, 
d©a£t
.
şass_Çmes
)

248 
num_şas£s
 = 
	$Ën
(
d©a£t
.
şass_Çmes
)

251 
¿i£
 
	`V®ueE¼Ü
(
f
"Datasetpye {args.dataset_type} is‚ot supported.")

252 
d©a£ts
.
	$­³nd
(
d©a£t
)

253 
loggšg
.
	`šfo
(
f
"Stored†abels into file {label_file}.")

254 
Œaš_d©a£t
 = 
	$CÚÿtD©a£t
(
d©a£ts
)

255 
loggšg
.
	`šfo
("T¿š d©a£ˆsize: {}".
	`fÜm©
(
	$Ën
(
Œaš_d©a£t
)))

256 
Œaš_lßd”
 = 
	$D©aLßd”
(
Œaš_d©a£t
, 
¬gs
.
b©ch_size
,

257 
num_wÜk”s
=
¬gs
.num_workers,

258 
shufæe
=
True
)

259 
loggšg
.
	`šfo
("Prepare Validation datasets.")

260 
¬gs
.
d©a£t_ty³
 == "voc":

261 
v®_d©a£t
 = 
	$VOCD©a£t
(
¬gs
.
v®id©iÚ_d©a£t
, 
ŒªsfÜm
=
‹¡_ŒªsfÜm
,

262 
rg‘_ŒªsfÜm
ñ¬g‘_ŒªsfÜm, 
is_‹¡
=
True
)

263 
–if
 
¬gs
.
d©a£t_ty³
 == 'open_images':

264 
v®_d©a£t
 = 
	`O³nImagesD©a£t
(
d©a£t_·th
,

265 
ŒªsfÜm
=
‹¡_ŒªsfÜm
, 
rg‘_ŒªsfÜm
=target_transform,

266 
d©a£t_ty³
="test")

267 
loggšg
.
	$šfo
(
v®_d©a£t
)

268 #DISTANCE 
CHANGE


269 
–if
 
¬gs
.
d©a£t_ty³
 == 'how_far_am_i':

270 
v®_d©a£t
 = 
	`HowF¬AmID©a£t
(
d©a£t_·th
,

271 
ŒªsfÜm
=
‹¡_ŒªsfÜm
, 
rg‘_ŒªsfÜm
=target_transform,

272 
d©a£t_ty³
="test")

274 
¿i£
 
	`V®ueE¼Ü
(
f
"Datasetpye {args.dataset_type} is‚ot supported.")

276 
loggšg
.
	`šfo
("v®id©iÚ d©a£ˆsize: {}".
	`fÜm©
(
	$Ën
(
v®_d©a£t
)))

278 
v®_lßd”
 = 
	$D©aLßd”
(
v®_d©a£t
, 
¬gs
.
b©ch_size
,

279 
num_wÜk”s
=
¬gs
.num_workers,

280 
shufæe
=
F®£
)

281 
loggšg
.
	`šfo
("Build‚etwork.")

282 
Ãt
 = 
	$ü—‹_Ãt
(
num_şas£s
)

283 
mš_loss
 = -10000.0

284 
Ï¡_•och
 = -1

286 
ba£_Ãt_Ì
 = 
¬gs
.ba£_Ãt_Ì ¬gs.ba£_Ãt_Ì 
is
 
nÙ
 
NÚe
 ¬gs.
Ì


287 
exŒa_Ïy”s_Ì
 = 
¬gs
.exŒa_Ïy”s_Ì ¬gs.exŒa_Ïy”s_Ì 
is
 
nÙ
 
NÚe
 ¬gs.
Ì


288 
¬gs
.
ä“ze_ba£_Ãt
:

289 
loggšg
.
	`šfo
("Freeze base‚et.")

290 
	$ä“ze_Ãt_Ïy”s
(
Ãt
.
ba£_Ãt
)

291 
·¿ms
 = 
™”toŞs
.
	`chaš
(
Ãt
.
sourû_Ïy”_add_Ús
.
	`·¿m‘”s
(),‚‘.
exŒas
.parameters(),

292 
Ãt
.
»g»ssiÚ_h—d”s
.
	`·¿m‘”s
(),‚‘.
şassifiÿtiÚ_h—d”s
.
	$·¿m‘”s
())

293 
·¿ms
 = [

294 {'·¿ms': 
™”toŞs
.
	`chaš
(

295 
Ãt
.
sourû_Ïy”_add_Ús
.
	`·¿m‘”s
(),

296 
Ãt
.
exŒas
.
	`·¿m‘”s
()

297 ), 'Ì': 
exŒa_Ïy”s_Ì
},

298 {'·¿ms': 
™”toŞs
.
chaš
(

299 
Ãt
.
»g»ssiÚ_h—d”s
.
·¿m‘”s
(),

300 
Ãt
.
şassifiÿtiÚ_h—d”s
.
·¿m‘”s
()

303 
–if
 
	g¬gs
.
	gä“ze_Ãt
:

304 
	$ä“ze_Ãt_Ïy”s
(
Ãt
.
ba£_Ãt
)

305 
	$ä“ze_Ãt_Ïy”s
(
Ãt
.
sourû_Ïy”_add_Ús
)

306 
	$ä“ze_Ãt_Ïy”s
(
Ãt
.
exŒas
)

307 
·¿ms
 = 
™”toŞs
.
	`chaš
(
Ãt
.
»g»ssiÚ_h—d”s
.
	`·¿m‘”s
(),‚‘.
şassifiÿtiÚ_h—d”s
.
	$·¿m‘”s
())

308 
loggšg
.
	`šfo
("Freeze‡llhe†ayersƒxcept…rediction heads.")

310 
·¿ms
 = [

311 {'·¿ms': 
Ãt
.
ba£_Ãt
.
	`·¿m‘”s
(), 'Ì': 
ba£_Ãt_Ì
},

312 {'·¿ms': 
™”toŞs
.
chaš
(

313 
Ãt
.
sourû_Ïy”_add_Ús
.
·¿m‘”s
(),

314 
Ãt
.
exŒas
.
·¿m‘”s
()

315 ), 'Ì': 
exŒa_Ïy”s_Ì
},

316 {'·¿ms': 
™”toŞs
.
chaš
(

317 
Ãt
.
»g»ssiÚ_h—d”s
.
·¿m‘”s
(),

318 
Ãt
.
şassifiÿtiÚ_h—d”s
.
·¿m‘”s
()

322 
	gtim”
.
¡¬t
("Load Model")

323 
	g¬gs
.
	g»sume
:

324 
loggšg
.
šfo
(
f
"Resume fromhe model {args.resume}")

325 
Ãt
.
	$lßd
(
¬gs
.
»sume
)

326 
–if
 
¬gs
.
ba£_Ãt
:

327 
loggšg
.
	`šfo
(
f
"Init from base‚et {args.base_net}")

328 
Ãt
.
	$š™_äom_ba£_Ãt
(
¬gs
.
ba£_Ãt
)

329 
–if
 
¬gs
.
´‘¿šed_ssd
:

330 
loggšg
.
	`šfo
(
f
"Init from…retrained ssd {args.pretrained_ssd}")

331 
Ãt
.
	$š™_äom_´‘¿šed_ssd
(
¬gs
.
´‘¿šed_ssd
)

332 
loggšg
.
	`šfo
(
f
'Took {timer.end("Load Model"):.2f} secondso†oadhe model.')

334 
Ãt
.
	$to
(
DEVICE
)

336 
ü™”iÚ
 = 
	$MuÉiboxLoss
(
cÚfig
.
´iÜs
, 
iou_th»shŞd
=0.5, 
Ãg_pos_¿tio
=3,

337 
ûÁ”_v¬Ÿnû
=0.1, 
size_v¬Ÿnû
=0.2, 
deviû
=
DEVICE
)

338 
İtimiz”
 = 
tÜch
.
İtim
.
	$SGD
(
·¿ms
, 
Ì
=
¬gs
.Ì, 
mom’tum
=args.momentum,

339 
weight_deÿy
=
¬gs
.weight_decay)

340 
loggšg
.
	`šfo
(
f
"Learning„ate: {args.lr}, Base‚et†earning„ate: {base_net_lr}, "

341 + 
f
"Extra Layers†earning„ate: {extra_layers_lr}.")

343 
¬gs
.
scheduËr
 == 'multi-step':

344 
loggšg
.
	`šfo
("Uses MultiStepLR scheduler.")

345 
me¡Úes
 = [(
v
.
	$¡r
()è
v
 
š
 
¬gs
.
me¡Úes
.
	`¥l™
(",")]

346 
scheduËr
 = 
	$MuÉiS‹pLR
(
İtimiz”
, 
me¡Úes
=milestones,

347 
gamma
=0.1, 
Ï¡_•och
=last_epoch)

348 
–if
 
¬gs
.
scheduËr
 == 'cosine':

349 
loggšg
.
	`šfo
("Uses CosineAnnealingLR scheduler.")

350 
scheduËr
 = 
	$CosšeAÂ—lšgLR
(
İtimiz”
, 
¬gs
.
t_max
, 
Ï¡_•och
=last_epoch)

352 
loggšg
.
	`çl
(
f
"Unsupported Scheduler: {args.scheduler}.")

353 
·r£r
.
	$´št_h–p
(
sys
.
¡d”r
)

354 
sys
.
	$ex™
(1)

356 
loggšg
.
	`šfo
(
f
"Startraining fromƒpoch {last_epoch + 1}.")

357 
•och
 
š
 
	`¿nge
(
Ï¡_•och
 + 1, 
¬gs
.
num_•ochs
):

358 
scheduËr
.
	$¡•
()

359 
	$Œaš
(
Œaš_lßd”
, 
Ãt
, 
ü™”iÚ
, 
İtimiz”
,

360 
deviû
=
DEVICE
, 
debug_¡•s
=
¬gs
.debug_¡•s, 
•och
=epoch)

362 
•och
 % 
¬gs
.
v®id©iÚ_•ochs
 =ğ0 
Ü
ƒpoch =ğ¬gs.
num_•ochs
 - 1:

363 #DISTANCE 
CHANGE


364 
v®_loss
, 
v®_»g»ssiÚ_loss
, 
v®_şassifiÿtiÚ_loss
, 
v®_di¡_»g_loss
 = 
	$‹¡
(
v®_lßd”
, 
Ãt
, 
ü™”iÚ
, 
DEVICE
)

365 
loggšg
.
	`šfo
(

366 
f
"Epoch: {epoch}, " +

367 
f
"Validation Loss: {val_loss:.4f}, " +

368 
f
"Validation Regression Loss {val_regression_loss:.4f}, " +

369 
f
"Validation Classification Loss: {val_classification_loss:.4f}"

370 #DISTANCE 
CHANGE


371 
f
"Validation Distance Reg Loss: {val_dist_reg_loss:.4f}"

373 
mod–_·th
 = 
os
.
·th
.
	`još
(
¬gs
.
checkpošt_fŞd”
, 
f
"{args.net}-Epoch-{epoch}-Loss-{val_loss}.pth")

374 
Ãt
.
	$§ve
(
mod–_·th
)

375 
loggšg
.
	`šfo
(
f
"Saved model {model_path}")

	@translate_tf_mobilenetv1.py

1 
impÜt
 
tÜch


2 
impÜt
 
sys


4 
äom
 
	gvisiÚ
.
	gÂ
.
mob’‘
 
impÜt
 
MobeN‘V1


5 
äom
 
exŒaù_tf_weights
 
impÜt
 
»ad_weights


8 
def
 
	$fl_weights_tÜch_mod–
(
weights
, 
¡©e_diù
):

9 
Çme
 
š
 
¡©e_diù
:

10 
Çme
 == 'classifier.weight':

11 
weight
 = 
weights
['MobilenetV1/Logits/Conv2d_1c_1x1/weights']

12 
weight
 = 
tÜch
.
	`‹nsÜ
(weight, 
dty³
ñÜch.
æßt32
).
	$³rmu‹
(3, 2, 0, 1)

13 
as£¹
 
¡©e_diù
[
Çme
].
	`size
(è=ğ
weight
.
	$size
()

14 
¡©e_diù
[
Çme
] = 
weight


15 
–if
 
Çme
 == 'classifier.bias':

16 
bŸs
 = 
weights
['MobilenetV1/Logits/Conv2d_1c_1x1/biases']

17 
bŸs
 = 
tÜch
.
	$‹nsÜ
(
bŸs
, 
dty³
=
tÜch
.
æßt32
)

18 
as£¹
 
¡©e_diù
[
Çme
].
	`size
(è=ğ
bŸs
.
	$size
()

19 
¡©e_diù
[
Çme
] = 
bŸs


20 
–if
 
Çme
.
	`’dsw™h
('BatchNorm.weight'):

21 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/").replace('BatchNorm/weight', 'BatchNorm/gamma')

22 
weight
 = 
tÜch
.
	$‹nsÜ
(
weights
[
key
], 
dty³
=
tÜch
.
æßt32
)

23 
as£¹
 
weight
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

24 
¡©e_diù
[
Çme
] = 
weight


25 
–if
 
Çme
.
	`’dsw™h
('BatchNorm.bias'):

26 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/").replace('BatchNorm/bias', 'BatchNorm/beta')

27 
bŸs
 = 
tÜch
.
	$‹nsÜ
(
weights
[
key
], 
dty³
=
tÜch
.
æßt32
)

28 
as£¹
 
bŸs
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

29 
¡©e_diù
[
Çme
] = 
bŸs


30 
–if
 
Çme
.
	`’dsw™h
('running_mean'):

31 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/").replace('running_mean', 'moving_mean')

32 
ruÂšg_m—n
 = 
tÜch
.
	$‹nsÜ
(
weights
[
key
], 
dty³
=
tÜch
.
æßt32
)

33 
as£¹
 
ruÂšg_m—n
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

34 
¡©e_diù
[
Çme
] = 
ruÂšg_m—n


35 
–if
 
Çme
.
	`’dsw™h
('running_var'):

36 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/").replace('running_var', 'moving_variance')

37 
ruÂšg_v¬
 = 
tÜch
.
	$‹nsÜ
(
weights
[
key
], 
dty³
=
tÜch
.
æßt32
)

38 
as£¹
 
ruÂšg_v¬
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

39 
¡©e_diù
[
Çme
] = 
ruÂšg_v¬


40 
–if
 
Çme
.
	`’dsw™h
('depthwise.weight'):

41 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/")

42 
key
 = key.
	`»¶aû
('depthwise/weight', 'depthwise/depthwise_weights')

43 
weight
 = 
tÜch
.
	`‹nsÜ
(
weights
[
key
], 
dty³
ñÜch.
æßt32
).
	$³rmu‹
(2, 3, 0, 1)

44 
as£¹
 
weight
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

45 
¡©e_diù
[
Çme
] = 
weight


47 
key
 = 
Çme
.
	`»¶aû
("features", "MobilenetV1").replace(".", "/").replace('weight', 'weights')

48 
weight
 = 
tÜch
.
	`‹nsÜ
(
weights
[
key
], 
dty³
ñÜch.
æßt32
).
	$³rmu‹
(3, 2, 0, 1)

49 
as£¹
 
weight
.
	`size
(è=ğ
¡©e_diù
[
Çme
].
	$size
()

50 
¡©e_diù
[
Çme
] = 
weight


53 
__Çme__
 == '__main__':

54 
	`Ën
(
sys
.
¬gv
) < 3:

55 
	`´št
("Usage:…ythonranslate_tf_modelnetv1.py <tf_model.pb> <pytorch_weights.pth>")

56 
tf_mod–
 = 
sys
.
¬gv
[1]

57 
tÜch_weights_·th
 = 
sys
.
¬gv
[2]

58 
	`´št
("Extract weights fromf model.")

59 
weights
 = 
	$»ad_weights
(
tf_mod–
)

61 
Ãt
 = 
	$MobeN‘V1
(1001)

62 
¡©es
 = 
Ãt
.
	$¡©e_diù
()

63 
	`´št
("Translatef weights.")

64 
	$fl_weights_tÜch_mod–
(
weights
, 
¡©es
)

65 
tÜch
.
	`§ve
(
¡©es
, 
tÜch_weights_·th
)

	@vision/__init__.py

	@vision/datasets/__init__.py

	@vision/datasets/collation.py

1 
impÜt
 
tÜch


2 
impÜt
 
numpy
 
as
 
Å


5 
def
 
	$objeù_d‘eùiÚ_cŞÏ‹
(
b©ch
):

6 
images
 = []

7 
gt_boxes
 = []

8 
gt_Ïb–s
 = []

9 
image_ty³
 = 
	$ty³
(
b©ch
[0][0])

10 
box_ty³
 = 
	$ty³
(
b©ch
[0][1])

11 
Ïb–_ty³
 = 
	$ty³
(
b©ch
[0][2])

12 
image
, 
boxes
, 
Ïb–s
 
š
 
b©ch
:

13 
image_ty³
 
is
 
Å
.
nd¬¿y
:

14 
images
.
	`­³nd
(
tÜch
.
	$äom_numpy
(
image
))

15 
–if
 
image_ty³
 
is
 
tÜch
.
T’sÜ
:

16 
images
.
	$­³nd
(
image
)

18 
¿i£
 
	`Ty³E¼Ü
(
f
"Image should beensor or‚p.ndarray, but got {image_type}.")

19 
box_ty³
 
is
 
Å
.
nd¬¿y
:

20 
gt_boxes
.
	`­³nd
(
tÜch
.
	$äom_numpy
(
boxes
))

21 
–if
 
box_ty³
 
is
 
tÜch
.
T’sÜ
:

22 
gt_boxes
.
	$­³nd
(
boxes
)

24 
¿i£
 
	`Ty³E¼Ü
(
f
"Boxes should beensor or‚p.ndarray, but got {box_type}.")

25 
Ïb–_ty³
 
is
 
Å
.
nd¬¿y
:

26 
gt_Ïb–s
.
	`­³nd
(
tÜch
.
	$äom_numpy
(
Ïb–s
))

27 
–if
 
Ïb–_ty³
 
is
 
tÜch
.
T’sÜ
:

28 
gt_Ïb–s
.
	$­³nd
(
Ïb–s
)

30 
¿i£
 
	`Ty³E¼Ü
(
f
"Labels should beensor or‚p.ndarray, but got {label_type}.")

31  
tÜch
.
	`¡ack
(
images
), 
gt_boxes
, gt_labels

	@vision/datasets/how_far_am_i.py

1 
impÜt
 
numpy
 
as
 
Å


2 
impÜt
 
·thlib


3 
impÜt
 
cv2


4 
impÜt
 
jsÚ


7 
şass
 
	gHowF¬AmID©a£t
:

9 
def
 
__š™__
(
£lf
, 
roÙ
,

10 
ŒªsfÜm
=
NÚe
, 
rg‘_ŒªsfÜm
=None,

11 
d©a£t_ty³
="train"):

12 
£lf
.
roÙ
 = 
·thlib
.
	$P©h
(
roÙ
)

13 
£lf
.
ŒªsfÜm
 =ransform

14 
£lf
.
rg‘_ŒªsfÜm
 =arget_transform

15 
£lf
.
d©a£t_ty³
 = d©a£t_ty³.
	$low”
()

16 
£lf
.
d©a
, s–f.
şass_Çmes
, s–f.
şass_diù
 = s–f.
	$_»ad_d©a
()

17 
£lf
.
ids
 = [
šfo
['image_id'] šfØ
š
 s–f.
d©a
]

20 
def
 
	$_g‘™em
(
£lf
, 
šdex
):

21 
image_šfo
 = 
£lf
.
d©a
[
šdex
]

22 
image
 = 
£lf
.
	`_»ad_image
(
image_šfo
['image_id'])

23 
boxes
 = 
Å
.
	`¬¿y
(
image_šfo
['boxes'], 
dty³
òp.
æßt32
)

24 
Ïb–s
 = 
Å
.
	`¬¿y
([
£lf
.
şass_diù
[
Ïb–
] Ïb– 
š
 
image_šfo
['Ïb–s']], 
dty³
òp.
št64
)

25 
di¡ªûs
 = 
Å
.
	`¬¿y
(
image_šfo
['di¡ªûs'], 
dty³
òp.
æßt32
)

26 
£lf
.
ŒªsfÜm
:

27 
image
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$ŒªsfÜm
(
image
, 
boxes
, 
Ïb–s
)

28 
£lf
.
rg‘_ŒªsfÜm
:

29 
boxes
, 
Ïb–s
, 
di¡ªûs
 = 
£lf
.
	$rg‘_ŒªsfÜm
(
boxes
, 
Ïb–s
, 
di¡ªûs
)

30  
image_šfo
['image_id'], 
image
, 
boxes
, 
Ïb–s
, 
di¡ªûs


32 
def
 
	$__g‘™em__
(
£lf
, 
šdex
):

33 
_
, 
image
, 
boxes
, 
Ïb–s
, 
di¡ªûs
 = 
£lf
.
	$_g‘™em
(
šdex
)

34  
image
, 
boxes
, 
Ïb–s
, 
di¡ªûs


36 
def
 
	$g‘_image
(
£lf
, 
šdex
):

37 
image_šfo
 = 
£lf
.
d©a
[
šdex
]

38 
image
 = 
£lf
.
	`_»ad_image
(
image_šfo
['image_id'])

39 
£lf
.
ŒªsfÜm
:

40 
image
, 
_
 = 
£lf
.
	$ŒªsfÜm
(
image
)

41  
image


43 
def
 
	$_»ad_d©a
(
£lf
):

44 
ªnÙ©iÚ_fe
 = 
f
"{self.root}/{self.dataset_type}_labels.json"

45 
şass_Çmes
 = ('BACKGROUND',

52 
şass_diù
 = {
şass_Çme
: 
i
 i, cÏss_Çm
š
 
	`’um”©e
(
şass_Çmes
)
	}
}

53 
w™h
 
İ’
(
ªnÙ©iÚ_fe
, 'r'è
as
 
	ga_fe
:

54 
d©a
 = 
jsÚ
.
	$lßd
(
a_fe
)

55  
d©a
, 
şass_Çmes
, 
şass_diù


57 
def
 
	$__Ën__
(
£lf
):

58  
	$Ën
(
£lf
.
d©a
)

60 
def
 
	$_»ad_image
(
£lf
, 
image_id
):

61 
image_fe
 = 
£lf
.
roÙ
 / s–f.
d©a£t_ty³
 / 
f
"{image_id}.jpg"

62 
image
 = 
cv2
.
	`im»ad
(
	$¡r
(
image_fe
))

63 
image
.
sh­e
[2] == 1:

64 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_GRAY2RGB
)

66 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_BGR2RGB
)

67  
image


	@vision/datasets/open_images.py

1 
impÜt
 
numpy
 
as
 
Å


2 
impÜt
 
·thlib


3 
impÜt
 
cv2


4 
impÜt
 
·ndas
 
as
 
pd


7 
şass
 
	gO³nImagesD©a£t
:

9 
def
 
__š™__
(
£lf
, 
roÙ
,

10 
ŒªsfÜm
=
NÚe
, 
rg‘_ŒªsfÜm
=None,

11 
d©a£t_ty³
="Œaš", 
b®ªû_d©a
=
F®£
):

12 
£lf
.
roÙ
 = 
·thlib
.
	$P©h
(
roÙ
)

13 
£lf
.
ŒªsfÜm
 =ransform

14 
£lf
.
rg‘_ŒªsfÜm
 =arget_transform

15 
£lf
.
d©a£t_ty³
 = d©a£t_ty³.
	$low”
()

17 
£lf
.
d©a
, s–f.
şass_Çmes
, s–f.
şass_diù
 = s–f.
	$_»ad_d©a
()

18 
£lf
.
b®ªû_d©a
 = balance_data

19 
£lf
.
mš_image_num
 = -1

20 
£lf
.
b®ªû_d©a
:

21 
£lf
.
d©a
 = s–f.
	$_b®ªû_d©a
()

22 
£lf
.
ids
 = [
šfo
['image_id'] šfØ
š
 s–f.
d©a
]

24 
£lf
.
şass_¡©
 = 
NÚe


26 
def
 
	$_g‘™em
(
£lf
, 
šdex
):

27 
image_šfo
 = 
£lf
.
d©a
[
šdex
]

28 
image
 = 
£lf
.
	`_»ad_image
(
image_šfo
['image_id'])

29 
boxes
 = 
image_šfo
['boxes']

30 
boxes
[:, 0] *ğ
image
.
sh­e
[1]

31 
boxes
[:, 1] *ğ
image
.
sh­e
[0]

32 
boxes
[:, 2] *ğ
image
.
sh­e
[1]

33 
boxes
[:, 3] *ğ
image
.
sh­e
[0]

34 
Ïb–s
 = 
image_šfo
['labels']

35 
£lf
.
ŒªsfÜm
:

36 
image
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$ŒªsfÜm
(
image
, 
boxes
, 
Ïb–s
)

37 
£lf
.
rg‘_ŒªsfÜm
:

38 
boxes
, 
Ïb–s
 = 
£lf
.
	$rg‘_ŒªsfÜm
(
boxes
, 
Ïb–s
)

39  
image_šfo
['image_id'], 
image
, 
boxes
, 
Ïb–s


41 
def
 
	$__g‘™em__
(
£lf
, 
šdex
):

42 
_
, 
image
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$_g‘™em
(
šdex
)

43  
image
, 
boxes
, 
Ïb–s


45 
def
 
	$g‘_ªnÙ©iÚ
(
£lf
, 
šdex
):

47 
image_id
, 
image
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$_g‘™em
(
šdex
)

48 
is_difficuÉ
 = 
Å
.
	$z”os
(
boxes
.
sh­e
[0], 
dty³
=
Å
.
ušt8
)

49  
image_id
, (
boxes
, 
Ïb–s
, 
is_difficuÉ
)

51 
def
 
	$g‘_image
(
£lf
, 
šdex
):

52 
image_šfo
 = 
£lf
.
d©a
[
šdex
]

53 
image
 = 
£lf
.
	`_»ad_image
(
image_šfo
['image_id'])

54 
£lf
.
ŒªsfÜm
:

55 
image
, 
_
 = 
£lf
.
	$ŒªsfÜm
(
image
)

56  
image


58 
def
 
	$_»ad_d©a
(
£lf
):

59 
ªnÙ©iÚ_fe
 = 
f
"{self.root}/sub-{self.dataset_type}-annotations-bbox.csv"

60 
ªnÙ©iÚs
 = 
pd
.
	$»ad_csv
(
ªnÙ©iÚ_fe
)

61 
şass_Çmes
 = ['BACKGROUND'] + 
	`sÜ‹d
(
	`li¡
(
ªnÙ©iÚs
['CÏssName'].
	$unique
()))

62 
şass_diù
 = {
şass_Çme
: 
i
 i, cÏss_Çm
š
 
	`’um”©e
(
şass_Çmes
)
	}
}

63 
d©a
 = []

64 
image_id
, 
group
 
š
 
	gªnÙ©iÚs
.
groupby
("ImageID"):

65 
boxes
 = 
group
.
loc
[:, ["XMš", "YMš", "XMax", "YMax"]].
	gv®ues
.
	$a¡y³
(
Å
.
æßt32
)

66 
Ïb–s
 = 
Å
.
	`¬¿y
([
şass_diù
[
Çme
] Çm
š
 
group
["ClassName"]])

67 
d©a
.
	`­³nd
({

68 'image_id': 
image_id
,

69 'boxes': 
boxes
,

70 'Ïb–s': 
Ïb–s


71 
	}
})

72  
d©a
, 
	gşass_Çmes
, 
şass_diù


74 
def
 
	$__Ën__
(
£lf
):

75  
	$Ën
(
£lf
.
d©a
)

77 
def
 
	$__»´__
(
£lf
):

78 
£lf
.
şass_¡©
 
is
 
NÚe
:

79 
£lf
.
şass_¡©
 = {
Çme
: 0 Çm
š
 s–f.
şass_Çmes
[1:]
	}
}

80 
exam¶e
 
š
 
£lf
.
d©a
:

81 
şass_šdex
 
š
 
exam¶e
['labels']:

82 
şass_Çme
 = 
£lf
.
şass_Çmes
[
şass_šdex
]

83 
£lf
.
şass_¡©
[
şass_Çme
] += 1

84 
cÚ‹Á
 = ["Dataset Summary:"

85 
f
"Number of Images: {len(self.data)}",

86 
f
"Minimum Number of Images for‡ Class: {self.min_image_num}",

88 
	gşass_Çme
, 
num
 
š
 
	g£lf
.
	gşass_¡©
.
	$™ems
():

89 
cÚ‹Á
.
	`­³nd
(
f
"\t{class_name}: {num}")

90  "\n".
	$još
(
cÚ‹Á
)

92 
def
 
	$_»ad_image
(
£lf
, 
image_id
):

93 
image_fe
 = 
£lf
.
roÙ
 / s–f.
d©a£t_ty³
 / 
f
"{image_id}.jpg"

94 
image
 = 
cv2
.
	`im»ad
(
	$¡r
(
image_fe
))

95 
image
.
sh­e
[2] == 1:

96 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_GRAY2RGB
)

98 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_BGR2RGB
)

99  
image


101 
def
 
	$_b®ªû_d©a
(
£lf
):

102 
Ïb–_image_šdexes
 = [
	$£t
(è
_
 
š
 
	`¿nge
(
	`Ën
(
£lf
.
şass_Çmes
))]

103 
i
, 
image
 
š
 
	$’um”©e
(
£lf
.
d©a
):

104 
Ïb–_id
 
š
 
image
['labels']:

105 
Ïb–_image_šdexes
[
Ïb–_id
].
	$add
(
i
)

106 
Ïb–_¡©
 = [
	$Ën
(
s
è 
š
 
Ïb–_image_šdexes
]

107 
£lf
.
mš_image_num
 = 
	$mš
(
Ïb–_¡©
[1:])

108 
§m¶e_image_šdexes
 = 
	$£t
()

109 
image_šdexes
 
š
 
Ïb–_image_šdexes
[1:]:

110 
image_šdexes
 = 
Å
.
	`¬¿y
(
	$li¡
(
image_šdexes
))

111 
sub
 = 
Å
.
¿ndom
.
	`³rmutiÚ
(
image_šdexes
)[:
£lf
.
mš_image_num
]

112 
§m¶e_image_šdexes
.
	$upd©e
(
sub
)

113 
§m¶e_d©a
 = [
£lf
.
d©a
[
i
] ˜
š
 
§m¶e_image_šdexes
]

114  
§m¶e_d©a


	@vision/datasets/voc_dataset.py

1 
impÜt
 
numpy
 
as
 
Å


2 
impÜt
 
·thlib


3 
impÜt
 
	gxml
.
	g‘»e
.
EËm’tT»e
 
as
 
ET


4 
impÜt
 
cv2


7 
şass
 
	gVOCD©a£t
:

9 
def
 
	$__š™__
(
£lf
, 
roÙ
, 
ŒªsfÜm
=
NÚe
, 
rg‘_ŒªsfÜm
=NÚe, 
is_‹¡
=
F®£
, 
k“p_difficuÉ
=False):

11 
Args
:

12 
roÙ
: 
the
„oÙ 
of
h
VOC2007
 
Ü
 
VOC2012
 
d©a£t
,h
dœeùÜy
 
cÚšs
h
fŞlowšg
 
sub
-
dœeùÜ›s
:

13 
AÂÙ©iÚs
, 
ImageS‘s
, 
JPEGImages
, 
Segm’tiÚCÏss
, 
Segm’tiÚObjeù
.

15 
£lf
.
roÙ
 = 
·thlib
.
	$P©h
(
roÙ
)

16 
£lf
.
ŒªsfÜm
 =ransform

17 
£lf
.
rg‘_ŒªsfÜm
 =arget_transform

18 
is_‹¡
:

19 
image_£ts_fe
 = 
£lf
.
roÙ
 / "ImageSets/Main/test.txt"

21 
image_£ts_fe
 = 
£lf
.
roÙ
 / "ImageSets/Main/trainval.txt"

22 
£lf
.
ids
 = 
VOCD©a£t
.
	$_»ad_image_ids
(
image_£ts_fe
)

23 
£lf
.
k“p_difficuÉ
 = keep_difficult

25 
£lf
.
şass_Çmes
 = ('BACKGROUND',

32 
£lf
.
şass_diù
 = {
şass_Çme
: 
i
 i, cÏss_Çm
š
 
	`’um”©e
(£lf.
şass_Çmes
)
	}
}

34 
def
 
	$__g‘™em__
(
£lf
, 
šdex
):

35 
image_id
 = 
£lf
.
ids
[
šdex
]

36 
boxes
, 
Ïb–s
, 
is_difficuÉ
 = 
£lf
.
	$_g‘_ªnÙ©iÚ
(
image_id
)

37 
nÙ
 
£lf
.
k“p_difficuÉ
:

38 
boxes
 = boxes[
is_difficuÉ
 == 0]

39 
Ïb–s
 =†ab–s[
is_difficuÉ
 == 0]

40 
image
 = 
£lf
.
	$_»ad_image
(
image_id
)

41 
£lf
.
ŒªsfÜm
:

42 
image
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$ŒªsfÜm
(
image
, 
boxes
, 
Ïb–s
)

43 
£lf
.
rg‘_ŒªsfÜm
:

44 
boxes
, 
Ïb–s
 = 
£lf
.
	$rg‘_ŒªsfÜm
(
boxes
, 
Ïb–s
)

45  
image
, 
boxes
, 
Ïb–s


47 
def
 
	$g‘_image
(
£lf
, 
šdex
):

48 
image_id
 = 
£lf
.
ids
[
šdex
]

49 
image
 = 
£lf
.
	$_»ad_image
(
image_id
)

50 
£lf
.
ŒªsfÜm
:

51 
image
, 
_
 = 
£lf
.
	$ŒªsfÜm
(
image
)

52  
image


54 
def
 
	$g‘_ªnÙ©iÚ
(
£lf
, 
šdex
):

55 
image_id
 = 
£lf
.
ids
[
šdex
]

56  
image_id
, 
£lf
.
	$_g‘_ªnÙ©iÚ
(
image_id
)

58 
def
 
	$__Ën__
(
£lf
):

59  
	`Ën
(
£lf
.
ids
)

61 @
¡©icm‘hod


62 
def
 
	$_»ad_image_ids
(
image_£ts_fe
):

63 
ids
 = []

64 
w™h
 
	$İ’
(
image_£ts_fe
è
as
 
f
:

65 
lše
 
š
 
f
:

66 
ids
.
	`­³nd
(
lše
.
	$r¡r
())

67  
ids


69 
def
 
	$_g‘_ªnÙ©iÚ
(
£lf
, 
image_id
):

70 
ªnÙ©iÚ_fe
 = 
£lf
.
roÙ
 / 
f
"Annotations/{image_id}.xml"

71 
objeùs
 = 
ET
.
	`·r£
(
ªnÙ©iÚ_fe
).
	`fšd®l
("object")

72 
boxes
 = []

73 
Ïb–s
 = []

74 
is_difficuÉ
 = []

75 
objeù
 
š
 
objeùs
:

76 
şass_Çme
 = 
objeù
.
	`fšd
('Çme').
‹xt
.
	`low”
().
	$¡r
()

77 
bbox
 = 
objeù
.
	`fšd
('bndbox')

78 #VOC 
d©a£t
 
fÜm©
 
fŞlows
 
M©Ïb
, 
š
 
which
 
šdexes
 
¡¬t
 
äom
 0

79 
x1
 = (
bbox
.
	`fšd
('xmš').
‹xt
) - 1

80 
y1
 = (
bbox
.
	`fšd
('ymš').
‹xt
) - 1

81 
x2
 = (
bbox
.
	`fšd
('xmax').
‹xt
) - 1

82 
y2
 = (
bbox
.
	`fšd
('ymax').
‹xt
) - 1

83 
boxes
.
	$­³nd
([
x1
, 
y1
, 
x2
, 
y2
])

84 
Ïb–s
.
	$­³nd
(
£lf
.
şass_diù
[
şass_Çme
])

85 
is_difficuÉ_¡r
 = 
objeù
.
	`fšd
('difficuÉ').
‹xt


86 
is_difficuÉ
.
	`­³nd
((
is_difficuÉ_¡r
) is_difficult_str 0)

88  (
Å
.
	`¬¿y
(
boxes
, 
dty³
òp.
æßt32
),

89 
Å
.
	`¬¿y
(
Ïb–s
, 
dty³
òp.
št64
),

90 
Å
.
	$¬¿y
(
is_difficuÉ
, 
dty³
=
Å
.
ušt8
))

92 
def
 
	$_»ad_image
(
£lf
, 
image_id
):

93 
image_fe
 = 
£lf
.
roÙ
 / 
f
"JPEGImages/{image_id}.jpg"

94 
image
 = 
cv2
.
	`im»ad
(
	$¡r
(
image_fe
))

95 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_BGR2RGB
)

96  
image


	@vision/nn/__init__.py

	@vision/nn/alexnet.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
	gtÜch
.
	guts
.
mod–_zoo
 
as
 
	gmod–_zoo


4 #cİ›d 
äom
 
tÜchvisiÚ
 (
h‰ps
:

5 #Th
fÜw¬d
 
funùiÚ
 
is
 
modif›d
 
mod–
 
´unšg
.

7 
__®l__
 = ['AlexNet', 'alexnet']

10 
mod–_u¾s
 = {

15 
şass
 
	$AËxN‘
(
Â
.
ModuË
):

17 
def
 
	$__š™__
(
£lf
, 
num_şas£s
=1000):

18 
	`su³r
(
AËxN‘
, 
£lf
).
	$__š™__
()

19 
£lf
.
ã©u»s
 = 
Â
.
	`Sequ’tŸl
(

20 
Â
.
	`CÚv2d
(3, 64, 
k”Ãl_size
=11, 
¡ride
=4, 
·ddšg
=2),

21 
Â
.
	`ReLU
(
š¶aû
=
True
),

22 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

23 
Â
.
	`CÚv2d
(64, 192, 
k”Ãl_size
=5, 
·ddšg
=2),

24 
Â
.
	`ReLU
(
š¶aû
=
True
),

25 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

26 
Â
.
	`CÚv2d
(192, 384, 
k”Ãl_size
=3, 
·ddšg
=1),

27 
Â
.
	`ReLU
(
š¶aû
=
True
),

28 
Â
.
	`CÚv2d
(384, 256, 
k”Ãl_size
=3, 
·ddšg
=1),

29 
Â
.
	`ReLU
(
š¶aû
=
True
),

30 
Â
.
	`CÚv2d
(256, 256, 
k”Ãl_size
=3, 
·ddšg
=1),

31 
Â
.
	`ReLU
(
š¶aû
=
True
),

32 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

34 
£lf
.
şassif›r
 = 
Â
.
	`Sequ’tŸl
(

35 
Â
.
	`Drİout
(),

36 
Â
.
	`Lš—r
(256 * 6 * 6, 4096),

37 
Â
.
	`ReLU
(
š¶aû
=
True
),

38 
Â
.
	`Drİout
(),

39 
Â
.
	`Lš—r
(4096, 4096),

40 
Â
.
	`ReLU
(
š¶aû
=
True
),

41 
Â
.
	`Lš—r
(4096, 
num_şas£s
),

44 
def
 
	$fÜw¬d
(
£lf
, 
x
):

45 
x
 = 
£lf
.
	$ã©u»s
(
x
)

46 
x
 = x.
	`v›w
(x.
	`size
(0), -1)

47 
x
 = 
£lf
.
	$şassif›r
(
x
)

48  
x


51 
def
 
	$®exÃt
(
´‘¿šed
=
F®£
, **
kw¬gs
):

52 
r
"""AlexNet model‡rchitecture fromhe

53 `"OÃ weœdrick..." <
h‰ps
:

55 
Args
:

56 
	$´‘¿šed
 (
boŞ
): 
If
 
True
, 
»tuºs
 
a
 
mod–
 
´e
-
Œašed
 
Ú
 
ImageN‘


58 
mod–
 = 
	$AËxN‘
(**
kw¬gs
)

59 
´‘¿šed
:

60 
mod–
.
	`lßd_¡©e_diù
(
mod–_zoo
.
	`lßd_u¾
(
mod–_u¾s
['alexnet']))

	@vision/nn/mobilenet.py

1 #bÜrowed 
äom
 "https://github.com/marvis/pytorch-mobilenet"

3 
impÜt
 
	gtÜch
.
Â
 
as
‚n

4 
impÜt
 
	gtÜch
.
	gÂ
.
funùiÚ®
 
as
 
F


7 
şass
 
	$MobeN‘V1
(
Â
.
ModuË
):

8 
def
 
	$__š™__
(
£lf
, 
num_şas£s
=1024):

9 
	`su³r
(
MobeN‘V1
, 
£lf
).
	$__š™__
()

11 
def
 
	$cÚv_bn
(
šp
, 
oup
, 
¡ride
):

12  
Â
.
	`Sequ’tŸl
(

13 
Â
.
	`CÚv2d
(
šp
, 
oup
, 3, 
¡ride
, 1, 
bŸs
=
F®£
),

14 
Â
.
	`B©chNÜm2d
(
oup
),

15 
Â
.
	$ReLU
(
š¶aû
=
True
)

18 
def
 
	$cÚv_dw
(
šp
, 
oup
, 
¡ride
):

19  
Â
.
	`Sequ’tŸl
(

20 
Â
.
	`CÚv2d
(
šp
, iÅ, 3, 
¡ride
, 1, 
groups
=šp, 
bŸs
=
F®£
),

21 
Â
.
	`B©chNÜm2d
(
šp
),

22 
Â
.
	`ReLU
(
š¶aû
=
True
),

24 
Â
.
	`CÚv2d
(
šp
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

25 
Â
.
	`B©chNÜm2d
(
oup
),

26 
Â
.
	`ReLU
(
š¶aû
=
True
),

29 
£lf
.
mod–
 = 
Â
.
	`Sequ’tŸl
(

30 
	`cÚv_bn
(3, 32, 2),

31 
	`cÚv_dw
(32, 64, 1),

32 
	`cÚv_dw
(64, 128, 2),

33 
	`cÚv_dw
(128, 128, 1),

34 
	`cÚv_dw
(128, 256, 2),

35 
	`cÚv_dw
(256, 256, 1),

36 
	`cÚv_dw
(256, 512, 2),

37 
	`cÚv_dw
(512, 512, 1),

38 
	`cÚv_dw
(512, 512, 1),

39 
	`cÚv_dw
(512, 512, 1),

40 
	`cÚv_dw
(512, 512, 1),

41 
	`cÚv_dw
(512, 512, 1),

42 
	`cÚv_dw
(512, 1024, 2),

43 
	`cÚv_dw
(1024, 1024, 1),

45 
£lf
.
fc
 = 
Â
.
	$Lš—r
(1024, 
num_şas£s
)

47 
def
 
	$fÜw¬d
(
£lf
, 
x
):

48 
x
 = 
£lf
.
	$mod–
(
x
)

49 
x
 = 
F
.
	$avg_poŞ2d
(
x
, 7)

50 
x
 = x.
	`v›w
(-1, 1024)

51 
x
 = 
£lf
.
	$fc
(
x
)

	@vision/nn/mobilenet_v2.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
	gm©h


4 #Modif›d 
äom
 
h‰ps
:

5 #IÀ
this
 
v”siÚ
, 
R–u6
 
is
 
»¶aûd
 
w™h
 
R–u
 
to
 
make
 
™
 
ONNX
 
com·tibË
.

6 #B©chNÜm 
Lay”
 
is
 
İtiÚ®
 
to
 
make
 
™
 
—sy
 dØ
b©ch
 
nÜm
 
cÚfusiÚ
.

9 
def
 
	$cÚv_bn
(
šp
, 
oup
, 
¡ride
, 
u£_b©ch_nÜm
=
True
, 
Únx_com·tibË
=
F®£
):

10 
ReLU
 = 
Â
.ReLU 
Únx_com·tibË
 Â.
ReLU6


12 
u£_b©ch_nÜm
:

13  
Â
.
	`Sequ’tŸl
(

14 
Â
.
	`CÚv2d
(
šp
, 
oup
, 3, 
¡ride
, 1, 
bŸs
=
F®£
),

15 
Â
.
	`B©chNÜm2d
(
oup
),

16 
	$ReLU
(
š¶aû
=
True
)

19  
Â
.
	`Sequ’tŸl
(

20 
Â
.
	`CÚv2d
(
šp
, 
oup
, 3, 
¡ride
, 1, 
bŸs
=
F®£
),

21 
	$ReLU
(
š¶aû
=
True
)

25 
def
 
	$cÚv_1x1_bn
(
šp
, 
oup
, 
u£_b©ch_nÜm
=
True
, 
Únx_com·tibË
=
F®£
):

26 
ReLU
 = 
Â
.ReLU 
Únx_com·tibË
 Â.
ReLU6


27 
u£_b©ch_nÜm
:

28  
Â
.
	`Sequ’tŸl
(

29 
Â
.
	`CÚv2d
(
šp
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

30 
Â
.
	`B©chNÜm2d
(
oup
),

31 
	$ReLU
(
š¶aû
=
True
)

34  
Â
.
	`Sequ’tŸl
(

35 
Â
.
	`CÚv2d
(
šp
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

36 
	$ReLU
(
š¶aû
=
True
)

40 
şass
 
	$Inv”‹dResidu®
(
Â
.
ModuË
):

41 
def
 
	$__š™__
(
£lf
, 
šp
, 
oup
, 
¡ride
, 
ex·nd_¿tio
, 
u£_b©ch_nÜm
=
True
, 
Únx_com·tibË
=
F®£
):

42 
	`su³r
(
Inv”‹dResidu®
, 
£lf
).
	$__š™__
()

43 
ReLU
 = 
Â
.ReLU 
Únx_com·tibË
 Â.
ReLU6


45 
£lf
.
¡ride
 = stride

46 
as£¹
 
¡ride
 
š
 [1, 2]

48 
hidd’_dim
 = 
	$round
(
šp
 * 
ex·nd_¿tio
)

49 
£lf
.
u£_»s_cÚÃù
 = s–f.
¡ride
 =ğ1 
ªd
 
šp
 =ğ
oup


51 
ex·nd_¿tio
 == 1:

52 
u£_b©ch_nÜm
:

53 
£lf
.
cÚv
 = 
Â
.
	`Sequ’tŸl
(

55 
Â
.
	`CÚv2d
(
hidd’_dim
, hidd’_dim, 3, 
¡ride
, 1, 
groups
=hidd’_dim, 
bŸs
=
F®£
),

56 
Â
.
	`B©chNÜm2d
(
hidd’_dim
),

57 
	`ReLU
(
š¶aû
=
True
),

58 #pw-
lš—r


59 
Â
.
	`CÚv2d
(
hidd’_dim
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

60 
Â
.
	`B©chNÜm2d
(
oup
),

63 
£lf
.
cÚv
 = 
Â
.
	`Sequ’tŸl
(

65 
Â
.
	`CÚv2d
(
hidd’_dim
, hidd’_dim, 3, 
¡ride
, 1, 
groups
=hidd’_dim, 
bŸs
=
F®£
),

66 
	`ReLU
(
š¶aû
=
True
),

67 #pw-
lš—r


68 
Â
.
	`CÚv2d
(
hidd’_dim
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

71 
u£_b©ch_nÜm
:

72 
£lf
.
cÚv
 = 
Â
.
	`Sequ’tŸl
(

74 
Â
.
	`CÚv2d
(
šp
, 
hidd’_dim
, 1, 1, 0, 
bŸs
=
F®£
),

75 
Â
.
	`B©chNÜm2d
(
hidd’_dim
),

76 
	`ReLU
(
š¶aû
=
True
),

78 
Â
.
	`CÚv2d
(
hidd’_dim
, hidd’_dim, 3, 
¡ride
, 1, 
groups
=hidd’_dim, 
bŸs
=
F®£
),

79 
Â
.
	`B©chNÜm2d
(
hidd’_dim
),

80 
	`ReLU
(
š¶aû
=
True
),

81 #pw-
lš—r


82 
Â
.
	`CÚv2d
(
hidd’_dim
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

83 
Â
.
	`B©chNÜm2d
(
oup
),

86 
£lf
.
cÚv
 = 
Â
.
	`Sequ’tŸl
(

88 
Â
.
	`CÚv2d
(
šp
, 
hidd’_dim
, 1, 1, 0, 
bŸs
=
F®£
),

89 
	`ReLU
(
š¶aû
=
True
),

91 
Â
.
	`CÚv2d
(
hidd’_dim
, hidd’_dim, 3, 
¡ride
, 1, 
groups
=hidd’_dim, 
bŸs
=
F®£
),

92 
	`ReLU
(
š¶aû
=
True
),

93 #pw-
lš—r


94 
Â
.
	`CÚv2d
(
hidd’_dim
, 
oup
, 1, 1, 0, 
bŸs
=
F®£
),

97 
def
 
	$fÜw¬d
(
£lf
, 
x
):

98 
£lf
.
u£_»s_cÚÃù
:

99  
x
 + 
£lf
.
	$cÚv
(
x
)

101  
£lf
.
	$cÚv
(
x
)

104 
şass
 
	$MobeN‘V2
(
Â
.
ModuË
):

105 
def
 
	$__š™__
(
£lf
, 
n_şass
=1000, 
šput_size
=224, 
width_muÉ
=1., 
drİout_¿tio
=0.2,

106 
u£_b©ch_nÜm
=
True
, 
Únx_com·tibË
=
F®£
):

107 
	`su³r
(
MobeN‘V2
, 
£lf
).
	$__š™__
()

108 
block
 = 
Inv”‹dResidu®


109 
šput_chªÃl
 = 32

110 
Ï¡_chªÃl
 = 1280

111 
š‹rv”‹d_»sidu®_£‰šg
 = [

112 #t, 
c
, 
n
, 
s


122 #budšg 
fœ¡
 
Ïy”


123 
as£¹
 
šput_size
 % 32 == 0

124 
šput_chªÃl
 = (šput_chªÃÈ* 
width_muÉ
)

125 
£lf
.
Ï¡_chªÃl
 = Öa¡_chªÃÈ* 
width_muÉ
) width_mult > 1.0 last_channel

126 
£lf
.
ã©u»s
 = [
	`cÚv_bn
(3, 
šput_chªÃl
, 2, 
Únx_com·tibË
=onnx_compatible)]

127 #budšg 
šv”‹d
 
»sidu®
 
blocks


128 
t
, 
c
, 
n
, 
s
 
š
 
š‹rv”‹d_»sidu®_£‰šg
:

129 
ouut_chªÃl
 = (
c
 * 
width_muÉ
)

130 
i
 
š
 
	$¿nge
(
n
):

131 
i
 == 0:

132 
£lf
.
ã©u»s
.
	`­³nd
(
	$block
(
šput_chªÃl
, 
ouut_chªÃl
, 
s
,

133 
ex·nd_¿tio
=
t
, 
u£_b©ch_nÜm
=use_batch_norm,

134 
Únx_com·tibË
=onnx_compatible))

136 
£lf
.
ã©u»s
.
	`­³nd
(
	$block
(
šput_chªÃl
, 
ouut_chªÃl
, 1,

137 
ex·nd_¿tio
=
t
, 
u£_b©ch_nÜm
=use_batch_norm,

138 
Únx_com·tibË
=onnx_compatible))

139 
šput_chªÃl
 = 
ouut_chªÃl


140 #budšg 
Ï¡
 
£v”®
 
Ïy”s


141 
£lf
.
ã©u»s
.
	`­³nd
(
	$cÚv_1x1_bn
(
šput_chªÃl
, 
£lf
.
Ï¡_chªÃl
,

142 
u£_b©ch_nÜm
=u£_b©ch_nÜm, 
Únx_com·tibË
=onnx_compatible))

143 #mak
™
 
Â
.
Sequ’tŸl


144 
£lf
.
ã©u»s
 = 
Â
.
	$Sequ’tŸl
(*
£lf
.
ã©u»s
)

146 #budšg 
şassif›r


147 
£lf
.
şassif›r
 = 
Â
.
	`Sequ’tŸl
(

148 
Â
.
	`Drİout
(
drİout_¿tio
),

149 
Â
.
	`Lš—r
(
£lf
.
Ï¡_chªÃl
, 
n_şass
),

152 
£lf
.
	$_š™Ÿlize_weights
()

154 
def
 
	$fÜw¬d
(
£lf
, 
x
):

155 
x
 = 
£lf
.
	$ã©u»s
(
x
)

156 
x
 = x.
	`m—n
(3).
	$m—n
(2)

157 
x
 = 
£lf
.
	$şassif›r
(
x
)

158  
x


160 
def
 
	$_š™Ÿlize_weights
(
£lf
):

161 
m
 
š
 
£lf
.
	$moduËs
():

162 
	$isš¡ªû
(
m
, 
Â
.
CÚv2d
):

163 
n
 = 
m
.
k”Ãl_size
[0] * m.k”Ãl_size[1] * m.
out_chªÃls


164 
m
.
weight
.
d©a
.
	`nÜm®_
(0, 
m©h
.
	`sq¹
(2. / 
n
))

165 
m
.
bŸs
 
is
 
nÙ
 
NÚe
:

166 
m
.
bŸs
.
d©a
.
	$z”o_
()

167 
–if
 
	$isš¡ªû
(
m
, 
Â
.
B©chNÜm2d
):

168 
m
.
weight
.
d©a
.
	$fl_
(1)

169 
m
.
bŸs
.
d©a
.
	$z”o_
()

170 
–if
 
	$isš¡ªû
(
m
, 
Â
.
Lš—r
):

171 
n
 = 
m
.
weight
.
	$size
(1)

172 
m
.
weight
.
d©a
.
	$nÜm®_
(0, 0.01)

173 
m
.
bŸs
.
d©a
.
	`z”o_
()

	@vision/nn/multibox_loss.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
	gtÜch
.
	gÂ
.
funùiÚ®
 
as
 
F


3 
impÜt
 
tÜch


6 
	gäom
 ..
uts
 
impÜt
 
box_uts


9 
şass
 
	$MuÉiboxLoss
(
Â
.
ModuË
):

10 
def
 
	$__š™__
(
£lf
, 
´iÜs
, 
iou_th»shŞd
, 
Ãg_pos_¿tio
,

11 
ûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû
, 
deviû
):

14 
BasiÿÎy
, 
MuÉibox
 
loss
 
combšes
 
şassifiÿtiÚ
†oss

15 
ªd
 
SmoÙh
 
L1
 
»g»ssiÚ
 
loss
.

17 
	`su³r
(
MuÉiboxLoss
, 
£lf
).
	$__š™__
()

18 
£lf
.
iou_th»shŞd
 = iou_threshold

19 
£lf
.
Ãg_pos_¿tio
 =‚eg_pos_ratio

20 
£lf
.
ûÁ”_v¬Ÿnû
 = center_variance

21 
£lf
.
size_v¬Ÿnû
 = size_variance

22 
£lf
.
´iÜs
 =…riors

23 
£lf
.
´iÜs
.
	$to
(
deviû
)

25 #DISTANCE 
CHANGE


26 #deà
	`fÜw¬d
(
£lf
, 
cÚfid’û
, 
´ediùed_loÿtiÚs
, 
Ïb–s
, 
gt_loÿtiÚs
):

27 
def
 
	$fÜw¬d
(
£lf
, 
cÚfid’û
, 
´ediùed_loÿtiÚs
, 
´ed_di¡
, 
Ïb–s
, 
gt_loÿtiÚs
, 
gt_di¡
):

30 
Args
:

31 
	$cÚfid’û
 (
b©ch_size
, 
num_´iÜs
, 
num_şas£s
): 
şass
 
´ediùiÚs
.

32 
	$loÿtiÚs
 (
b©ch_size
, 
num_´iÜs
, 4): 
´ediùed
 
loÿtiÚs
.

33 #DISTANCE 
CHANGE


34 
	$´ed_di¡
 (
b©ch_size
, 
num_´iÜs
, 
num_di¡_chªÃls
): 
´ediùed
 
di¡ªûs


35 
	$Ïb–s
 (
b©ch_size
, 
num_´iÜs
): 
»®
 
Ïb–s
 
of
 
®l
 
the
 
´iÜs
.

36 
	$boxes
 (
b©ch_size
, 
num_´iÜs
, 4): 
»®
 
boxes
 
cÜ»¥Údšg
 
®l
 
the
 
´iÜs
.

37 #DISTANCE 
CHANGE


38 
	$gt_di¡
 (
b©ch_size
, 
num_´iÜs
, 
num_di¡_chªÃls
): 
ground
 
Œuth
 
di¡ªûs


40 
num_şas£s
 = 
cÚfid’û
.
	$size
(2)

41 
w™h
 
tÜch
.
	$no_g¿d
():

42 #d”ived 
äom
 
üoss_’Œİy
=
	`sum
(
	`log
(
p
))

43 
loss
 = -
F
.
	`log_soámax
(
cÚfid’û
, 
dim
=2)[:, :, 0]

44 
mask
 = 
box_uts
.
	$h¬d_Ãg©ive_mššg
(
loss
, 
Ïb–s
, 
£lf
.
Ãg_pos_¿tio
)

46 
cÚfid’û
 = cÚfid’û[
mask
, :]

47 
şassifiÿtiÚ_loss
 = 
F
.
	`üoss_’Œİy
(
cÚfid’û
.
	`»sh­e
(-1, 
num_şas£s
), 
Ïb–s
[
mask
], 
size_av”age
=
F®£
)

48 
pos_mask
 = 
Ïb–s
 > 0

49 
´ediùed_loÿtiÚs
 =…»diùed_loÿtiÚs[
pos_mask
, :].
	`»sh­e
(-1, 4)

50 
gt_loÿtiÚs
 = gt_loÿtiÚs[
pos_mask
, :].
	`»sh­e
(-1, 4)

51 
smoÙh_l1_loss
 = 
F
.
	$smoÙh_l1_loss
(
´ediùed_loÿtiÚs
, 
gt_loÿtiÚs
, 
size_av”age
=
F®£
)

53 
	`´št
(
f
"pred†oc shape {predicted_locations.shape} gt†oc shape {gt_locations.shape}")

54 #DISTANCE 
CHANGE


55 
´ed_di¡
 =…»d_di¡[
pos_mask
, :].
	`»sh­e
(-1, 1)

56 
l2_loss
 = 
F
.
	$m£_loss
(
´ed_di¡
, 
gt_di¡
, 
size_av”age
=
F®£
)

58 
num_pos
 = 
gt_loÿtiÚs
.
	$size
(0)

59  
smoÙh_l1_loss
/
num_pos
, 
şassifiÿtiÚ_loss
/num_pos, 
l2_loss
/num_pos

	@vision/nn/scaled_l2_norm.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
tÜch


3 
impÜt
 
	gtÜch
.
	gÂ
.
funùiÚ®
 
as
 
F


6 
şass
 
	$SÿËdL2NÜm
(
Â
.
ModuË
):

7 
def
 
	$__š™__
(
£lf
, 
š_chªÃls
, 
š™Ÿl_sÿË
):

8 
	`su³r
(
SÿËdL2NÜm
, 
£lf
).
	$__š™__
()

9 
£lf
.
š_chªÃls
 = in_channels

10 
£lf
.
sÿË
 = 
Â
.
	`P¬am‘”
(
tÜch
.
	$T’sÜ
(
š_chªÃls
))

11 
£lf
.
š™Ÿl_sÿË
 = initial_scale

12 
£lf
.
	$»£t_·¿m‘”s
()

14 
def
 
	$fÜw¬d
(
£lf
, 
x
):

15  (
F
.
	`nÜm®ize
(
x
, 
p
=2, 
dim
=1)

16 * 
£lf
.
sÿË
.
	`unsqu“ze
(0).unsqu“ze(2).
	$unsqu“ze
(3))

18 
def
 
	$»£t_·¿m‘”s
(
£lf
):

19 
£lf
.
sÿË
.
d©a
.
	`fl_
(£lf.
š™Ÿl_sÿË
)

	@vision/nn/squeezenet.py

1 
impÜt
 
m©h


2 
impÜt
 
tÜch


3 
impÜt
 
	gtÜch
.
Â
 
as
‚n

4 
impÜt
 
	gtÜch
.
	gÂ
.
š™
 
as
 init

5 
impÜt
 
	gtÜch
.
	guts
.
mod–_zoo
 
as
 model_zoo

8 
	g__®l__
 = ['SqueezeNet', 'squeezenet1_0', 'squeezenet1_1']

11 
	gmod–_u¾s
 = {

17 
şass
 
	$Fœe
(
Â
.
ModuË
):

19 
def
 
	$__š™__
(
£lf
, 
š¶ªes
, 
squ“ze_¶ªes
,

20 
ex·nd1x1_¶ªes
, 
ex·nd3x3_¶ªes
):

21 
	`su³r
(
Fœe
, 
£lf
).
	$__š™__
()

22 
£lf
.
š¶ªes
 = inplanes

23 
£lf
.
squ“ze
 = 
Â
.
	$CÚv2d
(
š¶ªes
, 
squ“ze_¶ªes
, 
k”Ãl_size
=1)

24 
£lf
.
squ“ze_aùiv©iÚ
 = 
Â
.
	$ReLU
(
š¶aû
=
True
)

25 
£lf
.
ex·nd1x1
 = 
Â
.
	$CÚv2d
(
squ“ze_¶ªes
, 
ex·nd1x1_¶ªes
,

26 
k”Ãl_size
=1)

27 
£lf
.
ex·nd1x1_aùiv©iÚ
 = 
Â
.
	$ReLU
(
š¶aû
=
True
)

28 
£lf
.
ex·nd3x3
 = 
Â
.
	$CÚv2d
(
squ“ze_¶ªes
, 
ex·nd3x3_¶ªes
,

29 
k”Ãl_size
=3, 
·ddšg
=1)

30 
£lf
.
ex·nd3x3_aùiv©iÚ
 = 
Â
.
	$ReLU
(
š¶aû
=
True
)

32 
def
 
	$fÜw¬d
(
£lf
, 
x
):

33 
x
 = 
£lf
.
	`squ“ze_aùiv©iÚ
(£lf.
	$squ“ze
(
x
))

34  
tÜch
.
	`ÿt
([

35 
£lf
.
	`ex·nd1x1_aùiv©iÚ
(£lf.
	`ex·nd1x1
(
x
)),

36 
£lf
.
	`ex·nd3x3_aùiv©iÚ
(£lf.
	`ex·nd3x3
(
x
))

40 
şass
 
	$Squ“zeN‘
(
Â
.
ModuË
):

42 
def
 
	$__š™__
(
£lf
, 
v”siÚ
=1.0, 
num_şas£s
=1000):

43 
	`su³r
(
Squ“zeN‘
, 
£lf
).
	$__š™__
()

44 
v”siÚ
 
nÙ
 
š
 [1.0, 1.1]:

45 
¿i£
 
	`V®ueE¼Ü
("Unsupported SqueezeNet version {version}:"

46 "1.0 o¸1.1ƒx³ùed".
	$fÜm©
(
v”siÚ
=version))

47 
£lf
.
num_şas£s
 =‚um_classes

48 
v”siÚ
 == 1.0:

49 
£lf
.
ã©u»s
 = 
Â
.
	`Sequ’tŸl
(

50 
Â
.
	`CÚv2d
(3, 96, 
k”Ãl_size
=7, 
¡ride
=2),

51 
Â
.
	`ReLU
(
š¶aû
=
True
),

52 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2, 
û_mode
=
True
),

53 
	`Fœe
(96, 16, 64, 64),

54 
	`Fœe
(128, 16, 64, 64),

55 
	`Fœe
(128, 32, 128, 128),

56 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2, 
û_mode
=
True
),

57 
	`Fœe
(256, 32, 128, 128),

58 
	`Fœe
(256, 48, 192, 192),

59 
	`Fœe
(384, 48, 192, 192),

60 
	`Fœe
(384, 64, 256, 256),

61 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2, 
û_mode
=
True
),

62 
	`Fœe
(512, 64, 256, 256),

65 
£lf
.
ã©u»s
 = 
Â
.
	`Sequ’tŸl
(

66 
Â
.
	`CÚv2d
(3, 64, 
k”Ãl_size
=3, 
¡ride
=2),

67 
Â
.
	`ReLU
(
š¶aû
=
True
),

68 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

69 
	`Fœe
(64, 16, 64, 64),

70 
	`Fœe
(128, 16, 64, 64),

71 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

72 
	`Fœe
(128, 32, 128, 128),

73 
	`Fœe
(256, 32, 128, 128),

74 
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=2),

75 
	`Fœe
(256, 48, 192, 192),

76 
	`Fœe
(384, 48, 192, 192),

77 
	`Fœe
(384, 64, 256, 256),

78 
	`Fœe
(512, 64, 256, 256),

80 #Fš® 
cÚvŞutiÚ
 
is
 
š™Ÿlized
 
difã»Ály
 
fÜm
 
the
 
»¡


81 
fš®_cÚv
 = 
Â
.
	$CÚv2d
(512, 
£lf
.
num_şas£s
, 
k”Ãl_size
=1)

82 
£lf
.
şassif›r
 = 
Â
.
	`Sequ’tŸl
(

83 
Â
.
	`Drİout
(
p
=0.5),

84 
fš®_cÚv
,

85 
Â
.
	`ReLU
(
š¶aû
=
True
),

86 
Â
.
	$AvgPoŞ2d
(13, 
¡ride
=1)

89 
m
 
š
 
£lf
.
	$moduËs
():

90 
	$isš¡ªû
(
m
, 
Â
.
CÚv2d
):

91 
m
 
is
 
fš®_cÚv
:

92 
š™
.
	$nÜm®_
(
m
.
weight
, 
m—n
=0.0, 
¡d
=0.01)

94 
š™
.
	$kaimšg_unifÜm_
(
m
.
weight
)

95 
m
.
bŸs
 
is
 
nÙ
 
NÚe
:

96 
š™
.
	$cÚ¡ªt_
(
m
.
bŸs
, 0)

98 
def
 
	$fÜw¬d
(
£lf
, 
x
):

99 
x
 = 
£lf
.
	$ã©u»s
(
x
)

100 
x
 = 
£lf
.
	$şassif›r
(
x
)

101  
x
.
	`v›w
(x.
	`size
(0), 
£lf
.
num_şas£s
)

104 
def
 
	$squ“z’‘1_0
(
´‘¿šed
=
F®£
, **
kw¬gs
):

105 
r
"""Squ“zeN‘ mod–‡rch™eùu» fromh`"
Squ“zeN‘
: 
AËxN‘
-
Ëv–


106 
accu¿cy
 
w™h
 50x 
ãw”
 
·¿m‘”s
 
ªd
 <0.5
MB
 
mod–
 
size
"

107 <
h‰ps
:

109 
Args
:

110 
	$´‘¿šed
 (
boŞ
): 
If
 
True
, 
»tuºs
 
a
 
mod–
 
´e
-
Œašed
 
Ú
 
ImageN‘


112 
mod–
 = 
	$Squ“zeN‘
(
v”siÚ
=1.0, **
kw¬gs
)

113 
´‘¿šed
:

114 
mod–
.
	`lßd_¡©e_diù
(
mod–_zoo
.
	`lßd_u¾
(
mod–_u¾s
['squeezenet1_0']))

115  
mod–


118 
def
 
	$squ“z’‘1_1
(
´‘¿šed
=
F®£
, **
kw¬gs
):

119 
r
"""SqueezeNet 1.1 model fromhe `official SqueezeNet„epo

120 <
h‰ps
:

121 
Squ“zeN‘
 1.1 
has
 2.4x 
Ëss
 
computiÚ
 
ªd
 
¦ighy
 
ãw”
 
·¿m‘”s


122 
thª
 
Squ“zeN‘
 1.0, 
w™hout
 
§üificšg
 
accu¿cy
.

124 
Args
:

125 
	$´‘¿šed
 (
boŞ
): 
If
 
True
, 
»tuºs
 
a
 
mod–
 
´e
-
Œašed
 
Ú
 
ImageN‘


127 
mod–
 = 
	$Squ“zeN‘
(
v”siÚ
=1.1, **
kw¬gs
)

128 
´‘¿šed
:

129 
mod–
.
	`lßd_¡©e_diù
(
mod–_zoo
.
	`lßd_u¾
(
mod–_u¾s
['squeezenet1_1']))

130  
mod–


	@vision/nn/vgg.py

1 
impÜt
 
	gtÜch
.
Â
 
as
 
	gÂ


4 #bÜrowed 
äom
 
h‰ps
:

5 
def
 
	$vgg
(
cfg
, 
b©ch_nÜm
=
F®£
):

6 
Ïy”s
 = []

7 
š_chªÃls
 = 3

8 
v
 
š
 
cfg
:

9 
v
 == 'M':

10 
Ïy”s
 +ğ[
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=2, 
¡ride
=2)]

11 
–if
 
v
 == 'C':

12 
Ïy”s
 +ğ[
Â
.
	`MaxPoŞ2d
(
k”Ãl_size
=2, 
¡ride
=2, 
û_mode
=
True
)]

14 
cÚv2d
 = 
Â
.
	$CÚv2d
(
š_chªÃls
, 
v
, 
k”Ãl_size
=3, 
·ddšg
=1)

15 
b©ch_nÜm
:

16 
Ïy”s
 +ğ[
cÚv2d
, 
Â
.
	`B©chNÜm2d
(
v
),‚n.
	`ReLU
(
š¶aû
=
True
)]

18 
Ïy”s
 +ğ[
cÚv2d
, 
Â
.
	`ReLU
(
š¶aû
=
True
)]

19 
š_chªÃls
 = 
v


20 
poŞ5
 = 
Â
.
	$MaxPoŞ2d
(
k”Ãl_size
=3, 
¡ride
=1, 
·ddšg
=1)

21 
cÚv6
 = 
Â
.
	$CÚv2d
(512, 1024, 
k”Ãl_size
=3, 
·ddšg
=6, 
d©iÚ
=6)

22 
cÚv7
 = 
Â
.
	$CÚv2d
(1024, 1024, 
k”Ãl_size
=1)

23 
Ïy”s
 +ğ[
poŞ5
, 
cÚv6
,

24 
Â
.
	`ReLU
(
š¶aû
=
True
), 
cÚv7
,‚n.ReLU(inplace=True)]

	@vision/prunning/__init__.py

	@vision/prunning/prunner.py

1 
impÜt
 
tÜch


2 
impÜt
 
	gtÜch
.
Â
 
as
‚n

3 
impÜt
 
loggšg


4 
äom
 
h—pq
 
impÜt
 
nsm®Ë¡


6 
	gäom
 ..
	guts
.
mod–_book
 
impÜt
 
Mod–Book


9 
şass
 
	gMod–PruÂ”
:

10 
def
 
	$__š™__
(
£lf
, 
mod–
, 
Œaš_fun
, 
ignÜed_·ths
=[]):

13 
The
 
´uÂšg
 
ü™”Ÿ
 
is
 
dC
/
dh
 * 
h
, 
C
 i 
the
 
co¡
, h i th
aùiv©iÚ
.

15 
£lf
.
mod–
 = model

16 
£lf
.
Œaš_fun
 =rain_fun

17 
£lf
.
ignÜed_·ths
 = ignored_paths

18 
£lf
.
book
 = 
	$Mod–Book
(
£lf
.
mod–
)

19 
£lf
.
ouuts
 = {
	}
}

20 
£lf
.
g¿ds
 = {}

21 
£lf
.
hªdËs
 = []

22 
£lf
.
deûnd’t_b©ch_nÜms
 = {} #desûndªt 
im·ùed
 
by
 
the
 
cÚv
 
Ïy”s
.

23 
£lf
.
Ï¡_cÚv_·th
 = 
NÚe
 #u£d 
to
 
Œaû
 
the
 
g¿ph


24 
£lf
.
desûnd’t_cÚvs
 = {} #desûndªt 
im·ùed
 
by
 
the
 
cÚv
 
Ïy”s
.

25 
£lf
.
desûnd’t_lš—rs
 = {} #desûndªt 
im·ùed
 
by
 
the
 
lš—r
 
Ïy”s
.

26 
£lf
.
Ï¡_lš—r_·th
 = 
NÚe
 #u£d 
to
 
Œaû
 
the
 
g¿ph


28 
def
 
_make_Ãw_cÚv
(
£lf
, 
cÚv
, 
f‹r_šdex
, 
chªÃl_ty³
="out"):

29 
nÙ
 
	$isš¡ªû
(
cÚv
, 
Â
.
CÚv2d
):

30 
¿i£
 
	`Ty³E¼Ü
(
f
"The module is‚ot Conv2d, but {type(conv)}.")

32 
chªÃl_ty³
 == "out":

33 
Ãw_cÚv
 = 
Â
.
	`CÚv2d
(
cÚv
.
š_chªÃls
, cÚv.
out_chªÃls
 - 1, cÚv.
k”Ãl_size
, cÚv.
¡ride
,

34 
cÚv
.
·ddšg
, cÚv.
d©iÚ
, cÚv.
groups
, cÚv.
bŸs
 
is
 
nÙ
 
NÚe
)

35 
mask
 = 
tÜch
.
	$Úes
(
cÚv
.
out_chªÃls
, 
dty³
=
tÜch
.
ušt8
)

36 
mask
[
f‹r_šdex
] = 0

37 
Ãw_cÚv
.
weight
.
d©a
 = 
cÚv
.weight.d©a[
mask
, :, :, :]

38 
cÚv
.
bŸs
 
is
 
nÙ
 
NÚe
:

39 
Ãw_cÚv
.
bŸs
.
d©a
 = 
cÚv
.bŸs.d©a[
mask
]

41 
–if
 
chªÃl_ty³
 == 'in':

42 
Ãw_cÚv
 = 
Â
.
	`CÚv2d
(
cÚv
.
š_chªÃls
 - 1, cÚv.
out_chªÃls
, cÚv.
k”Ãl_size
, cÚv.
¡ride
,

43 
cÚv
.
·ddšg
, cÚv.
d©iÚ
, cÚv.
groups
, cÚv.
bŸs
 
is
 
nÙ
 
NÚe
)

44 
mask
 = 
tÜch
.
	$Úes
(
cÚv
.
š_chªÃls
, 
dty³
=
tÜch
.
ušt8
)

45 
mask
[
f‹r_šdex
] = 0

46 
Ãw_cÚv
.
weight
.
d©a
 = 
cÚv
.weight.d©a[:, 
mask
, :, :]

47 
cÚv
.
bŸs
 
is
 
nÙ
 
NÚe
:

48 
Ãw_cÚv
.
bŸs
.
d©a
 = 
cÚv
.bias.data

50 
¿i£
 
	`V®ueE¼Ü
(
f
"{channel_type} should beƒither 'in' or 'out'.")

51  
Ãw_cÚv


53 
def
 
	$»move_cÚv_f‹r
(
£lf
, 
·th
, 
f‹r_šdex
):

54 
cÚv
 = 
£lf
.
book
.
	$g‘_moduË
(
·th
)

55 
loggšg
.
	`šfo
(
f
'Prune Conv: {"/".join(path)}, Filter: {filter_index}, Layer: {conv}')

56 
Ãw_cÚv
 = 
£lf
.
	`_make_Ãw_cÚv
(
cÚv
, 
f‹r_šdex
, 
chªÃl_ty³
="out")

57 
£lf
.
	$_upd©e_mod–
(
·th
, 
Ãw_cÚv
)

59 
Ãxt_cÚv_·th
 = 
£lf
.
desûnd’t_cÚvs
.
	$g‘
(
·th
)

60 
Ãxt_cÚv_·th
:

61 
Ãxt_cÚv
 = 
£lf
.
book
.
	$g‘_moduË
(
Ãxt_cÚv_·th
)

62 
Ãw_Ãxt_cÚv
 = 
£lf
.
	`_make_Ãw_cÚv
(
Ãxt_cÚv
, 
f‹r_šdex
, 
chªÃl_ty³
="in")

63 
£lf
.
	$_upd©e_mod–
(
Ãxt_cÚv_·th
, 
Ãw_Ãxt_cÚv
)

65 #»duû 
the
 
num_ã©u»s
 
of
 
b©ch
 
nÜm


66 
b©ch_nÜm_·th
 = 
£lf
.
deûnd’t_b©ch_nÜms
.
	$g‘
(
·th
)

67 
b©ch_nÜm_·th
:

68 
b©ch_nÜm
 = 
£lf
.
book
.
	$g‘_moduË
(
b©ch_nÜm_·th
)

69 
Ãw_b©ch_nÜm
 = 
Â
.
	`B©chNÜm2d
(
b©ch_nÜm
.
num_ã©u»s
 - 1)

70 
£lf
.
	$_upd©e_mod–
(
b©ch_nÜm_·th
, 
Ãw_b©ch_nÜm
)

72 #»duû 
the
 
š
 
chªÃls
 
of
 
lš—r
 
Ïy”


73 
lš—r_·th
 = 
£lf
.
desûnd’t_lš—rs
.
	$g‘
(
·th
)

74 
lš—r_·th
:

75 
lš—r
 = 
£lf
.
book
.
	$g‘_moduË
(
lš—r_·th
)

76 
Ãw_lš—r
 = 
£lf
.
	`_make_Ãw_lš—r
(
lš—r
, 
f‹r_šdex
, 
cÚv
, 
chªÃl_ty³
="in")

77 
£lf
.
	`_upd©e_mod–
(
lš—r_·th
, 
Ãw_lš—r
)

79 @
¡©icm‘hod


80 
def
 
	`_make_Ãw_lš—r
(
lš—r
, 
ã©u»_šdex
, 
cÚv
=
NÚe
, 
chªÃl_ty³
="out"):

81 
chªÃl_ty³
 == "out":

82 
Ãw_lš—r
 = 
Â
.
	`Lš—r
(
lš—r
.
š_ã©u»s
,†š—r.
out_ã©u»s
 - 1,

83 
bŸs
=
lš—r
.bŸ 
is
 
nÙ
 
NÚe
)

84 
mask
 = 
tÜch
.
	$Úes
(
lš—r
.
out_ã©u»s
, 
dty³
=
tÜch
.
ušt8
)

85 
mask
[
ã©u»_šdex
] = 0

86 
Ãw_lš—r
.
weight
.
d©a
 = 
lš—r
.weight.d©a[
mask
, :]

87 
lš—r
.
bŸs
 
is
 
nÙ
 
NÚe
:

88 
Ãw_lš—r
.
bŸs
.
d©a
 = 
lš—r
.bŸs.d©a[
mask
]

89 
–if
 
chªÃl_ty³
 == "in":

90 
cÚv
:

91 
block
 = (
lš—r
.
š_ã©u»s
 / 
cÚv
.
out_chªÃls
)

93 
block
 = 1

94 
Ãw_lš—r
 = 
Â
.
	`Lš—r
(
lš—r
.
š_ã©u»s
 - 
block
,†š—r.
out_ã©u»s
,

95 
bŸs
=
lš—r
.bŸ 
is
 
nÙ
 
NÚe
)

96 
¡¬t_šdex
 = 
ã©u»_šdex
 * 
block


97 
’d_šdex
 = (
ã©u»_šdex
 + 1è* 
block


98 
mask
 = 
tÜch
.
	$Úes
(
lš—r
.
š_ã©u»s
, 
dty³
=
tÜch
.
ušt8
)

99 
mask
[
¡¬t_šdex
: 
’d_šdex
] = 0

100 
Ãw_lš—r
.
weight
.
d©a
 = 
lš—r
.weight.d©a[:, 
mask
]

101 
lš—r
.
bŸs
 
is
 
nÙ
 
NÚe
:

102 
Ãw_lš—r
.
bŸs
.
d©a
 = 
lš—r
.bias.data

104 
¿i£
 
	`V®ueE¼Ü
(
f
"{channel_type} should beƒither 'in' or 'out'.")

105  
Ãw_lš—r


107 
def
 
	$´uÃ_cÚv_Ïy”s
(
£lf
, 
num
=1):

110 
£lf
.
	$»gi¡”_cÚv_hooks
()

111 
befÜe_loss
, 
befÜe_accu¿cy
 = 
£lf
.
	$Œaš_fun
(
£lf
.
mod–
)

112 
¿nks
 = []

113 
·th
, 
ouut
 
š
 
£lf
.
ouuts
.
	$™ems
():

114 
ouut
 = ouut.
d©a


115 
g¿d
 = 
£lf
.
g¿ds
[
·th
].
d©a


116 
v
 = 
g¿d
 * 
ouut


117 
v
 = v.
	`sum
(0).sum(1).
	$sum
(1è#sum 
to
 
the
 
chªÃl
 
axis
.

118 
v
 = 
tÜch
.
	$abs
(
v
)

119 
v
 = v / 
tÜch
.
	`sq¹
ÑÜch.
	$sum
(
v
 * v)) #normalize

120 
i
, 
e
 
š
 
	$’um”©e
(
v
):

121 
¿nks
.
	`­³nd
((
·th
, 
i
, 
e
))

122 
to_´uÃ
 = 
	$nsm®Ë¡
(
num
, 
¿nks
, 
key
=
Ïmbda
 
t
:[2])

123 
to_´uÃ
 = 
	`sÜ‹d
Ño_´uÃ, 
key
=
Ïmbda
 
t
: (t[0], -t[1])è#´uÃ 
the
 
f‹rs
 
w™h
 
bigg”
 
šdexes
 
fœ¡
 
to
 
avoid
 
»¬¿ngem’t
.

124 
·th
, 
f‹r_šdex
, 
v®ue
 
š
 
to_´uÃ
:

125 
£lf
.
	$»move_cÚv_f‹r
(
·th
, 
f‹r_šdex
)

126 
£lf
.
	$d”egi¡”_hooks
()

127 
aá”_loss
, 
aá”_accu¿cy
 = 
£lf
.
	$Œaš_fun
(
£lf
.
mod–
)

128  
aá”_loss
 - 
befÜe_loss
, 
aá”_accu¿cy
 - 
befÜe_accu¿cy


130 
def
 
	$»gi¡”_cÚv_hooks
(
£lf
):

132 
£lf
.
ouuts
.
	$ş—r
()

133 
£lf
.
g¿ds
.
	$ş—r
()

134 
£lf
.
hªdËs
.
	$ş—r
()

135 
£lf
.
Ï¡_cÚv_·th
 = 
NÚe


136 
£lf
.
deûnd’t_b©ch_nÜms
.
	$ş—r
()

137 
£lf
.
desûnd’t_cÚvs
.
	$ş—r
()

138 
£lf
.
desûnd’t_lš—rs
.
	$ş—r
()

140 
def
 
	$fÜw¬d_hook
(
m
, 
šput
, 
ouut
):

141 
·th
 = 
£lf
.
book
.
	$g‘_·th
(
m
)

142 
	$isš¡ªû
(
m
, 
Â
.
CÚv2d
):

143 
·th
 
nÙ
 
š
 
£lf
.
ignÜed_·ths
:

144 
£lf
.
ouuts
[
·th
] = 
ouut


145 
£lf
.
Ï¡_cÚv_·th
:

146 
£lf
.
desûnd’t_cÚvs
[£lf.
Ï¡_cÚv_·th
] = 
·th


147 
£lf
.
Ï¡_cÚv_·th
 = 
·th


148 
–if
 
	$isš¡ªû
(
m
, 
Â
.
B©chNÜm2d
):

149 
£lf
.
Ï¡_cÚv_·th
:

150 
£lf
.
deûnd’t_b©ch_nÜms
[£lf.
Ï¡_cÚv_·th
] = 
·th


151 
–if
 
	$isš¡ªû
(
m
, 
Â
.
Lš—r
):

152 
£lf
.
Ï¡_cÚv_·th
:

153 
£lf
.
desûnd’t_lš—rs
[£lf.
Ï¡_cÚv_·th
] = 
·th


154 
£lf
.
Ï¡_cÚv_·th
 = 
NÚe
 #aá” 
a
 
lš—r
 
Ïy”
 
the
 
cÚv
†ay” 
dÛ¢
't matter

156 
def
 
	$backw¬d_hook
(
m
, 
šput
, 
ouut
):

157 
·th
 = 
£lf
.
book
.
	$g‘_·th
(
m
)

158 
£lf
.
g¿ds
[
·th
] = 
ouut
[0]

160 
·th
, 
m
 
š
 
£lf
.
book
.
	`moduËs
(
moduË_ty³
=(
Â
.
CÚv2d
,‚n.
B©chNÜm2d
,‚n.
Lš—r
)):

161 
h
 = 
m
.
	$»gi¡”_fÜw¬d_hook
(
fÜw¬d_hook
)

162 
£lf
.
hªdËs
.
	$­³nd
(
h
)

163 
h
 = 
m
.
	$»gi¡”_backw¬d_hook
(
backw¬d_hook
)

164 
£lf
.
hªdËs
.
	$­³nd
(
h
)

166 
def
 
	$d”egi¡”_hooks
(
£lf
):

168 
hªdË
 
š
 
£lf
.
hªdËs
:

169 
hªdË
.
	$»move
()

171 
def
 
	$´uÃ_lš—r_Ïy”s
(
£lf
, 
num
=1):

172 
£lf
.
	$»gi¡”_lš—r_hooks
()

173 
befÜe_loss
, 
befÜe_accu¿cy
 = 
£lf
.
	$Œaš_fun
(
£lf
.
mod–
)

174 
¿nks
 = []

175 
·th
, 
ouut
 
š
 
£lf
.
ouuts
.
	$™ems
():

176 
ouut
 = ouut.
d©a


177 
g¿d
 = 
£lf
.
g¿ds
[
·th
].
d©a


178 
v
 = 
g¿d
 * 
ouut


179 
v
 = v.
	$sum
(0è#sum 
to
 
the
 
chªÃl
 
axis
.

180 
v
 = 
tÜch
.
	$abs
(
v
)

181 
v
 = v / 
tÜch
.
	`sq¹
ÑÜch.
	$sum
(
v
 * v)) #normalize

182 
i
, 
e
 
š
 
	$’um”©e
(
v
):

183 
¿nks
.
	`­³nd
((
·th
, 
i
, 
e
))

184 
to_´uÃ
 = 
	$nsm®Ë¡
(
num
, 
¿nks
, 
key
=
Ïmbda
 
t
:[2])

185 
to_´uÃ
 = 
	`sÜ‹d
Ño_´uÃ, 
key
=
Ïmbda
 
t
: (t[0], -t[1]))

186 
·th
, 
ã©u»_šdex
, 
v®ue
 
š
 
to_´uÃ
:

187 
£lf
.
	$»move_lš—r_ã©u»
(
·th
, 
ã©u»_šdex
)

188 
£lf
.
	$d”egi¡”_hooks
()

189 
aá”_loss
, 
aá”_accu¿cy
 = 
£lf
.
	$Œaš_fun
(
£lf
.
mod–
)

190  
aá”_loss
 - 
befÜe_loss
, 
aá”_accu¿cy
 - 
befÜe_accu¿cy


192 
def
 
	$»gi¡”_lš—r_hooks
(
£lf
):

193 
£lf
.
ouuts
.
	$ş—r
()

194 
£lf
.
g¿ds
.
	$ş—r
()

195 
£lf
.
hªdËs
.
	$ş—r
()

196 
£lf
.
desûnd’t_lš—rs
.
	$ş—r
()

197 
£lf
.
Ï¡_lš—r_·th
 = 
NÚe


199 
def
 
	$fÜw¬d_hook
(
m
, 
šput
, 
ouut
):

200 
·th
 = 
£lf
.
book
.
	$g‘_·th
(
m
)

201 
·th
 
nÙ
 
š
 
£lf
.
ignÜed_·ths
:

202 
£lf
.
ouuts
[
·th
] = 
ouut


203 
£lf
.
Ï¡_lš—r_·th
:

204 
£lf
.
desûnd’t_lš—rs
[£lf.
Ï¡_lš—r_·th
] = 
·th


205 
£lf
.
Ï¡_lš—r_·th
 = 
·th


207 
def
 
	$backw¬d_hook
(
m
, 
šput
, 
ouut
):

208 
·th
 = 
£lf
.
book
.
	$g‘_·th
(
m
)

209 
£lf
.
g¿ds
[
·th
] = 
ouut
[0]

211 
_
, 
m
 
š
 
£lf
.
book
.
	$lš—r_moduËs
():

212 
h
 = 
m
.
	$»gi¡”_fÜw¬d_hook
(
fÜw¬d_hook
)

213 
£lf
.
hªdËs
.
	$­³nd
(
h
)

214 
h
 = 
m
.
	$»gi¡”_backw¬d_hook
(
backw¬d_hook
)

215 
£lf
.
hªdËs
.
	$­³nd
(
h
)

217 
def
 
	$»move_lš—r_ã©u»
(
£lf
, 
·th
, 
ã©u»_šdex
):

218 
lš—r
 = 
£lf
.
book
.
	$g‘_moduË
(
·th
)

219 
loggšg
.
	`šfo
(
f
'Prune Linear: {"/".join(path)}, Filter: {feature_index}, Layer: {linear}')

220 
Ãw_lš—r
 = 
£lf
.
	`_make_Ãw_lš—r
(
lš—r
, 
ã©u»_šdex
, 
chªÃl_ty³
="out")

221 
£lf
.
	$_upd©e_mod–
(
·th
, 
Ãw_lš—r
)

223 #upd©
fŞlowšg
 
lš—r
 
Ïy”s


224 
Ãxt_lš—r_·th
 = 
£lf
.
desûnd’t_lš—rs
.
	$g‘
(
·th
)

225 
Ãxt_lš—r_·th
:

226 
Ãxt_lš—r
 = 
£lf
.
book
.
	$g‘_moduË
(
Ãxt_lš—r_·th
)

227 
Ãw_Ãxt_lš—r
 = 
£lf
.
	`_make_Ãw_lš—r
(
Ãxt_lš—r
, 
ã©u»_šdex
, 
chªÃl_ty³
='in')

228 
£lf
.
	$_upd©e_mod–
(
Ãxt_lš—r_·th
, 
Ãw_Ãxt_lš—r
)

230 
def
 
	$_upd©e_mod–
(
£lf
, 
·th
, 
moduË
):

231 
·»Á
 = 
£lf
.
book
.
	`g‘_moduË
(
·th
[:-1])

232 
·»Á
.
_moduËs
[
·th
[-1]] = 
moduË


233 
£lf
.
book
.
	`upd©e
(
·th
, 
moduË
)

	@vision/ssd/__init__.py

	@vision/ssd/config/__init__.py

	@vision/ssd/config/mobilenetv1_ssd_config.py

1 
impÜt
 
numpy
 
as
 
Å


3 
äom
 
	gvisiÚ
.
	guts
.
box_uts
 
impÜt
 
	gSSDS³c
, 
	gSSDBoxSizes
, 
g’”©e_ssd_´iÜs


6 
	gimage_size
 = 300

7 
image_m—n
 = 
Å
.
	$¬¿y
([127, 127, 127]è#RGB 
Ïyout


8 
image_¡d
 = 128.0

9 
iou_th»shŞd
 = 0.45

10 
ûÁ”_v¬Ÿnû
 = 0.1

11 
size_v¬Ÿnû
 = 0.2

13 
¥ecs
 = [

14 
	`SSDS³c
(19, 16, 
	`SSDBoxSizes
(60, 105), [2, 3]),

15 
	`SSDS³c
(10, 32, 
	`SSDBoxSizes
(105, 150), [2, 3]),

16 
	`SSDS³c
(5, 64, 
	`SSDBoxSizes
(150, 195), [2, 3]),

17 
	`SSDS³c
(3, 100, 
	`SSDBoxSizes
(195, 240), [2, 3]),

18 
	`SSDS³c
(2, 150, 
	`SSDBoxSizes
(240, 285), [2, 3]),

19 
	`SSDS³c
(1, 300, 
	`SSDBoxSizes
(285, 330), [2, 3])

23 
´iÜs
 = 
	`g’”©e_ssd_´iÜs
(
¥ecs
, 
image_size
)

	@vision/ssd/config/squeezenet_ssd_config.py

1 
impÜt
 
numpy
 
as
 
Å


3 
äom
 
	gvisiÚ
.
	guts
.
box_uts
 
impÜt
 
	gSSDS³c
, 
	gSSDBoxSizes
, 
g’”©e_ssd_´iÜs


6 
	gimage_size
 = 300

7 
image_m—n
 = 
Å
.
	$¬¿y
([127, 127, 127]è#RGB 
Ïyout


8 
image_¡d
 = 128.0

9 
iou_th»shŞd
 = 0.45

10 
ûÁ”_v¬Ÿnû
 = 0.1

11 
size_v¬Ÿnû
 = 0.2

13 
¥ecs
 = [

14 
	`SSDS³c
(17, 16, 
	`SSDBoxSizes
(60, 105), [2, 3]),

15 
	`SSDS³c
(10, 32, 
	`SSDBoxSizes
(105, 150), [2, 3]),

16 
	`SSDS³c
(5, 64, 
	`SSDBoxSizes
(150, 195), [2, 3]),

17 
	`SSDS³c
(3, 100, 
	`SSDBoxSizes
(195, 240), [2, 3]),

18 
	`SSDS³c
(2, 150, 
	`SSDBoxSizes
(240, 285), [2, 3]),

19 
	`SSDS³c
(1, 300, 
	`SSDBoxSizes
(285, 330), [2, 3])

23 
´iÜs
 = 
	`g’”©e_ssd_´iÜs
(
¥ecs
, 
image_size
)

	@vision/ssd/config/vgg_ssd_config.py

1 
impÜt
 
numpy
 
as
 
Å


3 
äom
 
	gvisiÚ
.
	guts
.
box_uts
 
impÜt
 
	gSSDS³c
, 
	gSSDBoxSizes
, 
g’”©e_ssd_´iÜs


6 
	gimage_size
 = 300

7 
image_m—n
 = 
Å
.
	$¬¿y
([123, 117, 104]è#RGB 
Ïyout


8 
image_¡d
 = 1.0

10 
iou_th»shŞd
 = 0.45

11 
ûÁ”_v¬Ÿnû
 = 0.1

12 
size_v¬Ÿnû
 = 0.2

14 
¥ecs
 = [

15 
	`SSDS³c
(38, 8, 
	`SSDBoxSizes
(30, 60), [2]),

16 
	`SSDS³c
(19, 16, 
	`SSDBoxSizes
(60, 111), [2, 3]),

17 
	`SSDS³c
(10, 32, 
	`SSDBoxSizes
(111, 162), [2, 3]),

18 
	`SSDS³c
(5, 64, 
	`SSDBoxSizes
(162, 213), [2, 3]),

19 
	`SSDS³c
(3, 100, 
	`SSDBoxSizes
(213, 264), [2]),

20 
	`SSDS³c
(1, 300, 
	`SSDBoxSizes
(264, 315), [2])

24 
´iÜs
 = 
	`g’”©e_ssd_´iÜs
(
¥ecs
, 
image_size
)

	@vision/ssd/data_preprocessing.py

1 
	gäom
 ..
	gŒªsfÜms
.
ŒªsfÜms
 
impÜt
 *

4 
şass
 
	gT¿šAugm’tiÚ
:

5 
def
 
	$__š™__
(
£lf
, 
size
, 
m—n
=0, 
¡d
=1.0):

7 
Args
:

8 
size
: 
the
 sizth
of
 
fš®
 
image
.

9 
m—n
: m—À
pix–
 
v®ue
 
³r
 
chªÃl
.

11 
£lf
.
m—n
 = mean

12 
£lf
.
size
 = size

13 
£lf
.
augm’t
 = 
	`Compo£
([

14 
	`CÚv”tFromIÁs
(),

15 
	`PhÙom‘ricDi¡Üt
(),

16 
	`Ex·nd
(
£lf
.
m—n
),

17 
	`RªdomSam¶eCrİ
(),

18 
	`RªdomMœrÜ
(),

19 
	`ToP”ûÁCoÜds
(),

20 
	`Resize
(
£lf
.
size
),

21 
	`SubŒaùM—ns
(
£lf
.
m—n
),

22 
Ïmbda
 
img
, 
boxes
=
NÚe
, 
Ïb–s
=NÚe: (img / 
¡d
, boxes,†abels),

23 
	`ToT’sÜ
(),

26 
def
 
	$__ÿÎ__
(
£lf
, 
img
, 
boxes
, 
Ïb–s
):

29 
Args
:

30 
img
: 
the
 
ouut
 
of
 
cv
.
im»ad
 
š
 
RGB
 
Ïyout
.

31 
boxes
: 
bounddšg
 boxe 
š
 
the
 
fÜm
 
	`of
 (
x1
, 
y1
, 
x2
, 
y2
).

32 
Ïb–s
:†ab– 
of
 
boxes
.

34  
£lf
.
	$augm’t
(
img
, 
boxes
, 
Ïb–s
)

37 
şass
 
Te¡T¿nsfÜm
:

38 
def
 
	$__š™__
(
£lf
, 
size
, 
m—n
=0.0, 
¡d
=1.0):

39 
£lf
.
ŒªsfÜm
 = 
	`Compo£
([

40 
	`ToP”ûÁCoÜds
(),

41 
	`Resize
(
size
),

42 
	`SubŒaùM—ns
(
m—n
),

43 
Ïmbda
 
img
, 
boxes
=
NÚe
, 
Ïb–s
=NÚe: (img / 
¡d
, boxes,†abels),

44 
	`ToT’sÜ
(),

47 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
, 
Ïb–s
):

48  
£lf
.
	$ŒªsfÜm
(
image
, 
boxes
, 
Ïb–s
)

51 
şass
 
P»diùiÚT¿nsfÜm
:

52 
def
 
	$__š™__
(
£lf
, 
size
, 
m—n
=0.0, 
¡d
=1.0):

53 
£lf
.
ŒªsfÜm
 = 
	`Compo£
([

54 
	`Resize
(
size
),

55 
	`SubŒaùM—ns
(
m—n
),

56 
Ïmbda
 
img
, 
boxes
=
NÚe
, 
Ïb–s
=NÚe: (img / 
¡d
, boxes,†abels),

57 
	`ToT’sÜ
()

60 
def
 
	$__ÿÎ__
(
£lf
, 
image
):

61 
image
, 
_
, _ = 
£lf
.
	$ŒªsfÜm
(
image
)

	@vision/ssd/fpn_mobilenetv1_ssd.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
ReLU


3 
	gäom
 ..
	gÂ
.
mob’‘
 
impÜt
 
MobeN‘V1


5 
	gäom
 .
ån_ssd
 
impÜt
 
FPNSSD


6 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


7 
	gäom
 .
cÚfig
 
impÜt
 
mob’‘v1_ssd_cÚfig
 
as
 config

10 
def
 
	$ü—‹_ån_mob’‘v1_ssd
(
num_şas£s
):

11 
ba£_Ãt
 = 
	`MobeN‘V1
(1001).
ã©u»s
 #di§bË 
drİout
 
Ïy”


13 
sourû_Ïy”_šdexes
 = [

14 (69, 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=256, 
k”Ãl_size
=1)),

15 (
	`Ën
(
ba£_Ãt
), 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=256, 
k”Ãl_size
=1)),

17 
exŒas
 = 
	`ModuËLi¡
([

18 
	`Sequ’tŸl
(

19 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=256, 
k”Ãl_size
=1),

20 
	`ReLU
(),

21 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

22 
	`ReLU
()

24 
	`Sequ’tŸl
(

25 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

26 
	`ReLU
(),

27 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

28 
	`ReLU
()

30 
	`Sequ’tŸl
(

31 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

32 
	`ReLU
(),

33 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

34 
	`ReLU
()

36 
	`Sequ’tŸl
(

37 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

38 
	`ReLU
(),

39 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

40 
	`ReLU
()

44 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

45 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

46 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

47 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

48 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

49 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

50 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

53 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

54 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

55 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

56 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

57 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

58 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

59 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

62  
	$FPNSSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

63 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
)

66 
def
 
	`ü—‹_ån_mob’‘v1_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=
tÜch
.
	`deviû
('cpu')):

67 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
, cÚfig.
´iÜs
,

68 
cÚfig
.
ûÁ”_v¬Ÿnû
, cÚfig.
size_v¬Ÿnû
,

69 
nms_m‘hod
=nms_method,

70 
iou_th»shŞd
=
cÚfig
.iou_threshold,

71 
ÿndid©e_size
=candidate_size,

72 
sigma
=sigma,

73 
deviû
=device)

74  
´ediùÜ


	@vision/ssd/fpn_ssd.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
tÜch


3 
impÜt
 
	gtÜch
.
	gÂ
.
funùiÚ®
 
as
 
F


4 
impÜt
 
numpy
 
as
 
Å


5 
äom
 
typšg
 
impÜt
 
	gLi¡
, 
Tu¶e


7 
	gäom
 ..
uts
 
impÜt
 
box_uts


10 
şass
 
	$FPNSSD
(
Â
.
ModuË
):

11 
def
 
	`__š™__
(
£lf
, 
num_şas£s
: , 
ba£_Ãt
: 
Â
.
ModuËLi¡
, 
sourû_Ïy”_šdexes
: 
Li¡
[],

12 
exŒas
: 
Â
.
ModuËLi¡
, 
şassifiÿtiÚ_h—d”s
:‚n.ModuleList,

13 
»g»ssiÚ_h—d”s
: 
Â
.
ModuËLi¡
, 
up§m¶e_mode
="nearest"):

16 
	`su³r
(
FPNSSD
, 
£lf
).
	$__š™__
()

18 
£lf
.
num_şas£s
 =‚um_classes

19 
£lf
.
ba£_Ãt
 = base_net

20 
£lf
.
sourû_Ïy”_šdexes
 = source_layer_indexes

21 
£lf
.
exŒas
 =ƒxtras

22 
£lf
.
şassifiÿtiÚ_h—d”s
 = classification_headers

23 
£lf
.
»g»ssiÚ_h—d”s
 =„egression_headers

24 
£lf
.
up§m¶e_mode
 = upsample_mode

26 #»gi¡” 
Ïy”s
 
š
 
sourû_Ïy”_šdexes
 
by
 
addšg
 
them
 
to
 
a
 
moduË
 
li¡


27 
£lf
.
sourû_Ïy”_add_Ús
 = 
Â
.
	`ModuËLi¡
([
t
[1] ˆ
š
 
sourû_Ïy”_šdexes
 
	`isš¡ªû
Ñ, 
tu¶e
)])

28 
£lf
.
up§m¶”s
 = [

29 
Â
.
	`Up§m¶e
(
size
=(19, 19), 
mode
='bilinear'),

30 
Â
.
	`Up§m¶e
(
size
=(10, 10), 
mode
='bilinear'),

31 
Â
.
	`Up§m¶e
(
size
=(5, 5), 
mode
='bilinear'),

32 
Â
.
	`Up§m¶e
(
size
=(3, 3), 
mode
='bilinear'),

33 
Â
.
	`Up§m¶e
(
size
=(2, 2), 
mode
='bilinear'),

36 
def
 
	`fÜw¬d
(
£lf
, 
x
: 
tÜch
.
T’sÜ
è-> 
Tu¶e
[torch.Tensor,orch.Tensor]:

37 
cÚfid’ûs
 = []

38 
loÿtiÚs
 = []

39 
¡¬t_Ïy”_šdex
 = 0

40 
h—d”_šdex
 = 0

41 
ã©u»s
 = []

42 
’d_Ïy”_šdex
 
š
 
£lf
.
sourû_Ïy”_šdexes
:

44 
	$isš¡ªû
(
’d_Ïy”_šdex
, 
tu¶e
):

45 
added_Ïy”
 = 
’d_Ïy”_šdex
[1]

46 
’d_Ïy”_šdex
 =ƒnd_layer_index[0]

48 
added_Ïy”
 = 
NÚe


49 
Ïy”
 
š
 
£lf
.
ba£_Ãt
[
¡¬t_Ïy”_šdex
: 
’d_Ïy”_šdex
]:

50 
x
 = 
	$Ïy”
(
x
)

51 
¡¬t_Ïy”_šdex
 = 
’d_Ïy”_šdex


52 
added_Ïy”
:

53 
y
 = 
	$added_Ïy”
(
x
)

55 
y
 = 
x


56 #cÚfid’û, 
loÿtiÚ
 = 
£lf
.
	`compu‹_h—d”
(
h—d”_šdex
, 
y
)

57 
ã©u»s
.
	$­³nd
(
y
)

58 
h—d”_šdex
 += 1

59 #cÚfid’ûs.
	`­³nd
(
cÚfid’û
)

60 #loÿtiÚs.
	`­³nd
(
loÿtiÚ
)

62 
Ïy”
 
š
 
£lf
.
ba£_Ãt
[
’d_Ïy”_šdex
:]:

63 
x
 = 
	$Ïy”
(
x
)

65 
Ïy”
 
š
 
£lf
.
exŒas
:

66 
x
 = 
	$Ïy”
(
x
)

67 #cÚfid’û, 
loÿtiÚ
 = 
£lf
.
	`compu‹_h—d”
(
h—d”_šdex
, 
x
)

68 
ã©u»s
.
	$­³nd
(
x
)

69 
h—d”_šdex
 += 1

70 #cÚfid’ûs.
	`­³nd
(
cÚfid’û
)

71 #loÿtiÚs.
	`­³nd
(
loÿtiÚ
)

73 
up¡»am_ã©u»
 = 
NÚe


74 
i
 
š
 
	`¿nge
(
	`Ën
(
ã©u»s
) - 1, -1, -1):

75 
ã©u»
 = 
ã©u»s
[
i
]

76 
up¡»am_ã©u»
 
is
 
nÙ
 
NÚe
:

77 
up¡»am_ã©u»
 = 
£lf
.
up§m¶”s
[
i
](upstream_feature)

78 
up¡»am_ã©u»
 +ğ
ã©u»


80 
up¡»am_ã©u»
 = 
ã©u»


81 
cÚfid’û
, 
loÿtiÚ
 = 
£lf
.
	$compu‹_h—d”
(
i
, 
up¡»am_ã©u»
)

82 
cÚfid’ûs
.
	$­³nd
(
cÚfid’û
)

83 
loÿtiÚs
.
	$­³nd
(
loÿtiÚ
)

84 
cÚfid’ûs
 = 
tÜch
.
	$ÿt
(
cÚfid’ûs
, 1)

85 
loÿtiÚs
 = 
tÜch
.
	$ÿt
(
loÿtiÚs
, 1)

86  
cÚfid’ûs
, 
loÿtiÚs


88 
def
 
	$compu‹_h—d”
(
£lf
, 
i
, 
x
):

89 
cÚfid’û
 = 
£lf
.
şassifiÿtiÚ_h—d”s
[
i
](
x
)

90 
cÚfid’û
 = cÚfid’û.
	`³rmu‹
(0, 2, 3, 1).
	$cÚtiguous
()

91 
cÚfid’û
 = cÚfid’û.
	`v›w
(cÚfid’û.
	`size
(0), -1, 
£lf
.
num_şas£s
)

93 
loÿtiÚ
 = 
£lf
.
»g»ssiÚ_h—d”s
[
i
](
x
)

94 
loÿtiÚ
 =†oÿtiÚ.
	`³rmu‹
(0, 2, 3, 1).
	$cÚtiguous
()

95 
loÿtiÚ
 =†oÿtiÚ.
	`v›w
ÖoÿtiÚ.
	`size
(0), -1, 4)

97  
cÚfid’û
, 
loÿtiÚ


99 
def
 
	$š™_äom_ba£_Ãt
(
£lf
, 
mod–
):

100 
£lf
.
ba£_Ãt
.
	`lßd_¡©e_diù
(
tÜch
.
	`lßd
(
mod–
, 
m­_loÿtiÚ
=
Ïmbda
 
¡Üage
, 
loc
: stÜage), 
¡riù
=
F®£
)

101 
£lf
.
sourû_Ïy”_add_Ús
.
	$­¶y
(
_xav›r_š™_
)

102 
£lf
.
exŒas
.
	$­¶y
(
_xav›r_š™_
)

103 
£lf
.
şassifiÿtiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

104 
£lf
.
»g»ssiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

106 
def
 
	$š™
(
£lf
):

107 
£lf
.
ba£_Ãt
.
	$­¶y
(
_xav›r_š™_
)

108 
£lf
.
sourû_Ïy”_add_Ús
.
	$­¶y
(
_xav›r_š™_
)

109 
£lf
.
exŒas
.
	$­¶y
(
_xav›r_š™_
)

110 
£lf
.
şassifiÿtiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

111 
£lf
.
»g»ssiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

113 
def
 
	$lßd
(
£lf
, 
mod–
):

114 
£lf
.
	`lßd_¡©e_diù
(
tÜch
.
	$lßd
(
mod–
, 
m­_loÿtiÚ
=
Ïmbda
 
¡Üage
, 
loc
: storage))

116 
def
 
	$§ve
(
£lf
, 
mod–_·th
):

117 
tÜch
.
	`§ve
(
£lf
.
	`¡©e_diù
(), 
mod–_·th
)

120 
şass
 
	$M©chPriÜ
(
objeù
):

121 
def
 
	$__š™__
(
£lf
, 
ûÁ”_fÜm_´iÜs
, 
ûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû
, 
iou_th»shŞd
):

122 
£lf
.
ûÁ”_fÜm_´iÜs
 = center_form_priors

123 
£lf
.
cÜÃr_fÜm_´iÜs
 = 
box_uts
.
	$ûÁ”_fÜm_to_cÜÃr_fÜm
(
ûÁ”_fÜm_´iÜs
)

124 
£lf
.
ûÁ”_v¬Ÿnû
 = center_variance

125 
£lf
.
size_v¬Ÿnû
 = size_variance

126 
£lf
.
iou_th»shŞd
 = iou_threshold

128 
def
 
	$__ÿÎ__
(
£lf
, 
gt_boxes
, 
gt_Ïb–s
):

129 
	$ty³
(
gt_boxes
è
is
 
Å
.
nd¬¿y
:

130 
gt_boxes
 = 
tÜch
.
	$äom_numpy
(
gt_boxes
)

131 
	$ty³
(
gt_Ïb–s
è
is
 
Å
.
nd¬¿y
:

132 
gt_Ïb–s
 = 
tÜch
.
	$äom_numpy
(
gt_Ïb–s
)

133 
boxes
, 
Ïb–s
 = 
box_uts
.
	$assign_´iÜs
(
gt_boxes
, 
gt_Ïb–s
,

134 
£lf
.
cÜÃr_fÜm_´iÜs
, s–f.
iou_th»shŞd
)

135 
boxes
 = 
box_uts
.
	$cÜÃr_fÜm_to_ûÁ”_fÜm
(
boxes
)

136 
loÿtiÚs
 = 
box_uts
.
	$cÚv”t_boxes_to_loÿtiÚs
(
boxes
, 
£lf
.
ûÁ”_fÜm_´iÜs
, s–f.
ûÁ”_v¬Ÿnû
, s–f.
size_v¬Ÿnû
)

137  
loÿtiÚs
, 
Ïb–s


140 
def
 
	$_xav›r_š™_
(
m
: 
Â
.
ModuË
):

141 
	$isš¡ªû
(
m
, 
Â
.
CÚv2d
):

142 
Â
.
š™
.
	`xav›r_unifÜm_
(
m
.
weight
)

	@vision/ssd/mobilenet_v2_ssd_lite.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
B©chNÜm2d


3 
äom
 
tÜch
 
impÜt
 
Â


4 
	gäom
 ..
	gÂ
.
mob’‘_v2
 
impÜt
 
	gMobeN‘V2
, 
Inv”‹dResidu®


6 
	gäom
 .
ssd
 
impÜt
 
	gSSD
, 
G¿phP©h


7 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


8 
	gäom
 .
cÚfig
 
impÜt
 
mob’‘v1_ssd_cÚfig
 
as
 config

11 
def
 
	$S•”abËCÚv2d
(
š_chªÃls
, 
out_chªÃls
, 
k”Ãl_size
=1, 
¡ride
=1, 
·ddšg
=0, 
Únx_com·tibË
=
F®£
):

14 
ReLU
 = 
Â
.ReLU 
Únx_com·tibË
 Â.
ReLU6


15  
	`Sequ’tŸl
(

16 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=š_chªÃls, 
k”Ãl_size
=kernel_size,

17 
groups
=
š_chªÃls
, 
¡ride
=¡ride, 
·ddšg
=padding),

18 
	`B©chNÜm2d
(
š_chªÃls
),

19 
	`ReLU
(),

20 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=out_chªÃls, 
k”Ãl_size
=1),

24 
def
 
	$ü—‹_mob’‘v2_ssd_l™e
(
num_şas£s
, 
width_muÉ
=1.0, 
u£_b©ch_nÜm
=
True
, 
Únx_com·tibË
=
F®£
, 
is_‹¡
=False):

25 
ba£_Ãt
 = 
	`MobeN‘V2
(
width_muÉ
=width_muÉ, 
u£_b©ch_nÜm
=use_batch_norm,

26 
Únx_com·tibË
=Únx_com·tibË).
ã©u»s


28 
sourû_Ïy”_šdexes
 = [

29 
	`G¿phP©h
(14, 'conv', 3),

32 
exŒas
 = 
	`ModuËLi¡
([

33 
	`Inv”‹dResidu®
(1280, 512, 
¡ride
=2, 
ex·nd_¿tio
=0.2),

34 
	`Inv”‹dResidu®
(512, 256, 
¡ride
=2, 
ex·nd_¿tio
=0.25),

35 
	`Inv”‹dResidu®
(256, 256, 
¡ride
=2, 
ex·nd_¿tio
=0.5),

36 
	`Inv”‹dResidu®
(256, 64, 
¡ride
=2, 
ex·nd_¿tio
=0.25)

38 #DISTANCE 
CHANGE


39 
num_di¡_chªÃls
 = 1

41 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

42 
	`S•”abËCÚv2d
(
š_chªÃls
=
	`round
(576 * 
width_muÉ
), 
out_chªÃls
=6 * 4,

43 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

44 
	`S•”abËCÚv2d
(
š_chªÃls
=1280, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

45 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

46 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

47 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

48 
	`CÚv2d
(
š_chªÃls
=64, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=1),

49 
	`S•”abËCÚv2d
(
š_chªÃls
=
	`round
(576 * 
width_muÉ
), 
out_chªÃls
=6 * 
num_di¡_chªÃls
,

50 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
F®£
),

51 #DISTANCE 
CHANGE


52 
	`S•”abËCÚv2d
(
š_chªÃls
=1280, 
out_chªÃls
=6 * 
num_di¡_chªÃls
, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
True
),

53 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_di¡_chªÃls
, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
True
),

54 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_di¡_chªÃls
, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
True
),

55 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_di¡_chªÃls
, 
k”Ãl_size
=3, 
·ddšg
=1, 
Únx_com·tibË
=
True
),

56 
	`CÚv2d
(
š_chªÃls
=64, 
out_chªÃls
=6 * 
num_di¡_chªÃls
, 
k”Ãl_size
=1),

60 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

61 
	`S•”abËCÚv2d
(
š_chªÃls
=
	`round
(576 * 
width_muÉ
), 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

62 
	`S•”abËCÚv2d
(
š_chªÃls
=1280, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

63 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

64 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

65 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

66 
	`CÚv2d
(
š_chªÃls
=64, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=1),

69  
	$SSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

70 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
, 
is_‹¡
=is_‹¡, 
cÚfig
=config)

73 
def
 
	`ü—‹_mob’‘v2_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=
tÜch
.
	`deviû
('cpu')):

74 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
,

75 
cÚfig
.
image_¡d
,

76 
nms_m‘hod
=nms_method,

77 
iou_th»shŞd
=
cÚfig
.iou_threshold,

78 
ÿndid©e_size
=candidate_size,

79 
sigma
=sigma,

80 
deviû
=device)

81  
´ediùÜ


	@vision/ssd/mobilenetv1_ssd.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
ReLU


3 
	gäom
 ..
	gÂ
.
mob’‘
 
impÜt
 
MobeN‘V1


5 
	gäom
 .
ssd
 
impÜt
 
SSD


6 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


7 
	gäom
 .
cÚfig
 
impÜt
 
mob’‘v1_ssd_cÚfig
 
as
 config

10 
def
 
	$ü—‹_mob’‘v1_ssd
(
num_şas£s
, 
is_‹¡
=
F®£
):

11 
ba£_Ãt
 = 
	`MobeN‘V1
(1001).
mod–
 #di§bË 
drİout
 
Ïy”


13 
sourû_Ïy”_šdexes
 = [

17 
exŒas
 = 
	`ModuËLi¡
([

18 
	`Sequ’tŸl
(

19 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=256, 
k”Ãl_size
=1),

20 
	`ReLU
(),

21 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=512, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

22 
	`ReLU
()

24 
	`Sequ’tŸl
(

25 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=128, 
k”Ãl_size
=1),

26 
	`ReLU
(),

27 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

28 
	`ReLU
()

30 
	`Sequ’tŸl
(

31 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

32 
	`ReLU
(),

33 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

34 
	`ReLU
()

36 
	`Sequ’tŸl
(

37 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

38 
	`ReLU
(),

39 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

40 
	`ReLU
()

44 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

45 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

46 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

47 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

48 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

49 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

50 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

53 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

54 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

55 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

56 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

57 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

58 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

59 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

62  
	$SSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

63 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
, 
is_‹¡
=is_‹¡, 
cÚfig
=config)

66 
def
 
	$ü—‹_mob’‘v1_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=None):

67 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
,

68 
cÚfig
.
image_¡d
,

69 
nms_m‘hod
=nms_method,

70 
iou_th»shŞd
=
cÚfig
.iou_threshold,

71 
ÿndid©e_size
=candidate_size,

72 
sigma
=sigma,

73 
deviû
=device)

74  
´ediùÜ


	@vision/ssd/mobilenetv1_ssd_lite.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
	gReLU
, 
B©chNÜm2d


3 
	gäom
 ..
	gÂ
.
mob’‘
 
impÜt
 
MobeN‘V1


5 
	gäom
 .
ssd
 
impÜt
 
SSD


6 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


7 
	gäom
 .
cÚfig
 
impÜt
 
mob’‘v1_ssd_cÚfig
 
as
 config

10 
def
 
	$S•”abËCÚv2d
(
š_chªÃls
, 
out_chªÃls
, 
k”Ãl_size
=1, 
¡ride
=1, 
·ddšg
=0):

13  
	`Sequ’tŸl
(

14 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=š_chªÃls, 
k”Ãl_size
=kernel_size,

15 
groups
=
š_chªÃls
, 
¡ride
=¡ride, 
·ddšg
=padding),

16 
	`ReLU
(),

17 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=out_chªÃls, 
k”Ãl_size
=1),

21 
def
 
	$ü—‹_mob’‘v1_ssd_l™e
(
num_şas£s
, 
is_‹¡
=
F®£
):

22 
ba£_Ãt
 = 
	`MobeN‘V1
(1001).
mod–
 #di§bË 
drİout
 
Ïy”


24 
sourû_Ïy”_šdexes
 = [

28 
exŒas
 = 
	`ModuËLi¡
([

29 
	`Sequ’tŸl
(

30 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=256, 
k”Ãl_size
=1),

31 
	`ReLU
(),

32 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=512, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

34 
	`Sequ’tŸl
(

35 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=128, 
k”Ãl_size
=1),

36 
	`ReLU
(),

37 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

39 
	`Sequ’tŸl
(

40 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

41 
	`ReLU
(),

42 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

44 
	`Sequ’tŸl
(

45 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

46 
	`ReLU
(),

47 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1)

51 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

52 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

53 
	`S•”abËCÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

54 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

55 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

56 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

57 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=1),

60 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

61 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

62 
	`S•”abËCÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

63 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

64 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

65 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

66 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=1),

69  
	$SSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

70 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
, 
is_‹¡
=is_‹¡, 
cÚfig
=config)

73 
def
 
	$ü—‹_mob’‘v1_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=None):

74 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
,

75 
cÚfig
.
image_¡d
,

76 
nms_m‘hod
=nms_method,

77 
iou_th»shŞd
=
cÚfig
.iou_threshold,

78 
ÿndid©e_size
=candidate_size,

79 
sigma
=sigma,

80 
deviû
=device)

81  
´ediùÜ


	@vision/ssd/predictor.py

1 
impÜt
 
tÜch


3 
	gäom
 ..
uts
 
impÜt
 
box_uts


4 
	gäom
 .
d©a_´•roûssšg
 
impÜt
 
P»diùiÚT¿nsfÜm


5 
	gäom
 ..
	guts
.
misc
 
impÜt
 
Tim”


8 
şass
 
	gP»diùÜ
:

9 
def
 
	$__š™__
(
£lf
, 
Ãt
, 
size
, 
m—n
=0.0, 
¡d
=1.0, 
nms_m‘hod
=
NÚe
,

10 
iou_th»shŞd
=0.45, 
f‹r_th»shŞd
=0.01, 
ÿndid©e_size
=200, 
sigma
=0.5, 
deviû
=
NÚe
):

11 
£lf
.
Ãt
 =‚et

12 
£lf
.
ŒªsfÜm
 = 
	$P»diùiÚT¿nsfÜm
(
size
, 
m—n
, 
¡d
)

13 
£lf
.
iou_th»shŞd
 = iou_threshold

14 
£lf
.
f‹r_th»shŞd
 = filter_threshold

15 
£lf
.
ÿndid©e_size
 = candidate_size

16 
£lf
.
nms_m‘hod
 =‚ms_method

18 
£lf
.
sigma
 = sigma

19 
deviû
:

20 
£lf
.
deviû
 = device

22 
£lf
.
deviû
 = 
tÜch
.
	`deviû
("cuda:0" tÜch.
cuda
.
	$is_avaabË
() "cpu")

24 
£lf
.
Ãt
.
	$to
(
£lf
.
deviû
)

25 
£lf
.
Ãt
.
	$ev®
()

27 
£lf
.
tim”
 = 
	$Tim”
()

29 
def
 
	`´ediù
(
£lf
, 
image
, 
tİ_k
=-1, 
´ob_th»shŞd
=
NÚe
):

30 
ıu_deviû
 = 
tÜch
.
	`deviû
("cpu")

31 
height
, 
width
, 
_
 = 
image
.
sh­e


32 
image
 = 
£lf
.
	$ŒªsfÜm
(
image
)

33 
images
 = 
image
.
	$unsqu“ze
(0)

34 
images
 = images.
	$to
(
£lf
.
deviû
)

35 
w™h
 
tÜch
.
	$no_g¿d
():

36 
£lf
.
tim”
.
	$¡¬t
()

37 
scÜes
, 
boxes
 = 
£lf
.
Ãt
.
	$fÜw¬d
(
images
)

38 
	`´št
("Inã»nûime: ", 
£lf
.
tim”
.
	$’d
())

39 
boxes
 = boxes[0]

40 
scÜes
 = scores[0]

41 
nÙ
 
´ob_th»shŞd
:

42 
´ob_th»shŞd
 = 
£lf
.
f‹r_th»shŞd


43 #thi 
v”siÚ
 
of
 
nms
 
is
 
¦ow”
 
Ú
 
GPU
, 
so
 
we
 
move
 
d©a
 
to
 
CPU
.

44 
boxes
 = boxes.
	$to
(
ıu_deviû
)

45 
scÜes
 = scÜes.
	$to
(
ıu_deviû
)

46 
picked_box_´obs
 = []

47 
picked_Ïb–s
 = []

48 
şass_šdex
 
š
 
	`¿nge
(1, 
scÜes
.
	$size
(1)):

49 
´obs
 = 
scÜes
[:, 
şass_šdex
]

50 
mask
 = 
´obs
 > 
´ob_th»shŞd


51 
´obs
 =…robs[
mask
]

52 
´obs
.
	`size
(0) == 0:

54 
sub£t_boxes
 = 
boxes
[
mask
, :]

55 
box_´obs
 = 
tÜch
.
	`ÿt
([
sub£t_boxes
, 
´obs
.
	`»sh­e
(-1, 1)], 
dim
=1)

56 
box_´obs
 = 
box_uts
.
	$nms
(
box_´obs
, 
£lf
.
nms_m‘hod
,

57 
scÜe_th»shŞd
=
´ob_th»shŞd
,

58 
iou_th»shŞd
=
£lf
.iou_threshold,

59 
sigma
=
£lf
.sigma,

60 
tİ_k
=top_k,

61 
ÿndid©e_size
=
£lf
.candidate_size)

62 
picked_box_´obs
.
	$­³nd
(
box_´obs
)

63 
picked_Ïb–s
.
	`ex‹nd
([
şass_šdex
] * 
box_´obs
.
	$size
(0))

64 
nÙ
 
picked_box_´obs
:

65  
tÜch
.
	`‹nsÜ
([]),Üch.‹nsÜ([]),Üch.
	$‹nsÜ
([])

66 
picked_box_´obs
 = 
tÜch
.
	$ÿt
(
picked_box_´obs
)

67 
picked_box_´obs
[:, 0] *ğ
width


68 
picked_box_´obs
[:, 1] *ğ
height


69 
picked_box_´obs
[:, 2] *ğ
width


70 
picked_box_´obs
[:, 3] *ğ
height


71  
picked_box_´obs
[:, :4], 
tÜch
.
	`‹nsÜ
(
picked_Ïb–s
),…icked_box_probs[:, 4]

	@vision/ssd/squeezenet_ssd_lite.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
ReLU


3 
	gäom
 ..
	gÂ
.
squ“z’‘
 
impÜt
 
squ“z’‘1_1


5 
	gäom
 .
ssd
 
impÜt
 
SSD


6 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


7 
	gäom
 .
cÚfig
 
impÜt
 
squ“z’‘_ssd_cÚfig
 
as
 config

10 
def
 
	$S•”abËCÚv2d
(
š_chªÃls
, 
out_chªÃls
, 
k”Ãl_size
=1, 
¡ride
=1, 
·ddšg
=0):

13  
	`Sequ’tŸl
(

14 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=š_chªÃls, 
k”Ãl_size
=kernel_size,

15 
groups
=
š_chªÃls
, 
¡ride
=¡ride, 
·ddšg
=padding),

16 
	`ReLU
(),

17 
	`CÚv2d
(
š_chªÃls
=š_chªÃls, 
out_chªÃls
=out_chªÃls, 
k”Ãl_size
=1),

21 
def
 
	$ü—‹_squ“z’‘_ssd_l™e
(
num_şas£s
, 
is_‹¡
=
F®£
):

22 
ba£_Ãt
 = 
	`squ“z’‘1_1
(
F®£
).
ã©u»s
 #di§bË 
drİout
 
Ïy”


24 
sourû_Ïy”_šdexes
 = [

27 
exŒas
 = 
	`ModuËLi¡
([

28 
	`Sequ’tŸl
(

29 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=256, 
k”Ãl_size
=1),

30 
	`ReLU
(),

31 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=512, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=2),

33 
	`Sequ’tŸl
(

34 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=256, 
k”Ãl_size
=1),

35 
	`ReLU
(),

36 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=512, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

38 
	`Sequ’tŸl
(

39 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=128, 
k”Ãl_size
=1),

40 
	`ReLU
(),

41 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

43 
	`Sequ’tŸl
(

44 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

45 
	`ReLU
(),

46 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

48 
	`Sequ’tŸl
(

49 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

50 
	`ReLU
(),

51 
	`S•”abËCÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1)

55 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

56 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

57 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

58 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

59 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

60 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

61 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=1),

64 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

65 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

66 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

67 
	`S•”abËCÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

68 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

69 
	`S•”abËCÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

70 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=1),

73  
	$SSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

74 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
, 
is_‹¡
=is_‹¡, 
cÚfig
=config)

77 
def
 
	`ü—‹_squ“z’‘_ssd_l™e_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=
tÜch
.
	`deviû
('cpu')):

78 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
,

79 
cÚfig
.
image_¡d
,

80 
nms_m‘hod
=nms_method,

81 
iou_th»shŞd
=
cÚfig
.iou_threshold,

82 
ÿndid©e_size
=candidate_size,

83 
sigma
=sigma,

84 
deviû
=device)

	@vision/ssd/ssd.py

1 
impÜt
 
	gtÜch
.
Â
 
as
‚n

2 
impÜt
 
tÜch


3 
impÜt
 
numpy
 
as
 
Å


4 
äom
 
typšg
 
impÜt
 
	gLi¡
, 
Tu¶e


5 
impÜt
 
	gtÜch
.
	gÂ
.
funùiÚ®
 
as
 
F


7 
	gäom
 ..
uts
 
impÜt
 
box_uts


8 
äom
 
cŞËùiÚs
 
impÜt
 
Çmedtu¶e


9 
	gG¿phP©h
 = 
Çmedtu¶e
("GraphPath", ['s0', 'name', 's1']) #


12 
şass
 
	$SSD
(
Â
.
ModuË
):

13 
def
 
	$__š™__
(
£lf
, 
num_şas£s
: , 
ba£_Ãt
: 
Â
.
ModuËLi¡
, 
sourû_Ïy”_šdexes
: 
Li¡
[],

14 
exŒas
: 
Â
.
ModuËLi¡
, 
şassifiÿtiÚ_h—d”s
:‚n.ModuleList,

15 
»g»ssiÚ_h—d”s
: 
Â
.
ModuËLi¡
, 
is_‹¡
=
F®£
, 
cÚfig
=
NÚe
, 
deviû
=None):

18 
	`su³r
(
SSD
, 
£lf
).
	$__š™__
()

20 
£lf
.
num_şas£s
 =‚um_classes

21 
£lf
.
ba£_Ãt
 = base_net

22 
£lf
.
sourû_Ïy”_šdexes
 = source_layer_indexes

23 
£lf
.
exŒas
 =ƒxtras

24 
£lf
.
şassifiÿtiÚ_h—d”s
 = classification_headers

25 
£lf
.
»g»ssiÚ_h—d”s
 =„egression_headers

26 
£lf
.
is_‹¡
 = is_test

27 
£lf
.
cÚfig
 = config

29 #»gi¡” 
Ïy”s
 
š
 
sourû_Ïy”_šdexes
 
by
 
addšg
 
them
 
to
 
a
 
moduË
 
li¡


30 
£lf
.
sourû_Ïy”_add_Ús
 = 
Â
.
	`ModuËLi¡
([
t
[1] ˆ
š
 
sourû_Ïy”_šdexes


31 
	$isš¡ªû
(
t
, 
tu¶e
è
ªd
 
nÙ
 
	`isš¡ªû
Ñ, 
G¿phP©h
)])

32 
deviû
:

33 
£lf
.
deviû
 = device

35 
£lf
.
deviû
 = 
tÜch
.
	`deviû
("cuda:0" tÜch.
cuda
.
	$is_avaabË
() "cpu")

36 
is_‹¡
:

37 
£lf
.
cÚfig
 = config

38 
£lf
.
´iÜs
 = 
cÚfig
.´iÜs.
	$to
(
£lf
.
deviû
)

40 
def
 
	`fÜw¬d
(
£lf
, 
x
: 
tÜch
.
T’sÜ
è-> 
Tu¶e
[torch.Tensor,orch.Tensor]:

41 
cÚfid’ûs
 = []

42 
loÿtiÚs
 = []

43 #DISTANCE 
CHANGE


44 
di¡ªûs
 = []

45 
¡¬t_Ïy”_šdex
 = 0

46 
h—d”_šdex
 = 0

47 
’d_Ïy”_šdex
 
š
 
£lf
.
sourû_Ïy”_šdexes
:

48 
	$isš¡ªû
(
’d_Ïy”_šdex
, 
G¿phP©h
):

49 
·th
 = 
’d_Ïy”_šdex


50 
’d_Ïy”_šdex
 =ƒnd_Ïy”_šdex.
s0


51 
added_Ïy”
 = 
NÚe


52 
–if
 
	$isš¡ªû
(
’d_Ïy”_šdex
, 
tu¶e
):

53 
added_Ïy”
 = 
’d_Ïy”_šdex
[1]

54 
’d_Ïy”_šdex
 =ƒnd_layer_index[0]

55 
·th
 = 
NÚe


57 
added_Ïy”
 = 
NÚe


58 
·th
 = 
NÚe


59 
Ïy”
 
š
 
£lf
.
ba£_Ãt
[
¡¬t_Ïy”_šdex
: 
’d_Ïy”_šdex
]:

60 
x
 = 
	$Ïy”
(
x
)

61 
added_Ïy”
:

62 
y
 = 
	$added_Ïy”
(
x
)

64 
y
 = 
x


65 
·th
:

66 
sub
 = 
	$g‘©Œ
(
£lf
.
ba£_Ãt
[
’d_Ïy”_šdex
], 
·th
.
Çme
)

67 
Ïy”
 
š
 
sub
[:
·th
.
s1
]:

68 
x
 = 
	$Ïy”
(
x
)

69 
y
 = 
x


70 
Ïy”
 
š
 
sub
[
·th
.
s1
:]:

71 
x
 = 
	$Ïy”
(
x
)

72 
’d_Ïy”_šdex
 += 1

73 
¡¬t_Ïy”_šdex
 = 
’d_Ïy”_šdex


74 #DISTANCE 
CHANGE


75 
cÚfid’û
, 
loÿtiÚ
, 
di¡ªû
 = 
£lf
.
	$compu‹_h—d”
(
h—d”_šdex
, 
y
)

76 
h—d”_šdex
 += 1

77 
cÚfid’ûs
.
	$­³nd
(
cÚfid’û
)

78 
loÿtiÚs
.
	$­³nd
(
loÿtiÚ
)

79 #DISTANCE 
CHANGE


80 
di¡ªûs
.
	$­³nd
(
di¡ªû
)

82 
Ïy”
 
š
 
£lf
.
ba£_Ãt
[
’d_Ïy”_šdex
:]:

83 
x
 = 
	$Ïy”
(
x
)

85 
Ïy”
 
š
 
£lf
.
exŒas
:

86 
x
 = 
	$Ïy”
(
x
)

87 #DISTANCE 
CHANGE


88 
cÚfid’û
, 
loÿtiÚ
, 
di¡ªû
 = 
£lf
.
	$compu‹_h—d”
(
h—d”_šdex
, 
x
)

89 
h—d”_šdex
 += 1

90 
cÚfid’ûs
.
	$­³nd
(
cÚfid’û
)

91 
loÿtiÚs
.
	$­³nd
(
loÿtiÚ
)

92 #DISTANCE 
CHANGE


93 
di¡ªûs
.
	$­³nd
(
di¡ªû
)

95 
cÚfid’ûs
 = 
tÜch
.
	$ÿt
(
cÚfid’ûs
, 1)

96 
loÿtiÚs
 = 
tÜch
.
	$ÿt
(
loÿtiÚs
, 1)

97 #DISTANCE 
CHANGE


98 
di¡ªûs
 = 
tÜch
.
	$ÿt
(
di¡ªûs
, 1)

100 
£lf
.
is_‹¡
:

101 
cÚfid’ûs
 = 
F
.
	$soámax
(
cÚfid’ûs
, 
dim
=2)

102 
boxes
 = 
box_uts
.
	$cÚv”t_loÿtiÚs_to_boxes
(

103 
loÿtiÚs
, 
£lf
.
´iÜs
, s–f.
cÚfig
.
ûÁ”_v¬Ÿnû
, s–f.cÚfig.
size_v¬Ÿnû


105 
boxes
 = 
box_uts
.
	$ûÁ”_fÜm_to_cÜÃr_fÜm
(
boxes
)

106 #DISTANCE 
CHANGE


107  
cÚfid’ûs
, 
boxes
, 
di¡ªûs


109 #DISTANCE 
CHANGE


110  
cÚfid’ûs
, 
loÿtiÚs
, 
di¡ªûs


112 
def
 
	$compu‹_h—d”
(
£lf
, 
i
, 
x
):

113 
cÚfid’û
 = 
£lf
.
şassifiÿtiÚ_h—d”s
[
i
](
x
)

114 
cÚfid’û
 = cÚfid’û.
	`³rmu‹
(0, 2, 3, 1).
	$cÚtiguous
()

115 
cÚfid’û
 = cÚfid’û.
	`v›w
(cÚfid’û.
	`size
(0), -1, 
£lf
.
num_şas£s
)

117 
loÿtiÚ
 = 
£lf
.
»g»ssiÚ_h—d”s
[
i
](
x
)

118 
loÿtiÚ
 =†oÿtiÚ.
	`³rmu‹
(0, 2, 3, 1).
	$cÚtiguous
()

119 
loÿtiÚ
 =†oÿtiÚ.
	`v›w
ÖoÿtiÚ.
	`size
(0), -1, 4)

121 #DISTANCE 
CHANGE


122 
num_di¡_chªÃls
 = 1

123 
di¡ªû
 = 
£lf
.
»g»ssiÚ_h—d”s
[
i
+6](
x
)

124 
di¡ªû
 = di¡ªû.
	`³rmu‹
(0, 2, 3, 1).
	$cÚtiguous
()

125 
di¡ªû
 = di¡ªû.
	`v›w
(
loÿtiÚ
.
	`size
(0), -1, 
num_di¡_chªÃls
)

127  
cÚfid’û
, 
loÿtiÚ
, 
di¡ªû


129 
def
 
	$š™_äom_ba£_Ãt
(
£lf
, 
mod–
):

130 
£lf
.
ba£_Ãt
.
	`lßd_¡©e_diù
(
tÜch
.
	`lßd
(
mod–
, 
m­_loÿtiÚ
=
Ïmbda
 
¡Üage
, 
loc
: stÜage), 
¡riù
=
True
)

131 
£lf
.
sourû_Ïy”_add_Ús
.
	$­¶y
(
_xav›r_š™_
)

132 
£lf
.
exŒas
.
	$­¶y
(
_xav›r_š™_
)

133 
£lf
.
şassifiÿtiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

134 
£lf
.
»g»ssiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

136 
def
 
	$š™_äom_´‘¿šed_ssd
(
£lf
, 
mod–
):

137 
¡©e_diù
 = 
tÜch
.
	$lßd
(
mod–
, 
m­_loÿtiÚ
=
Ïmbda
 
¡Üage
, 
loc
: storage)

138 
¡©e_diù
 = {
k
: 
v
 k, v 
š
 s‹_diù.
	`™ems
(è
	`nÙ
 (k.
	`¡¬tsw™h
("şassifiÿtiÚ_h—d”s"è
Ü
 k.¡¬tsw™h("»g»ssiÚ_h—d”s"))
	}
}

139 
mod–_diù
 = 
£lf
.
	$¡©e_diù
()

140 
mod–_diù
.
	$upd©e
(
¡©e_diù
)

141 
£lf
.
	$lßd_¡©e_diù
(
mod–_diù
)

142 
£lf
.
şassifiÿtiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

143 
£lf
.
»g»ssiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

145 
def
 
	$š™
(
£lf
):

146 
£lf
.
ba£_Ãt
.
	$­¶y
(
_xav›r_š™_
)

147 
£lf
.
sourû_Ïy”_add_Ús
.
	$­¶y
(
_xav›r_š™_
)

148 
£lf
.
exŒas
.
	$­¶y
(
_xav›r_š™_
)

149 
£lf
.
şassifiÿtiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

150 
£lf
.
»g»ssiÚ_h—d”s
.
	$­¶y
(
_xav›r_š™_
)

152 
def
 
	$lßd
(
£lf
, 
mod–
):

153 
£lf
.
	`lßd_¡©e_diù
(
tÜch
.
	$lßd
(
mod–
, 
m­_loÿtiÚ
=
Ïmbda
 
¡Üage
, 
loc
: storage))

155 
def
 
	$§ve
(
£lf
, 
mod–_·th
):

156 
tÜch
.
	`§ve
(
£lf
.
	`¡©e_diù
(), 
mod–_·th
)

159 
şass
 
	$M©chPriÜ
(
objeù
):

160 
def
 
	$__š™__
(
£lf
, 
ûÁ”_fÜm_´iÜs
, 
ûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû
, 
iou_th»shŞd
):

161 
£lf
.
ûÁ”_fÜm_´iÜs
 = center_form_priors

162 
£lf
.
cÜÃr_fÜm_´iÜs
 = 
box_uts
.
	$ûÁ”_fÜm_to_cÜÃr_fÜm
(
ûÁ”_fÜm_´iÜs
)

163 
£lf
.
ûÁ”_v¬Ÿnû
 = center_variance

164 
£lf
.
size_v¬Ÿnû
 = size_variance

165 
£lf
.
iou_th»shŞd
 = iou_threshold

167 #DISTANCE 
CHANGE


168 
def
 
	$__ÿÎ__
(
£lf
, 
gt_boxes
, 
gt_Ïb–s
, 
gt_di¡
):

169 #deà
	`__ÿÎ__
(
£lf
, 
gt_boxes
, 
gt_Ïb–s
, 
gt_di¡
):

170 
	$ty³
(
gt_boxes
è
is
 
Å
.
nd¬¿y
:

171 
gt_boxes
 = 
tÜch
.
	$äom_numpy
(
gt_boxes
)

172 
	$ty³
(
gt_Ïb–s
è
is
 
Å
.
nd¬¿y
:

173 
gt_Ïb–s
 = 
tÜch
.
	$äom_numpy
(
gt_Ïb–s
)

174 #DISTANCE 
CHANGE


175 
	$ty³
(
gt_di¡
è
is
 
Å
.
nd¬¿y
:

176 
gt_di¡
 = 
tÜch
.
	$äom_numpy
(
gt_di¡
)

177 #DISTANCE 
CHANGE


178 #boxes, 
Ïb–s
 = 
box_uts
.
	`assign_´iÜs
(
gt_boxes
, 
gt_Ïb–s
,

179 
boxes
, 
Ïb–s
, 
di¡ªûs
 = 
box_uts
.
	$assign_´iÜs
(
gt_boxes
, 
gt_Ïb–s
, 
gt_di¡
,

180 
£lf
.
cÜÃr_fÜm_´iÜs
, s–f.
iou_th»shŞd
)

181 
boxes
 = 
box_uts
.
	$cÜÃr_fÜm_to_ûÁ”_fÜm
(
boxes
)

182 
loÿtiÚs
 = 
box_uts
.
	$cÚv”t_boxes_to_loÿtiÚs
(
boxes
, 
£lf
.
ûÁ”_fÜm_´iÜs
, s–f.
ûÁ”_v¬Ÿnû
, s–f.
size_v¬Ÿnû
)

183 #DISTANCE 
CHANGE


184 #»tuº 
loÿtiÚs
, 
Ïb–s


185  
loÿtiÚs
, 
Ïb–s
, 
di¡ªûs


188 
def
 
	$_xav›r_š™_
(
m
: 
Â
.
ModuË
):

189 
	$isš¡ªû
(
m
, 
Â
.
CÚv2d
):

190 
Â
.
š™
.
	`xav›r_unifÜm_
(
m
.
weight
)

	@vision/ssd/vgg_ssd.py

1 
impÜt
 
tÜch


2 
äom
 
	gtÜch
.
Â
 
impÜt
 
	gCÚv2d
, 
	gSequ’tŸl
, 
	gModuËLi¡
, 
	gReLU
, 
B©chNÜm2d


3 
	gäom
 ..
	gÂ
.
vgg
 
impÜt
 vgg

5 
	gäom
 .
ssd
 
impÜt
 
SSD


6 
	gäom
 .
´ediùÜ
 
impÜt
 
P»diùÜ


7 
	gäom
 .
cÚfig
 
impÜt
 
vgg_ssd_cÚfig
 
as
 config

10 
def
 
	$ü—‹_vgg_ssd
(
num_şas£s
, 
is_‹¡
=
F®£
):

11 
vgg_cÚfig
 = [64, 64, 'M', 128, 128, 'M', 256, 256, 256, 'C', 512, 512, 512, 'M',

13 
ba£_Ãt
 = 
	`ModuËLi¡
(
	$vgg
(
vgg_cÚfig
))

15 
sourû_Ïy”_šdexes
 = [

16 (23, 
	`B©chNÜm2d
(512)),

17 
	`Ën
(
ba£_Ãt
),

19 
exŒas
 = 
	`ModuËLi¡
([

20 
	`Sequ’tŸl
(

21 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=256, 
k”Ãl_size
=1),

22 
	`ReLU
(),

23 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=512, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

24 
	`ReLU
()

26 
	`Sequ’tŸl
(

27 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=128, 
k”Ãl_size
=1),

28 
	`ReLU
(),

29 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3, 
¡ride
=2, 
·ddšg
=1),

30 
	`ReLU
()

32 
	`Sequ’tŸl
(

33 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

34 
	`ReLU
(),

35 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3),

36 
	`ReLU
()

38 
	`Sequ’tŸl
(

39 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=128, 
k”Ãl_size
=1),

40 
	`ReLU
(),

41 
	`CÚv2d
(
š_chªÃls
=128, 
out_chªÃls
=256, 
k”Ãl_size
=3),

42 
	`ReLU
()

46 
»g»ssiÚ_h—d”s
 = 
	`ModuËLi¡
([

47 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=4 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

48 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

49 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

50 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

51 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=4 * 4, 
k”Ãl_size
=3, 
·ddšg
=1),

52 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=4 * 4, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

55 
şassifiÿtiÚ_h—d”s
 = 
	`ModuËLi¡
([

56 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=4 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

57 
	`CÚv2d
(
š_chªÃls
=1024, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

58 
	`CÚv2d
(
š_chªÃls
=512, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

59 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=6 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

60 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=4 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1),

61 
	`CÚv2d
(
š_chªÃls
=256, 
out_chªÃls
=4 * 
num_şas£s
, 
k”Ãl_size
=3, 
·ddšg
=1), #TODO: 
chªge
 
to
 kernel_size=1,…adding=0?

64  
	$SSD
(
num_şas£s
, 
ba£_Ãt
, 
sourû_Ïy”_šdexes
,

65 
exŒas
, 
şassifiÿtiÚ_h—d”s
, 
»g»ssiÚ_h—d”s
, 
is_‹¡
=is_‹¡, 
cÚfig
=config)

68 
def
 
	$ü—‹_vgg_ssd_´ediùÜ
(
Ãt
, 
ÿndid©e_size
=200, 
nms_m‘hod
=
NÚe
, 
sigma
=0.5, 
deviû
=None):

69 
´ediùÜ
 = 
	$P»diùÜ
(
Ãt
, 
cÚfig
.
image_size
, cÚfig.
image_m—n
,

70 
nms_m‘hod
=nms_method,

71 
iou_th»shŞd
=
cÚfig
.iou_threshold,

72 
ÿndid©e_size
=candidate_size,

73 
sigma
=sigma,

74 
deviû
=device)

75  
´ediùÜ


	@vision/test/__init__.py

	@vision/test/test_vgg_ssd.py

1 
	gäom
 ..
	gssd
.
vgg_ssd
 
impÜt
 
ü—‹_vgg_ssd


3 
impÜt
 
tÜch


4 
impÜt
 
‹mpfe


7 
def
 
	$‹¡_ü—‹_vgg_ssd
():

8 
num_şas£s
 
š
 [2, 10, 21, 100]:

9 
_
 = 
	$ü—‹_vgg_ssd
(
num_şas£s
)

12 
def
 
	$‹¡_fÜw¬d
():

13 
num_şas£s
 
š
 [2]:

14 
Ãt
 = 
	$ü—‹_vgg_ssd
(
num_şas£s
)

15 
Ãt
.
	$š™
()

16 
Ãt
.
	$ev®
()

17 
x
 = 
tÜch
.
	$¿ndn
(2, 3, 300, 300)

18 
cÚfid’ûs
, 
loÿtiÚs
 = 
Ãt
.
	$fÜw¬d
(
x
)

19 
as£¹
 
cÚfid’ûs
.
	`size
(è=ğ
tÜch
.
	$Size
([2, 8732, 
num_şas£s
])

20 
as£¹
 
loÿtiÚs
.
	`size
(è=ğ
tÜch
.
	$Size
([2, 8732, 4])

21 
as£¹
 
cÚfid’ûs
.
	`nÚz”o
().
	`size
(0) != 0

22 
as£¹
 
loÿtiÚs
.
	`nÚz”o
().
	`size
(0) != 0

25 
def
 
	$‹¡_§ve_mod–
():

26 
Ãt
 = 
	$ü—‹_vgg_ssd
(10)

27 
Ãt
.
	$š™
()

28 
w™h
 
‹mpfe
.
	$TempÜ¬yFe
(è
as
 
f
:

29 
Ãt
.
	$§ve
(
f
)

32 
def
 
	$‹¡_§ve_lßd_mod–_cÚsi¡’cy
():

33 
Ãt
 = 
	$ü—‹_vgg_ssd
(20)

34 
Ãt
.
	$š™
()

35 
mod–_·th
 = 
‹mpfe
.
	`NamedTempÜ¬yFe
().
Çme


36 
Ãt
.
	$§ve
(
mod–_·th
)

37 
Ãt_cİy
 = 
	$ü—‹_vgg_ssd
(20)

38 
Ãt_cİy
.
	$lßd
(
mod–_·th
)

40 
Ãt
.
	$ev®
()

41 
Ãt_cİy
.
	$ev®
()

43 
_
 
š
 
	$¿nge
(1):

44 
x
 = 
tÜch
.
	$¿ndn
(1, 3, 300, 300)

45 
cÚfid’ûs1
, 
loÿtiÚs1
 = 
Ãt
.
	$fÜw¬d
(
x
)

46 
cÚfid’ûs2
, 
loÿtiÚs2
 = 
Ãt_cİy
.
	$fÜw¬d
(
x
)

47 
	`as£¹
 (
cÚfid’ûs1
 =ğ
cÚfid’ûs2
).().
	`sum
(è=ğcÚfid’ûs2.
	$num–
()

48 
	`as£¹
 (
loÿtiÚs1
 =ğ
loÿtiÚs2
).().
	`sum
(è=ğloÿtiÚs2.
	`num–
()

	@vision/transforms/__init__.py

	@vision/transforms/transforms.py

1 #äom 
h‰ps
:

4 
impÜt
 
tÜch


5 
äom
 
tÜchvisiÚ
 
impÜt
 
ŒªsfÜms


6 
impÜt
 
cv2


7 
impÜt
 
numpy
 
as
 
Å


8 
impÜt
 
ty³s


9 
äom
 
numpy
 
impÜt
 
¿ndom


12 
def
 
	$š‹r£ù
(
box_a
, 
box_b
):

13 
max_xy
 = 
Å
.
	$mšimum
(
box_a
[:, 2:], 
box_b
[2:])

14 
mš_xy
 = 
Å
.
	$maximum
(
box_a
[:, :2], 
box_b
[:2])

15 
š‹r
 = 
Å
.
	`ş
((
max_xy
 - 
mš_xy
), 
a_mš
=0, 
a_max
òp.
šf
)

16  
š‹r
[:, 0] * inter[:, 1]

19 
def
 
	$jacÿrd_numpy
(
box_a
, 
box_b
):

21 
is
 
sim¶y
 
the
 
š‹r£ùiÚ
 
ov”
 
of
 
two
 
boxes
.

22 
E
.
g
.:

23 
A
 âˆ© 
B
 / A âˆª B = A âˆ© B / (
	`¬—
(A) +‡rea(B) - A âˆ© B)

24 
Args
:

25 
box_a
: 
MuÉË
 
boundšg
 
boxes
, 
Sh­e
: [
num_boxes
,4]

26 
box_b
: 
SšgË
 
boundšg
 
box
, 
Sh­e
: [4]

27 
R‘uº
:

28 
jacÿrd
 
ov”Ïp
: 
Sh­e
: [
box_a
.
sh­e
[0], box_a.shape[1]]

30 
š‹r
 = 
	$š‹r£ù
(
box_a
, 
box_b
)

31 
¬—_a
 = ((
box_a
[:, 2]-box_a[:, 0]) *

32 (
box_a
[:, 3]-box_a[:, 1])è#[
A
,
B
]

33 
¬—_b
 = ((
box_b
[2]-box_b[0]) *

34 (
box_b
[3]-box_b[1])è#[
A
,
B
]

35 ğ
¬—_a
 + 
¬—_b
 - 
š‹r


36  
š‹r
 / #[
A
,
B
]

39 
şass
 
	$Compo£
(
objeù
):

41 
Args
:

42 
	$ŒªsfÜms
 (
Li¡
[
T¿nsfÜm
]): 
li¡
 
of
 
ŒªsfÜms
 
to
 
compo£
.

43 
Exam¶e
:

44 >>> 
augm’tiÚs
.
	`Compo£
([

45 >>> 
ŒªsfÜms
.
	`C’‹rCrİ
(10),

46 >>> 
ŒªsfÜms
.
	`ToT’sÜ
(),

50 
def
 
	$__š™__
(
£lf
, 
ŒªsfÜms
):

51 
£lf
.
ŒªsfÜms
 =ransforms

53 
def
 
	$__ÿÎ__
(
£lf
, 
img
, 
boxes
=
NÚe
, 
Ïb–s
=None):

54 
t
 
š
 
£lf
.
ŒªsfÜms
:

55 
img
, 
boxes
, 
Ïb–s
 = 
	$t
(
img
, 
boxes
, 
Ïb–s
)

56  
img
, 
boxes
, 
Ïb–s


59 
şass
 
	$Lambda
(
objeù
):

62 
def
 
	$__š™__
(
£lf
, 
Ïmbd
):

63 
as£¹
 
	$isš¡ªû
(
Ïmbd
, 
ty³s
.
LambdaTy³
)

64 
£lf
.
Ïmbd
 =†ambd

66 
def
 
	$__ÿÎ__
(
£lf
, 
img
, 
boxes
=
NÚe
, 
Ïb–s
=None):

67  
£lf
.
	$Ïmbd
(
img
, 
boxes
, 
Ïb–s
)

70 
şass
 
	$CÚv”tFromIÁs
(
objeù
):

71 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

72  
image
.
	`a¡y³
(
Å
.
æßt32
), 
boxes
, 
Ïb–s


75 
şass
 
	$SubŒaùM—ns
(
objeù
):

76 
def
 
	$__š™__
(
£lf
, 
m—n
):

77 
£lf
.
m—n
 = 
Å
.
	$¬¿y
(
m—n
, 
dty³
=
Å
.
æßt32
)

79 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

80 
image
 = image.
	$a¡y³
(
Å
.
æßt32
)

81 
image
 -ğ
£lf
.
m—n


82  
image
.
	`a¡y³
(
Å
.
æßt32
), 
boxes
, 
Ïb–s


85 
şass
 
	$ToAbsŞu‹CoÜds
(
objeù
):

86 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

87 
height
, 
width
, 
chªÃls
 = 
image
.
sh­e


88 
boxes
[:, 0] *ğ
width


89 
boxes
[:, 2] *ğ
width


90 
boxes
[:, 1] *ğ
height


91 
boxes
[:, 3] *ğ
height


93  
image
, 
boxes
, 
Ïb–s


96 
şass
 
	$ToP”ûÁCoÜds
(
objeù
):

97 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

98 
height
, 
width
, 
chªÃls
 = 
image
.
sh­e


99 
boxes
[:, 0] /ğ
width


100 
boxes
[:, 2] /ğ
width


101 
boxes
[:, 1] /ğ
height


102 
boxes
[:, 3] /ğ
height


103 #DISTANCE 
CHANGE


104 
boxes
[boxes > 1.0] = 1.0

106  
image
, 
boxes
, 
Ïb–s


109 
şass
 
	$Resize
(
objeù
):

110 
def
 
	$__š™__
(
£lf
, 
size
=300):

111 
£lf
.
size
 = size

113 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

114 
image
 = 
cv2
.
	`»size
(image, (
£lf
.
size
,

115 
£lf
.
size
))

116  
image
, 
boxes
, 
Ïb–s


119 
şass
 
	$RªdomS©u¿tiÚ
(
objeù
):

120 
def
 
	$__š™__
(
£lf
, 
low”
=0.5, 
uµ”
=1.5):

121 
£lf
.
low”
 =†ower

122 
£lf
.
uµ”
 = upper

123 
as£¹
 
£lf
.
uµ”
 >ğ£lf.
low”
, "contrast upper must be >=†ower."

124 
as£¹
 
£lf
.
low”
 >= 0, "contrast†ower must be‚on-negative."

126 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

127 
¿ndom
.
	$¿ndšt
(2):

128 
image
[:, :, 1] *ğ
¿ndom
.
	$unifÜm
(
£lf
.
low”
, s–f.
uµ”
)

130  
image
, 
boxes
, 
Ïb–s


133 
şass
 
	$RªdomHue
(
objeù
):

134 
def
 
	$__š™__
(
£lf
, 
d–
=18.0):

135 
as£¹
 
d–
 >ğ0.0 
ªd
 delta <= 360.0

136 
£lf
.
d–
 = delta

138 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

139 
¿ndom
.
	$¿ndšt
(2):

140 
image
[:, :, 0] +ğ
¿ndom
.
	`unifÜm
(-
£lf
.
d–
, self.delta)

141 
image
[:, :, 0][image[:, :, 0] > 360.0] -= 360.0

142 
image
[:, :, 0][image[:, :, 0] < 0.0] += 360.0

143  
image
, 
boxes
, 
Ïb–s


146 
şass
 
	$RªdomLightšgNoi£
(
objeù
):

147 
def
 
	$__š™__
(
£lf
):

148 
£lf
.
³rms
 = ((0, 1, 2), (0, 2, 1),

152 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

153 
¿ndom
.
	$¿ndšt
(2):

154 
sw­
 = 
£lf
.
³rms
[
¿ndom
.
	`¿ndšt
(
	`Ën
(self.perms))]

155 
shufæe
 = 
	$Sw­ChªÃls
(
sw­
è#shufæ
chªÃls


156 
image
 = 
	$shufæe
(
image
)

157  
image
, 
boxes
, 
Ïb–s


160 
şass
 
	$CÚv”tCŞÜ
(
objeù
):

161 
def
 
	$__š™__
(
£lf
, 
cu¼’t
, 
ŒªsfÜm
):

162 
£lf
.
ŒªsfÜm
 =ransform

163 
£lf
.
cu¼’t
 = current

165 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

166 
£lf
.
cu¼’t
 =ğ'BGR' 
ªd
 s–f.
ŒªsfÜm
 == 'HSV':

167 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_BGR2HSV
)

168 
–if
 
£lf
.
cu¼’t
 =ğ'RGB' 
ªd
 s–f.
ŒªsfÜm
 == 'HSV':

169 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_RGB2HSV
)

170 
–if
 
£lf
.
cu¼’t
 =ğ'BGR' 
ªd
 s–f.
ŒªsfÜm
 == 'RGB':

171 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_BGR2RGB
)

172 
–if
 
£lf
.
cu¼’t
 =ğ'HSV' 
ªd
 s–f.
ŒªsfÜm
 == 'BGR':

173 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_HSV2BGR
)

174 
–if
 
£lf
.
cu¼’t
 =ğ'HSV' 
ªd
 s–f.
ŒªsfÜm
 == "RGB":

175 
image
 = 
cv2
.
	$cvtCŞÜ
(
image
, 
cv2
.
COLOR_HSV2RGB
)

177 
¿i£
 
NÙIm¶em’‹dE¼Ü


178  
image
, 
boxes
, 
Ïb–s


181 
şass
 
	$RªdomCÚŒa¡
(
objeù
):

182 
def
 
	$__š™__
(
£lf
, 
low”
=0.5, 
uµ”
=1.5):

183 
£lf
.
low”
 =†ower

184 
£lf
.
uµ”
 = upper

185 
as£¹
 
£lf
.
uµ”
 >ğ£lf.
low”
, "contrast upper must be >=†ower."

186 
as£¹
 
£lf
.
low”
 >= 0, "contrast†ower must be‚on-negative."

188 #ex³ù 
image


189 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

190 
¿ndom
.
	$¿ndšt
(2):

191 
®pha
 = 
¿ndom
.
	$unifÜm
(
£lf
.
low”
, s–f.
uµ”
)

192 
image
 *ğ
®pha


193  
image
, 
boxes
, 
Ïb–s


196 
şass
 
	$RªdomBrighŠess
(
objeù
):

197 
def
 
	$__š™__
(
£lf
, 
d–
=32):

198 
as£¹
 
d–
 >= 0.0

199 
as£¹
 
d–
 <= 255.0

200 
£lf
.
d–
 = delta

202 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

203 
¿ndom
.
	$¿ndšt
(2):

204 
d–
 = 
¿ndom
.
	`unifÜm
(-
£lf
.delta, self.delta)

205 
image
 +ğ
d–


206  
image
, 
boxes
, 
Ïb–s


209 
şass
 
	$ToCV2Image
(
objeù
):

210 
def
 
	$__ÿÎ__
(
£lf
, 
‹nsÜ
, 
boxes
=
NÚe
, 
Ïb–s
=None):

211  
‹nsÜ
.
	`ıu
().
	`numpy
().
	`a¡y³
(
Å
.
æßt32
).
	`Œª¥o£
((1, 2, 0)), 
boxes
, 
Ïb–s


214 
şass
 
	$ToT’sÜ
(
objeù
):

215 
def
 
	$__ÿÎ__
(
£lf
, 
cvimage
, 
boxes
=
NÚe
, 
Ïb–s
=None):

216  
tÜch
.
	`äom_numpy
(
cvimage
.
	`a¡y³
(
Å
.
æßt32
)).
	`³rmu‹
(2, 0, 1), 
boxes
, 
Ïb–s


219 
şass
 
	$RªdomSam¶eCrİ
(
objeù
):

221 
Argum’ts
:

222 
	$img
 (
Image
): 
the
 
image
 
bešg
 
šput
 
duršg
 
Œaššg


223 
	$boxes
 (
T’sÜ
): 
the
 
Üigš®
 
boundšg
 
boxes
 
š
 
±
 
fÜm


224 
	$Ïb–s
 (
T’sÜ
): 
the
 
şass
 
Ïb–s
 
—ch
 
bbox


225 
	$mode
 (
tu¶e
): 
the
 
mš
 
ªd
 
max
 
jacÿrd
 
ov”Ïps


226 
R‘uº
:

227 (
img
, 
boxes
, 
şas£s
)

228 
	$img
 (
Image
): 
the
 
üİ³d
 
image


229 
	$boxes
 (
T’sÜ
): 
the
 
adju¡ed
 
boundšg
 
boxes
 
š
 
±
 
fÜm


230 
	$Ïb–s
 (
T’sÜ
): 
the
 
şass
 
Ïb–s
 
—ch
 
bbox


232 
def
 
	$__š™__
(
£lf
):

233 
£lf
.
§m¶e_İtiÚs
 = (

234 #usšg 
’tœe
 
Üigš®
 
šput
 
image


235 
NÚe
,

236 #§m¶
a
 
·tch
 
s
.
t
. 
MIN
 
jacÿrd
 
w
/ 
obj
 
š
 .1,.3,.4,.7,.9

237 (0.1, 
NÚe
),

238 (0.3, 
NÚe
),

239 (0.7, 
NÚe
),

240 (0.9, 
NÚe
),

241 #¿ndomly 
§m¶e
 
a
 
·tch


242 (
NÚe
, None),

245 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
=
NÚe
, 
Ïb–s
=None):

246 
height
, 
width
, 
_
 = 
image
.
sh­e


247 
True
:

248 #¿ndomly 
choo£
 
a
 
mode


249 
mode
 = 
¿ndom
.
	$choiû
(
£lf
.
§m¶e_İtiÚs
)

250 
mode
 
is
 
NÚe
:

251  
image
, 
boxes
, 
Ïb–s


253 
mš_iou
, 
max_iou
 = 
mode


254 
mš_iou
 
is
 
NÚe
:

255 
mš_iou
 = ('-inf')

256 
max_iou
 
is
 
NÚe
:

257 
max_iou
 = ('inf')

259 #max 
	`Œas
 (50)

260 
_
 
š
 
	$¿nge
(50):

261 
cu¼’t_image
 = 
image


263 
w
 = 
¿ndom
.
	$unifÜm
(0.3 * 
width
, width)

264 
h
 = 
¿ndom
.
	$unifÜm
(0.3 * 
height
, height)

266 #a¥eù 
¿tio
 
cÚ¡¿št
 
b
/
t
 .5 & 2

267 
h
 / 
w
 < 0.5 
Ü
 h / w > 2:

270 
Ëá
 = 
¿ndom
.
	`unifÜm
(
width
 - 
w
)

271 
tİ
 = 
¿ndom
.
	`unifÜm
(
height
 - 
h
)

273 #cÚv”ˆ
to
 
š‹g”
 
»ù
 
x1
,
y1
,
x2
,
y2


274 
»ù
 = 
Å
.
	`¬¿y
([(
Ëá
), (
tİ
), Öeá+
w
), Ñİ+
h
)])

276 #ÿlcuÏ‹ 
	`IoU
 (
jacÿrd
 
ov”Ïp
è
b
/
t
 
the
 
üİ³d
 
ªd
 
gt
 
boxes


277 
ov”Ïp
 = 
	$jacÿrd_numpy
(
boxes
, 
»ù
)

279 #i 
mš
 
ªd
 
max
 
ov”Ïp
 
cÚ¡¿št
 
§tisf›d
? 
nÙ
 
Œy
 
agaš


280 
ov”Ïp
.
	`mš
(è< 
mš_iou
 
ªd
 
max_iou
 < ov”Ïp.
	$max
():

283 #cuˆ
the
 
üİ
 
äom
h
image


284 
cu¼’t_image
 = cu¼’t_image[
»ù
[1]:rect[3],„ect[0]:rect[2],

287 #k“°
ov”Ïp
 
w™h
 
gt
 
box
 
IF
 
ûÁ”
 
š
 
§m¶ed
 
·tch


288 
ûÁ”s
 = (
boxes
[:, :2] + boxes[:, 2:]) / 2.0

290 #mask 
š
 
®l
 
gt
 
boxes
 
th©
 
above
 
ªd
 
to
 
the
 
Ëá
 
of
 
ûÁ”s


291 
m1
 = (
»ù
[0] < 
ûÁ”s
[:, 0]) * (rect[1] < centers[:, 1])

293 #mask 
š
 
®l
 
gt
 
boxes
 
th©
 
und”
 
ªd
 
to
 
the
 
right
 
of
 
ûÁ”s


294 
m2
 = (
»ù
[2] > 
ûÁ”s
[:, 0]) * (rect[3] > centers[:, 1])

296 #mask 
š
 
th©
 
bÙh
 
m1
 
ªd
 
m2
 
¬e
 
Œue


297 
mask
 = 
m1
 * 
m2


299 #hav
ªy
 
v®id
 
boxes
? 
Œy
 
agaš
 
nÙ


300 
nÙ
 
mask
.
	$ªy
():

303 #k
Úly
 
m©chšg
 
gt
 
boxes


304 
cu¼’t_boxes
 = 
boxes
[
mask
, :].
	$cİy
()

306 #k
Úly
 
m©chšg
 
gt
 
Ïb–s


307 
cu¼’t_Ïb–s
 = 
Ïb–s
[
mask
]

309 #should 
we
 
u£
 
the
 
box
 
Ëá
 
ªd
 
tİ
 
cÜÃr
 
Ü
h
üİ
's

310 
cu¼’t_boxes
[:, :2] = 
Å
.
	$maximum
(
cu¼’t_boxes
[:, :2],

311 
»ù
[:2])

312 #adju¡ 
to
 
	`üİ
 (
by
 
sub¡¿ùšg
 
üİ
's†eft,top)

313 
cu¼’t_boxes
[:, :2] -ğ
»ù
[:2]

315 
cu¼’t_boxes
[:, 2:] = 
Å
.
	$mšimum
(
cu¼’t_boxes
[:, 2:],

316 
»ù
[2:])

317 #adju¡ 
to
 
	`üİ
 (
by
 
sub¡¿ùšg
 
üİ
's†eft,top)

318 
cu¼’t_boxes
[:, 2:] -ğ
»ù
[:2]

320  
cu¼’t_image
, 
cu¼’t_boxes
, 
cu¼’t_Ïb–s


323 
şass
 
	$Ex·nd
(
objeù
):

324 
def
 
	$__š™__
(
£lf
, 
m—n
):

325 
£lf
.
m—n
 = mean

327 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
, 
Ïb–s
):

328 
¿ndom
.
	$¿ndšt
(2):

329  
image
, 
boxes
, 
Ïb–s


331 
height
, 
width
, 
d•th
 = 
image
.
sh­e


332 
¿tio
 = 
¿ndom
.
	$unifÜm
(1, 4)

333 
Ëá
 = 
¿ndom
.
	`unifÜm
(0, 
width
*
¿tio
 - width)

334 
tİ
 = 
¿ndom
.
	`unifÜm
(0, 
height
*
¿tio
 - height)

336 
ex·nd_image
 = 
Å
.
	`z”os
(

337 ((
height
*
¿tio
), (
width
*¿tio), 
d•th
),

338 
dty³
=
image
.dtype)

339 
ex·nd_image
[:, :, :] = 
£lf
.
m—n


340 
ex·nd_image
[(
tİ
):Ñİ + 
height
),

341 (
Ëá
):Öeá + 
width
)] = 
image


342 
image
 = 
ex·nd_image


344 
boxes
 = boxes.
	$cİy
()

345 
boxes
[:, :2] +ğ((
Ëá
), (
tİ
))

346 
boxes
[:, 2:] +ğ((
Ëá
), (
tİ
))

348  
image
, 
boxes
, 
Ïb–s


351 
şass
 
	$RªdomMœrÜ
(
objeù
):

352 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
, 
şas£s
):

353 
_
, 
width
, _ = 
image
.
sh­e


354 
¿ndom
.
	$¿ndšt
(2):

355 
image
 = image[:, ::-1]

356 
boxes
 = boxes.
	$cİy
()

357 
boxes
[:, 0::2] = 
width
 - boxes[:, 2::-2]

358  
image
, 
boxes
, 
şas£s


361 
şass
 
	$Sw­ChªÃls
(
objeù
):

363 
¥ecif›d
 
š
 
the
 
sw­
 
tu¶e
.

364 
Args
:

365 
	$sw­s
 (
ŒË
): 
fš®
 
Üd”
 
of
 
chªÃls


366 
eg
: (2, 1, 0)

369 
def
 
	$__š™__
(
£lf
, 
sw­s
):

370 
£lf
.
sw­s
 = swaps

372 
def
 
	$__ÿÎ__
(
£lf
, 
image
):

374 
Args
:

375 
	$image
 (
T’sÜ
): 
image
 
‹nsÜ
 
to
 
be
 
ŒªsfÜmed


376 
R‘uº
:

377 
a
 
‹nsÜ
 
w™h
 
chªÃls
 
sw­³d
 
accÜdšg
 
to
 
sw­


379 #ià
tÜch
.
	`is_‹nsÜ
(
image
):

380 #imagğ
image
.
d©a
.
	`ıu
().
	`numpy
()

382 #imagğ
Å
.
	`¬¿y
(
image
)

383 
image
 = image[:, :, 
£lf
.
sw­s
]

384  
image


387 
şass
 
	$PhÙom‘ricDi¡Üt
(
objeù
):

388 
def
 
	$__š™__
(
£lf
):

389 
£lf
.
pd
 = [

390 
	`RªdomCÚŒa¡
(), #RGB

391 
	`CÚv”tCŞÜ
(
cu¼’t
="RGB", 
ŒªsfÜm
='HSV'), #HSV

392 
	`RªdomS©u¿tiÚ
(), #HSV

393 
	`RªdomHue
(), #HSV

394 
	`CÚv”tCŞÜ
(
cu¼’t
='HSV', 
ŒªsfÜm
='RGB'), #RGB

395 
	$RªdomCÚŒa¡
() #RGB

397 
£lf
.
¿nd_brighŠess
 = 
	$RªdomBrighŠess
()

398 
£lf
.
¿nd_light_noi£
 = 
	$RªdomLightšgNoi£
()

400 
def
 
	$__ÿÎ__
(
£lf
, 
image
, 
boxes
, 
Ïb–s
):

401 
im
 = 
image
.
	$cİy
()

402 
im
, 
boxes
, 
Ïb–s
 = 
£lf
.
	$¿nd_brighŠess
(
im
, 
boxes
, 
Ïb–s
)

403 
¿ndom
.
	$¿ndšt
(2):

404 
di¡Üt
 = 
	`Compo£
(
£lf
.
pd
[:-1])

406 
di¡Üt
 = 
	$Compo£
(
£lf
.
pd
[1:])

407 
im
, 
boxes
, 
Ïb–s
 = 
	$di¡Üt
(
im
, 
boxes
, 
Ïb–s
)

408  
£lf
.
	`¿nd_light_noi£
(
im
, 
boxes
, 
Ïb–s
)

	@vision/utils/__init__.py

1 
	gäom
 .
misc
 
	gimpÜt
 *

	@vision/utils/box_utils.py

1 
impÜt
 
cŞËùiÚs


2 
impÜt
 
tÜch


3 
impÜt
 
™”toŞs


4 
äom
 
typšg
 
impÜt
 
Li¡


5 
impÜt
 
m©h


7 
	gSSDBoxSizes
 = 
cŞËùiÚs
.
Çmedtu¶e
('SSDBoxSizes', ['min', 'max'])

9 
	gSSDS³c
 = 
cŞËùiÚs
.
Çmedtu¶e
('SSDSpec', ['feature_map_size', 'shrinkage', 'box_sizes', 'aspect_ratios'])

12 
def
 
g’”©e_ssd_´iÜs
(
¥ecs
: 
Li¡
[
SSDS³c
], 
image_size
, 
şamp
=
True
è-> 
tÜch
.
T’sÜ
:

15 
It
 
»tuºs
 
the
 
ûÁ”
, 
height
 
ªd
 
width
 
of
h
	g´iÜs
. 
The
 
v®ues
 
¬e
 
»Ïtive
 
to
h
image
 
size


16 
	gArgs
:

17 
¥ecs
: 
SSDS³cs
 
about
 
the
 
sh­es
 
of
 
sizes
 oà
´iÜ
 
boxes
. 
i
.
e
.

18 
¥ecs
 = [

19 
SSDS³c
(38, 8, 
SSDBoxSizes
(30, 60), [2]),

20 
SSDS³c
(19, 16, 
SSDBoxSizes
(60, 111), [2, 3]),

21 
SSDS³c
(10, 32, 
SSDBoxSizes
(111, 162), [2, 3]),

22 
SSDS³c
(5, 64, 
SSDBoxSizes
(162, 213), [2, 3]),

23 
SSDS³c
(3, 100, 
SSDBoxSizes
(213, 264), [2]),

24 
SSDS³c
(1, 300, 
SSDBoxSizes
(264, 315), [2])

26 
	gimage_size
: 
image
 
size
.

27 
şamp
: 
Œue
, cÏm°
the
 
v®ues
 
to
 
make
 
çÎ
 
	gb‘w“n
 [0.0, 1.0]

28 
	gR‘uºs
:

29 
	$´iÜs
 (
num_´iÜs
, 4): 
The
 
´iÜ
 
boxes
 
»´e£Áed
 
as
 [[
ûÁ”_x
, 
ûÁ”_y
, 
w
, 
h
]]. 
AÎ
 
the
 
v®ues


30 
¬e
 
»Ïtive
 
to
 
the
 
image
 
size
.

32 
´iÜs
 = []

33 
¥ec
 
š
 
¥ecs
:

34 
sÿË
 = 
image_size
 / 
¥ec
.
shrškage


35 
j
, 
i
 
š
 
™”toŞs
.
	`´oduù
(
	`¿nge
(
¥ec
.
ã©u»_m­_size
), 
»³©
=2):

36 
x_ûÁ”
 = (
i
 + 0.5è/ 
sÿË


37 
y_ûÁ”
 = (
j
 + 0.5è/ 
sÿË


39 #sm®È
sized
 
squ¬e
 
box


40 
size
 = 
¥ec
.
box_sizes
.
mš


41 
h
 = 
w
 = 
size
 / 
image_size


42 
´iÜs
.
	$­³nd
([

43 
x_ûÁ”
,

44 
y_ûÁ”
,

45 
w
,

46 
h


49 #big 
sized
 
squ¬e
 
box


50 
size
 = 
m©h
.
	$sq¹
(
¥ec
.
box_sizes
.
max
 * s³c.box_sizes.
mš
)

51 
h
 = 
w
 = 
size
 / 
image_size


52 
´iÜs
.
	$­³nd
([

53 
x_ûÁ”
,

54 
y_ûÁ”
,

55 
w
,

56 
h


59 #chªg
h
/
w
 
¿tio
 
of
 
the
 
sm®l
 
sized
 
box


60 
size
 = 
¥ec
.
box_sizes
.
mš


61 
h
 = 
w
 = 
size
 / 
image_size


62 
¿tio
 
š
 
¥ec
.
a¥eù_¿tios
:

63 
¿tio
 = 
m©h
.
	$sq¹
(
¿tio
)

64 
´iÜs
.
	`­³nd
([

65 
x_ûÁ”
,

66 
y_ûÁ”
,

67 
w
 * 
¿tio
,

68 
h
 / 
¿tio


70 
´iÜs
.
	`­³nd
([

71 
x_ûÁ”
,

72 
y_ûÁ”
,

73 
w
 / 
¿tio
,

74 
h
 * 
¿tio


77 
´iÜs
 = 
tÜch
.
	$‹nsÜ
(
´iÜs
)

78 
şamp
:

79 
tÜch
.
	$şamp
(
´iÜs
, 0.0, 1.0, 
out
=priors)

80  
´iÜs


83 
def
 
	$cÚv”t_loÿtiÚs_to_boxes
(
loÿtiÚs
, 
´iÜs
, 
ûÁ”_v¬Ÿnû
,

84 
size_v¬Ÿnû
):

87 
The
 
cÚv”siÚ
:

88 
$$´ediùed
\
_ûÁ”
 * 
ûÁ”_v¬Ÿnû
 = \
äac
 {
»®
\_ûÁ” - 
´iÜ
\
	}
_ûÁ”} {´iÜ\
_hw
}
$$


89 
$$exp
(
´ediùed
\
_hw
 * 
size_v¬Ÿnû
èğ\
äac
 {
»®
\_hw} {
´iÜ
\_hw}
$$


90 
We
 dØ
™
 
š
 
the
 
šv”£
 
dœeùiÚ
 
h”e
.

91 
Args
:

92 
	$loÿtiÚs
 (
b©ch_size
, 
num_´iÜs
, 4): 
the
 
»g»ssiÚ
 
ouut
 
of
 
SSD
. 
It
 
wl
 
cÚš
h
ouuts
 
as
 
w–l
.

93 
	$´iÜs
 (
num_´iÜs
, 4è
	`Ü
 (
b©ch_size
/1,‚um_´iÜs, 4): 
´iÜ
 
boxes
.

94 
ûÁ”_v¬Ÿnû
: 
a
 
u£d
 
to
 
chªge
 
the
 
sÿË
 
of
 
ûÁ”
.

95 
size_v¬Ÿnû
: 
a
 
u£d
 
to
 
chªge
 
of
 
sÿË
 oà
size
.

96 
R‘uºs
:

97 
boxes
: 
´iÜs
: [[
ûÁ”_x
, 
ûÁ”_y
, 
h
, 
w
]]. 
AÎ
 
the
 
v®ues


98 
¬e
 
»Ïtive
 
to
 
the
 
image
 
size
.

100 #´iÜ 
ÿn
 
have
 
Úe
 
dim’siÚ
 
Ëss
.

101 
´iÜs
.
	`dim
(è+ 1 =ğ
loÿtiÚs
.
	$dim
():

102 
´iÜs
 =…riÜs.
	$unsqu“ze
(0)

103  
tÜch
.
	`ÿt
([

104 
loÿtiÚs
[..., :2] * 
ûÁ”_v¬Ÿnû
 * 
´iÜs
[..., 2:] +…riors[..., :2],

105 
tÜch
.
	`exp
(
loÿtiÚs
[..., 2:] * 
size_v¬Ÿnû
è* 
´iÜs
[..., 2:]

106 ], 
dim
=
loÿtiÚs
.
	`dim
() - 1)

109 
def
 
	$cÚv”t_boxes_to_loÿtiÚs
(
ûÁ”_fÜm_boxes
, 
ûÁ”_fÜm_´iÜs
, 
ûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû
):

110 #´iÜ 
ÿn
 
have
 
Úe
 
dim’siÚ
 
Ëss


111 
ûÁ”_fÜm_´iÜs
.
	`dim
(è+ 1 =ğ
ûÁ”_fÜm_boxes
.
	$dim
():

112 
ûÁ”_fÜm_´iÜs
 = c’‹r_fÜm_´iÜs.
	$unsqu“ze
(0)

113  
tÜch
.
	`ÿt
([

114 (
ûÁ”_fÜm_boxes
[..., :2] - 
ûÁ”_fÜm_´iÜs
[..., :2]è/ c’‹r_fÜm_´iÜs[..., 2:] / 
ûÁ”_v¬Ÿnû
,

115 
tÜch
.
	`log
(
ûÁ”_fÜm_boxes
[..., 2:] / 
ûÁ”_fÜm_´iÜs
[..., 2:]è/ 
size_v¬Ÿnû


116 ], 
dim
=
ûÁ”_fÜm_boxes
.
	`dim
() - 1)

119 
def
 
	`¬—_of
(
Ëá_tİ
, 
right_bÙtom
è-> 
tÜch
.
T’sÜ
:

122 
Args
:

123 
	$Ëá_tİ
 (
N
, 2): 
Ëá
 
tİ
 
cÜÃr
.

124 
	$right_bÙtom
 (
N
, 2): 
right
 
bÙtom
 
cÜÃr
.

126 
R‘uºs
:

127 
	$¬—
 (
N
):  
the
 
¬—
.

129 
hw
 = 
tÜch
.
	`şamp
(
right_bÙtom
 - 
Ëá_tİ
, 
mš
=0.0)

130  
hw
[..., 0] * hw[..., 1]

133 
def
 
	`iou_of
(
boxes0
, 
boxes1
, 
•s
=1e-5):

136 
Args
:

137 
	$boxes0
 (
N
, 4): 
ground
 
Œuth
 
boxes
.

138 
	$boxes1
 (
N
 
Ü
 1, 4): 
´ediùed
 
boxes
.

139 
•s
: 
a
 
sm®l
 
numb”
 
to
 
avoid
 0 
as
 
d’omš©Ü
.

140 
R‘uºs
:

141 
	$iou
 (
N
): 
IoU
 
v®ues
.

143 
ov”Ïp_Ëá_tİ
 = 
tÜch
.
	$max
(
boxes0
[..., :2], 
boxes1
[..., :2])

144 
ov”Ïp_right_bÙtom
 = 
tÜch
.
	$mš
(
boxes0
[..., 2:], 
boxes1
[..., 2:])

146 
ov”Ïp_¬—
 = 
	$¬—_of
(
ov”Ïp_Ëá_tİ
, 
ov”Ïp_right_bÙtom
)

147 
¬—0
 = 
	$¬—_of
(
boxes0
[..., :2], boxes0[..., 2:])

148 
¬—1
 = 
	$¬—_of
(
boxes1
[..., :2], boxes1[..., 2:])

149  
ov”Ïp_¬—
 / (
¬—0
 + 
¬—1
 - ov”Ïp_¬— + 
•s
)

152 #DISTANCE 
CHANGE


153 #deà
	`assign_´iÜs
(
gt_boxes
, 
gt_Ïb–s
, 
cÜÃr_fÜm_´iÜs
,

154 
def
 
	$assign_´iÜs
(
gt_boxes
, 
gt_Ïb–s
, 
gt_di¡
, 
cÜÃr_fÜm_´iÜs
,

155 
iou_th»shŞd
):

158 
Args
:

159 
	$gt_boxes
 (
num_rg‘s
, 4): 
ground
 
Œuth
 
boxes
.

160 
	$gt_Ïb–s
 (
num_rg‘s
): 
Ïb–s
 
of
 
rg‘s
.

161 #DISTANCE 
CHANGE


162 
	$gt_di¡
 (
num_rg‘s
): 
ground
 
Œuth
 
di¡ªûs
 
of
 
rg‘s


163 
	$´iÜs
 (
num_´iÜs
, 4): 
cÜÃr
 
fÜm
 
´iÜs


164 
R‘uºs
:

165 
	$boxes
 (
num_´iÜs
, 4): 
»®
 
v®ues
 
´iÜs
.

166 
	$Ïb–s
 (
num_´œos
): 
Ïb–s
 
´iÜs
.

168 #size: 
num_´iÜs
 
x
 
num_rg‘s


169 
ious
 = 
	`iou_of
(
gt_boxes
.
	`unsqu“ze
(0), 
cÜÃr_fÜm_´iÜs
.
	$unsqu“ze
(1))

170 #size: 
num_´iÜs


171 
be¡_rg‘_³r_´iÜ
, 
be¡_rg‘_³r_´iÜ_šdex
 = 
ious
.
	$max
(1)

172 #size: 
num_rg‘s


173 
be¡_´iÜ_³r_rg‘
, 
be¡_´iÜ_³r_rg‘_šdex
 = 
ious
.
	$max
(0)

175 
rg‘_šdex
, 
´iÜ_šdex
 
š
 
	$’um”©e
(
be¡_´iÜ_³r_rg‘_šdex
):

176 
be¡_rg‘_³r_´iÜ_šdex
[
´iÜ_šdex
] = 
rg‘_šdex


178 #2.0 
is
 
u£d
 
to
 
make
 
su»
 
ev”y
 
rg‘
 
has
 
a
 
´iÜ
 
assigÃd


179 
be¡_rg‘_³r_´iÜ
.
	$šdex_fl_
(0, 
be¡_´iÜ_³r_rg‘_šdex
, 2)

180 #size: 
num_´iÜs


181 
Ïb–s
 = 
gt_Ïb–s
[
be¡_rg‘_³r_´iÜ_šdex
]

182 
Ïb–s
[
be¡_rg‘_³r_´iÜ
 < 
iou_th»shŞd
] = 0 #th
backgouºd
 
id


183 
boxes
 = 
gt_boxes
[
be¡_rg‘_³r_´iÜ_šdex
]

184 #DISTANCE 
CHANGE


185 
di¡ªûs
 = 
gt_di¡
[
be¡_rg‘_³r_´iÜ_šdex
]

186 
di¡ªûs
[
be¡_rg‘_³r_´iÜ
 < 
iou_th»shŞd
] = 0

187  
boxes
, 
Ïb–s
, 
di¡ªûs


190 
def
 
	$h¬d_Ãg©ive_mššg
(
loss
, 
Ïb–s
, 
Ãg_pos_¿tio
):

192 
It
 
u£d
 
to
 
suµ»ss
 
the
 
´e£nû
 
of
 
a
 
Ïrge
 
numb”
 oà
Ãg©ive
 
´ediùiÚ
.

193 
It
 
wÜks
 
Ú
 
image
 
Ëv–
 
nÙ
 
b©ch
†evel.

194 
FÜ
 
ªy
 
exam¶e
/
image
, 
™
 
k“ps
 
®l
 
the
 
pos™ive
 
´ediùiÚs
 
ªd


195 
cut
 
the
 
numb”
 
of
 
Ãg©ive
 
´ediùiÚs
 
to
 
make
 
su»
h
¿tio


196 
b‘w“n
 
the
 
Ãg©ive
 
exam¶es
 
ªd
 
pos™ive
ƒxam¶e 
is
 
no
 
mÜe


197 
the
 
giv’
 
¿tio
 
ª
 
image
.

199 
Args
:

200 
	$loss
 (
N
, 
num_´iÜs
): 
the
 
loss
 
—ch
 
exam¶e
.

201 
	$Ïb–s
 (
N
, 
num_´iÜs
): 
the
 
Ïb–s
.

202 
Ãg_pos_¿tio
: 
the
 
¿tio
 
b‘w“n
h
Ãg©ive
 
exam¶es
 
ªd
 
pos™ive
ƒxamples.

204 
pos_mask
 = 
Ïb–s
 > 0

205 
num_pos
 = 
pos_mask
.().
	$sum
(
dim
=1, 
k“pdim
=
True
)

206 
num_Ãg
 = 
num_pos
 * 
Ãg_pos_¿tio


208 
loss
[
pos_mask
] = -
m©h
.
šf


209 
_
, 
šdexes
 = 
loss
.
	$sÜt
(
dim
=1, 
desûndšg
=
True
)

210 
_
, 
Üd”s
 = 
šdexes
.
	$sÜt
(
dim
=1)

211 
Ãg_mask
 = 
Üd”s
 < 
num_Ãg


212  
pos_mask
 | 
Ãg_mask


215 
def
 
	$ûÁ”_fÜm_to_cÜÃr_fÜm
(
loÿtiÚs
):

216  
tÜch
.
	`ÿt
([
loÿtiÚs
[..., :2] -†ocations[..., 2:]/2,

217 
loÿtiÚs
[..., :2] +†oÿtiÚs[..., 2:]/2],†oÿtiÚs.
	`dim
() - 1)

220 
def
 
	$cÜÃr_fÜm_to_ûÁ”_fÜm
(
boxes
):

221  
tÜch
.
	`ÿt
([

222 (
boxes
[..., :2] + boxes[..., 2:]) / 2,

223 
boxes
[..., 2:] - boxes[..., :2]

224 ], 
boxes
.
	`dim
() - 1)

227 
def
 
	`h¬d_nms
(
box_scÜes
, 
iou_th»shŞd
, 
tİ_k
=-1, 
ÿndid©e_size
=200):

230 
Args
:

231 
	$box_scÜes
 (
N
, 5): 
boxes
 
š
 
cÜÃr
-
fÜm
 
ªd
 
´obab™›s
.

232 
iou_th»shŞd
: 
š‹r£ùiÚ
 
ov”
 
th»shŞd
.

233 
tİ_k
: 
k“p
İ_k 
»suÉs
. 
If
 
k
 <ğ0, k“°
®l
 
the
„esults.

234 
ÿndid©e_size
: 
Úly
 
cÚsid”
 
the
 
ÿndid©es
 
w™h
h
highe¡
 
scÜes
.

235 
R‘uºs
:

236 
picked
: 
a
 
li¡
 
of
 
šdexes
 oà
the
 
k•t
 
boxes


238 
scÜes
 = 
box_scÜes
[:, -1]

239 
boxes
 = 
box_scÜes
[:, :-1]

240 
picked
 = []

241 
_
, 
šdexes
 = 
scÜes
.
	$sÜt
(
desûndšg
=
True
)

242 
šdexes
 = indexes[:
ÿndid©e_size
]

243 
	`Ën
(
šdexes
) > 0:

244 
cu¼’t
 = 
šdexes
[0]

245 
picked
.
	`­³nd
(
cu¼’t
.
	$™em
())

246 0 < 
tİ_k
 =ğ
	$Ën
(
picked
è
Ü
 
	`Ën
(
šdexes
) == 1:

248 
cu¼’t_box
 = 
boxes
[
cu¼’t
, :]

249 
šdexes
 = indexes[1:]

250 
»¡_boxes
 = 
boxes
[
šdexes
, :]

251 
iou
 = 
	`iou_of
(

252 
»¡_boxes
,

253 
cu¼’t_box
.
	`unsqu“ze
(0),

255 
šdexes
 = indexes[
iou
 <ğ
iou_th»shŞd
]

257  
box_scÜes
[
picked
, :]

260 
def
 
	`nms
(
box_scÜes
, 
nms_m‘hod
=
NÚe
, 
scÜe_th»shŞd
=NÚe, 
iou_th»shŞd
=None,

261 
sigma
=0.5, 
tİ_k
=-1, 
ÿndid©e_size
=200):

262 
nms_m‘hod
 == "soft":

263  
	$soá_nms
(
box_scÜes
, 
scÜe_th»shŞd
, 
sigma
, 
tİ_k
)

265  
	$h¬d_nms
(
box_scÜes
, 
iou_th»shŞd
, 
tİ_k
, 
ÿndid©e_size
=candidate_size)

268 
def
 
	`soá_nms
(
box_scÜes
, 
scÜe_th»shŞd
, 
sigma
=0.5, 
tİ_k
=-1):

271 
Reã»nûs
:

272 
h‰ps
:

273 
h‰ps
:

275 
Args
:

276 
	$box_scÜes
 (
N
, 5): 
boxes
 
š
 
cÜÃr
-
fÜm
 
ªd
 
´obab™›s
.

277 
scÜe_th»shŞd
: 
boxes
 
w™h
 
scÜes
 
Ëss
 
thª
 
v®ue
 
¬e
 
nÙ
 
cÚsid”ed
.

278 
sigma
: 
the
 
·¿m‘”
 
š
 
scÜe
 
»
-
computiÚ
.

279 
scÜes
[
i
] = scÜes[i] * 
	`exp
(-(
iou_i
)^2 / 
simga
)

280 
tİ_k
: 
k“p
İ_k 
»suÉs
. 
If
 
k
 <ğ0, k“°
®l
 
the
„esults.

281 
R‘uºs
:

282 
	$picked_box_scÜes
 (
K
, 5): 
»suÉs
 
of
 
NMS
.

284 
picked_box_scÜes
 = []

285 
box_scÜes
.
	`size
(0) > 0:

286 
max_scÜe_šdex
 = 
tÜch
.
	$¬gmax
(
box_scÜes
[:, 4])

287 
cur_box_´ob
 = 
tÜch
.
	$‹nsÜ
(
box_scÜes
[
max_scÜe_šdex
, :])

288 
picked_box_scÜes
.
	$­³nd
(
cur_box_´ob
)

289 
	`Ën
(
picked_box_scÜes
è=ğ
tİ_k
 > 0 
Ü
 
box_scÜes
.
	`size
(0) == 1:

291 
cur_box
 = 
cur_box_´ob
[:-1]

292 
box_scÜes
[
max_scÜe_šdex
, :] = box_scores[-1, :]

293 
box_scÜes
 = box_scores[:-1, :]

294 
ious
 = 
	`iou_of
(
cur_box
.
	`unsqu“ze
(0), 
box_scÜes
[:, :-1])

295 
box_scÜes
[:, -1] = box_scÜes[:, -1] * 
tÜch
.
	`exp
(-(
ious
 * iousè/ 
sigma
)

296 
box_scÜes
 = box_scÜes[box_scÜes[:, -1] > 
scÜe_th»shŞd
, :]

297 
	`Ën
(
picked_box_scÜes
) > 0:

298  
tÜch
.
	$¡ack
(
picked_box_scÜes
)

300  
tÜch
.
	`‹nsÜ
([])

	@vision/utils/box_utils_numpy.py

1 
	gäom
 .
box_uts
 
impÜt
 
SSDS³c


3 
äom
 
typšg
 
impÜt
 
Li¡


4 
impÜt
 
™”toŞs


5 
impÜt
 
m©h


6 
impÜt
 
numpy
 
as
 
Å


9 
def
 
	$g’”©e_ssd_´iÜs
(
¥ecs
: 
Li¡
[
SSDS³c
], 
image_size
, 
şamp
=
True
):

12 
It
 
»tuºs
 
the
 
ûÁ”
, 
height
 
ªd
 
width
 
of
h
´iÜs
. 
The
 
v®ues
 
¬e
 
»Ïtive
 
to
h
image
 
size


13 
Args
:

14 
¥ecs
: 
SSDS³cs
 
about
 
the
 
sh­es
 
of
 
sizes
 oà
´iÜ
 
boxes
. 
i
.
e
.

15 
¥ecs
 = [

16 
	`SSDS³c
(38, 8, 
	`SSDBoxSizes
(30, 60), [2]),

17 
	`SSDS³c
(19, 16, 
	`SSDBoxSizes
(60, 111), [2, 3]),

18 
	`SSDS³c
(10, 32, 
	`SSDBoxSizes
(111, 162), [2, 3]),

19 
	`SSDS³c
(5, 64, 
	`SSDBoxSizes
(162, 213), [2, 3]),

20 
	`SSDS³c
(3, 100, 
	`SSDBoxSizes
(213, 264), [2]),

21 
	`SSDS³c
(1, 300, 
	`SSDBoxSizes
(264, 315), [2])

23 
image_size
: 
image
 
size
.

24 
şamp
: 
Œue
, cÏm°
the
 
v®ues
 
to
 
make
 
çÎ
 
b‘w“n
 [0.0, 1.0]

25 
R‘uºs
:

26 
	$´iÜs
 (
num_´iÜs
, 4): 
The
 
´iÜ
 
boxes
 
»´e£Áed
 
as
 [[
ûÁ”_x
, 
ûÁ”_y
, 
w
, 
h
]]. 
AÎ
 
the
 
v®ues


27 
¬e
 
»Ïtive
 
to
 
the
 
image
 
size
.

29 
´iÜs
 = []

30 
¥ec
 
š
 
¥ecs
:

31 
sÿË
 = 
image_size
 / 
¥ec
.
shrškage


32 
j
, 
i
 
š
 
™”toŞs
.
	`´oduù
(
	`¿nge
(
¥ec
.
ã©u»_m­_size
), 
»³©
=2):

33 
x_ûÁ”
 = (
i
 + 0.5è/ 
sÿË


34 
y_ûÁ”
 = (
j
 + 0.5è/ 
sÿË


36 #sm®È
sized
 
squ¬e
 
box


37 
size
 = 
¥ec
.
box_sizes
.
mš


38 
h
 = 
w
 = 
size
 / 
image_size


39 
´iÜs
.
	$­³nd
([

40 
x_ûÁ”
,

41 
y_ûÁ”
,

42 
w
,

43 
h


46 #big 
sized
 
squ¬e
 
box


47 
size
 = 
m©h
.
	$sq¹
(
¥ec
.
box_sizes
.
max
 * s³c.box_sizes.
mš
)

48 
h
 = 
w
 = 
size
 / 
image_size


49 
´iÜs
.
	$­³nd
([

50 
x_ûÁ”
,

51 
y_ûÁ”
,

52 
w
,

53 
h


56 #chªg
h
/
w
 
¿tio
 
of
 
the
 
sm®l
 
sized
 
box


57 
size
 = 
¥ec
.
box_sizes
.
mš


58 
h
 = 
w
 = 
size
 / 
image_size


59 
¿tio
 
š
 
¥ec
.
a¥eù_¿tios
:

60 
¿tio
 = 
m©h
.
	$sq¹
(
¿tio
)

61 
´iÜs
.
	`­³nd
([

62 
x_ûÁ”
,

63 
y_ûÁ”
,

64 
w
 * 
¿tio
,

65 
h
 / 
¿tio


67 
´iÜs
.
	`­³nd
([

68 
x_ûÁ”
,

69 
y_ûÁ”
,

70 
w
 / 
¿tio
,

71 
h
 * 
¿tio


74 
´iÜs
 = 
Å
.
	$¬¿y
(
´iÜs
, 
dty³
=
Å
.
æßt32
)

75 
şamp
:

76 
Å
.
	$ş
(
´iÜs
, 0.0, 1.0, 
out
=priors)

77  
´iÜs


80 
def
 
	$cÚv”t_loÿtiÚs_to_boxes
(
loÿtiÚs
, 
´iÜs
, 
ûÁ”_v¬Ÿnû
,

81 
size_v¬Ÿnû
):

84 
The
 
cÚv”siÚ
:

85 
$$´ediùed
\
_ûÁ”
 * 
ûÁ”_v¬Ÿnû
 = \
äac
 {
»®
\_ûÁ” - 
´iÜ
\
	}
_ûÁ”} {´iÜ\
_hw
}
$$


86 
$$exp
(
´ediùed
\
_hw
 * 
size_v¬Ÿnû
èğ\
äac
 {
»®
\_hw} {
´iÜ
\_hw}
$$


87 
We
 dØ
™
 
š
 
the
 
šv”£
 
dœeùiÚ
 
h”e
.

88 
Args
:

89 
	$loÿtiÚs
 (
b©ch_size
, 
num_´iÜs
, 4): 
the
 
»g»ssiÚ
 
ouut
 
of
 
SSD
. 
It
 
wl
 
cÚš
h
ouuts
 
as
 
w–l
.

90 
	$´iÜs
 (
num_´iÜs
, 4è
	`Ü
 (
b©ch_size
/1,‚um_´iÜs, 4): 
´iÜ
 
boxes
.

91 
ûÁ”_v¬Ÿnû
: 
a
 
u£d
 
to
 
chªge
 
the
 
sÿË
 
of
 
ûÁ”
.

92 
size_v¬Ÿnû
: 
a
 
u£d
 
to
 
chªge
 
of
 
sÿË
 oà
size
.

93 
R‘uºs
:

94 
boxes
: 
´iÜs
: [[
ûÁ”_x
, 
ûÁ”_y
, 
h
, 
w
]]. 
AÎ
 
the
 
v®ues


95 
¬e
 
»Ïtive
 
to
 
the
 
image
 
size
.

97 #´iÜ 
ÿn
 
have
 
Úe
 
dim’siÚ
 
Ëss
.

98 
	`Ën
(
´iÜs
.
sh­e
è+ 1 =ğ
	$Ën
(
loÿtiÚs
.
sh­e
):

99 
´iÜs
 = 
Å
.
	$ex·nd_dims
(
´iÜs
, 0)

100  
Å
.
	`cÚÿ‹Ç‹
([

101 
loÿtiÚs
[..., :2] * 
ûÁ”_v¬Ÿnû
 * 
´iÜs
[..., 2:] +…riors[..., :2],

102 
Å
.
	`exp
(
loÿtiÚs
[..., 2:] * 
size_v¬Ÿnû
è* 
´iÜs
[..., 2:]

103 ], 
axis
=
	`Ën
(
loÿtiÚs
.
sh­e
) - 1)

106 
def
 
	$cÚv”t_boxes_to_loÿtiÚs
(
ûÁ”_fÜm_boxes
, 
ûÁ”_fÜm_´iÜs
, 
ûÁ”_v¬Ÿnû
, 
size_v¬Ÿnû
):

107 #´iÜ 
ÿn
 
have
 
Úe
 
dim’siÚ
 
Ëss


108 
	`Ën
(
ûÁ”_fÜm_´iÜs
.
sh­e
è+ 1 =ğ
	$Ën
(
ûÁ”_fÜm_boxes
.
sh­e
):

109 
ûÁ”_fÜm_´iÜs
 = 
Å
.
	$ex·nd_dims
(
ûÁ”_fÜm_´iÜs
, 0)

110  
Å
.
	`cÚÿ‹Ç‹
([

111 (
ûÁ”_fÜm_boxes
[..., :2] - 
ûÁ”_fÜm_´iÜs
[..., :2]è/ c’‹r_fÜm_´iÜs[..., 2:] / 
ûÁ”_v¬Ÿnû
,

112 
Å
.
	`log
(
ûÁ”_fÜm_boxes
[..., 2:] / 
ûÁ”_fÜm_´iÜs
[..., 2:]è/ 
size_v¬Ÿnû


113 ], 
axis
=
	`Ën
(
ûÁ”_fÜm_boxes
.
sh­e
) - 1)

116 
def
 
	$¬—_of
(
Ëá_tİ
, 
right_bÙtom
):

119 
Args
:

120 
	$Ëá_tİ
 (
N
, 2): 
Ëá
 
tİ
 
cÜÃr
.

121 
	$right_bÙtom
 (
N
, 2): 
right
 
bÙtom
 
cÜÃr
.

123 
R‘uºs
:

124 
	$¬—
 (
N
):  
the
 
¬—
.

126 
hw
 = 
Å
.
	`ş
(
right_bÙtom
 - 
Ëá_tİ
, 0.0, 
NÚe
)

127  
hw
[..., 0] * hw[..., 1]

130 
def
 
	`iou_of
(
boxes0
, 
boxes1
, 
•s
=1e-5):

133 
Args
:

134 
	$boxes0
 (
N
, 4): 
ground
 
Œuth
 
boxes
.

135 
	$boxes1
 (
N
 
Ü
 1, 4): 
´ediùed
 
boxes
.

136 
•s
: 
a
 
sm®l
 
numb”
 
to
 
avoid
 0 
as
 
d’omš©Ü
.

137 
R‘uºs
:

138 
	$iou
 (
N
): 
IoU
 
v®ues
.

140 
ov”Ïp_Ëá_tİ
 = 
Å
.
	$maximum
(
boxes0
[..., :2], 
boxes1
[..., :2])

141 
ov”Ïp_right_bÙtom
 = 
Å
.
	$mšimum
(
boxes0
[..., 2:], 
boxes1
[..., 2:])

143 
ov”Ïp_¬—
 = 
	$¬—_of
(
ov”Ïp_Ëá_tİ
, 
ov”Ïp_right_bÙtom
)

144 
¬—0
 = 
	$¬—_of
(
boxes0
[..., :2], boxes0[..., 2:])

145 
¬—1
 = 
	$¬—_of
(
boxes1
[..., :2], boxes1[..., 2:])

146  
ov”Ïp_¬—
 / (
¬—0
 + 
¬—1
 - ov”Ïp_¬— + 
•s
)

149 
def
 
	$ûÁ”_fÜm_to_cÜÃr_fÜm
(
loÿtiÚs
):

150  
Å
.
	`cÚÿ‹Ç‹
([
loÿtiÚs
[..., :2] -†ocations[..., 2:]/2,

151 
loÿtiÚs
[..., :2] +†oÿtiÚs[..., 2:]/2], 
	`Ën
ÖoÿtiÚs.
sh­e
) - 1)

154 
def
 
	$cÜÃr_fÜm_to_ûÁ”_fÜm
(
boxes
):

155  
Å
.
	`cÚÿ‹Ç‹
([

156 (
boxes
[..., :2] + boxes[..., 2:]) / 2,

157 
boxes
[..., 2:] - boxes[..., :2]

158 ], 
	`Ën
(
boxes
.
sh­e
) - 1)

161 
def
 
	`h¬d_nms
(
box_scÜes
, 
iou_th»shŞd
, 
tİ_k
=-1, 
ÿndid©e_size
=200):

164 
Args
:

165 
	$box_scÜes
 (
N
, 5): 
boxes
 
š
 
cÜÃr
-
fÜm
 
ªd
 
´obab™›s
.

166 
iou_th»shŞd
: 
š‹r£ùiÚ
 
ov”
 
th»shŞd
.

167 
tİ_k
: 
k“p
İ_k 
»suÉs
. 
If
 
k
 <ğ0, k“°
®l
 
the
„esults.

168 
ÿndid©e_size
: 
Úly
 
cÚsid”
 
the
 
ÿndid©es
 
w™h
h
highe¡
 
scÜes
.

169 
R‘uºs
:

170 
picked
: 
a
 
li¡
 
of
 
šdexes
 oà
the
 
k•t
 
boxes


172 
scÜes
 = 
box_scÜes
[:, -1]

173 
boxes
 = 
box_scÜes
[:, :-1]

174 
picked
 = []

175 #_, 
šdexes
 = 
scÜes
.
	`sÜt
(
desûndšg
=
True
)

176 
šdexes
 = 
Å
.
	$¬gsÜt
(
scÜes
)

177 #šdexe ğ
šdexes
[:
ÿndid©e_size
]

178 
šdexes
 = indexes[-
ÿndid©e_size
:]

179 
	`Ën
(
šdexes
) > 0:

180 #cu¼’ˆğ
šdexes
[0]

181 
cu¼’t
 = 
šdexes
[-1]

182 
picked
.
	$­³nd
(
cu¼’t
)

183 0 < 
tİ_k
 =ğ
	$Ën
(
picked
è
Ü
 
	`Ën
(
šdexes
) == 1:

185 
cu¼’t_box
 = 
boxes
[
cu¼’t
, :]

186 #šdexe ğ
šdexes
[1:]

187 
šdexes
 = indexes[:-1]

188 
»¡_boxes
 = 
boxes
[
šdexes
, :]

189 
iou
 = 
	`iou_of
(

190 
»¡_boxes
,

191 
Å
.
	`ex·nd_dims
(
cu¼’t_box
, 
axis
=0),

193 
šdexes
 = indexes[
iou
 <ğ
iou_th»shŞd
]

195  
box_scÜes
[
picked
, :]

198 #deà
	`nms
(
box_scÜes
, 
nms_m‘hod
=
NÚe
, 
scÜe_th»shŞd
=NÚe, 
iou_th»shŞd
=None,

199 #sigma=0.5, 
tİ_k
=-1, 
ÿndid©e_size
=200):

200 #ià
nms_m‘hod
 == "soft":

201 #»tuº 
	`soá_nms
(
box_scÜes
, 
scÜe_th»shŞd
, 
sigma
, 
tİ_k
)

203 #»tuº 
	`h¬d_nms
(
box_scÜes
, 
iou_th»shŞd
, 
tİ_k
, 
ÿndid©e_size
=candidate_size)

205 #
#deà
	`soá_nms
(
box_scÜes
, 
scÜe_th»shŞd
, 
sigma
=0.5, 
tİ_k
=-1):

207 #"""
Soá
 
NMS
 
im¶em’tiÚ
.

214 #box_scÜe (
N
, 5): 
boxes
 
š
 
cÜÃr
-
fÜm
 
ªd
 
´obab™›s
.

215 #scÜe_th»shŞd: 
boxes
 
w™h
 
scÜes
 
Ëss
 
thª
 
v®ue
 
¬e
 
nÙ
 
cÚsid”ed
.

216 #sigma: 
the
 
·¿m‘”
 
š
 
scÜe
 
»
-
computiÚ
.

217 #scÜes[
i
] = 
scÜes
[i] * 
	`exp
(-(
iou_i
)^2 / 
simga
)

218 #tİ_k: 
k“p
 
tİ_k
 
»suÉs
. 
If
 
k
 <ğ0, k“°
®l
 
the
„esults.

220 #picked_box_scÜe (
K
, 5): 
»suÉs
 
of
 
NMS
.

223 #wh
box_scÜes
.
	`size
(0) > 0:

224 #max_scÜe_šdex = 
tÜch
.
	`¬gmax
(
box_scÜes
[:, 4])

225 #cur_box_´ob = 
tÜch
.
	`‹nsÜ
(
box_scÜes
[
max_scÜe_šdex
, :])

226 #picked_box_scÜes.
	`­³nd
(
cur_box_´ob
)

227 #ià
	`Ën
(
picked_box_scÜes
è=ğ
tİ_k
 > 0 
Ü
 
box_scÜes
.
	`size
(0) == 1:

229 #cur_box = 
cur_box_´ob
[:-1]

230 #box_scÜes[
max_scÜe_šdex
, :] = 
box_scÜes
[-1, :]

231 #box_scÜe ğ
box_scÜes
[:-1, :]

232 #iou ğ
	`iou_of
(
cur_box
.
	`unsqu“ze
(0), 
box_scÜes
[:, :-1])

233 #box_scÜes[:, -1] = 
box_scÜes
[:, -1] * 
tÜch
.
	`exp
(-(
ious
 * iousè/ 
sigma
)

234 #box_scÜe ğ
box_scÜes
[box_scÜes[:, -1] > 
scÜe_th»shŞd
, :]

235 #ià
	`Ën
(
picked_box_scÜes
) > 0:

236 #»tuº 
tÜch
.
	`¡ack
(
picked_box_scÜes
)

238 #»tuº 
tÜch
.
	`‹nsÜ
([])

	@vision/utils/measurements.py

1 
impÜt
 
numpy
 
as
 
Å


4 
def
 
	$compu‹_av”age_´ecisiÚ
(
´ecisiÚ
, 
»ÿÎ
):

6 
It
 
compu‹s
 
av”age
 
´ecisiÚ
 
ba£d
 
Ú
 
the
 
defš™iÚ
 
of
 
Pasÿl
 
Com³t™iÚ
. Iˆcompu‹ th
und”
 
curve
 
¬—


7 
of
 
´ecisiÚ
 
ªd
 
»ÿÎ
. 
ReÿÎ
 
fŞlows
 
the
 
nÜm®
 
defš™iÚ
. 
P»cisiÚ
 
is
 
a
 
v¬ŸÁ
.

8 
·sÿl_´ecisiÚ
[
i
] = 
typiÿl_´ecisiÚ
[i:].
	`max
()

10 #id’tiÿÈ
but
 
ç¡”
 
v”siÚ
 
of
 
Ãw_´ecisiÚ
[
i
] = 
Şd_´ecisiÚ
[i:].
	`max
()

11 
´ecisiÚ
 = 
Å
.
	$cÚÿ‹Ç‹
([[0.0], 
´ecisiÚ
, [0.0]])

12 
i
 
š
 
	`¿nge
(
	`Ën
(
´ecisiÚ
) - 1, 0, -1):

13 
´ecisiÚ
[
i
 - 1] = 
Å
.
	`maximum
(precision[i - 1],…recision[i])

15 #fšd 
the
 
šdex
 
wh”e
h
v®ue
 
chªges


16 
»ÿÎ
 = 
Å
.
	$cÚÿ‹Ç‹
([[0.0], 
»ÿÎ
, [1.0]])

17 
chªgšg_pošts
 = 
Å
.
	`wh”e
(
»ÿÎ
[1:] !=„ecall[:-1])[0]

19 #compu‹ 
und”
 
curve
 
¬—


20 
¬—s
 = (
»ÿÎ
[
chªgšg_pošts
 + 1] -„eÿÎ[chªgšg_pošts]è* 
´ecisiÚ
[changing_points + 1]

21  
¬—s
.
	$sum
()

24 
def
 
	$compu‹_voc2007_av”age_´ecisiÚ
(
´ecisiÚ
, 
»ÿÎ
):

25 
­
 = 0.

26 
t
 
š
 
Å
.
	$¬ªge
(0., 1.1, 0.1):

27 
Å
.
	`sum
(
»ÿÎ
 >ğ
t
) == 0:

28 
p
 = 0

30 
p
 = 
Å
.
	`max
(
´ecisiÚ
[
»ÿÎ
 >ğ
t
])

31 
­
 =‡°+ 
p
 / 11.

32  
­


	@vision/utils/misc.py

1 
impÜt
 
time


2 
impÜt
 
tÜch


5 
def
 
	$¡r2boŞ
(
s
):

6  
s
.
	$low”
(è
	`š
 ('true', '1')

9 
şass
 
Tim”
:

10 
def
 
	$__š™__
(
£lf
):

11 
£lf
.
şock
 = {
	}
}

13 
def
 
¡¬t
(
£lf
, 
key
="default"):

14 
£lf
.
şock
[
key
] = 
time
.
	$time
()

16 
def
 
	`’d
(
£lf
, 
key
="default"):

17 
key
 
nÙ
 
š
 
£lf
.
şock
:

18 
¿i£
 
	`Exû±iÚ
(
f
"{key} is‚ot inhe clock.")

19 
š‹rv®
 = 
time
.
	`time
(è- 
£lf
.
şock
[
key
]

20 
d–
 
£lf
.
şock
[
key
]

21  
š‹rv®


24 
def
 
	$§ve_checkpošt
(
•och
, 
Ãt_¡©e_diù
, 
İtimiz”_¡©e_diù
, 
be¡_scÜe
, 
checkpošt_·th
, 
mod–_·th
):

25 
tÜch
.
	`§ve
({

26 '•och': 
•och
,

27 'mod–': 
Ãt_¡©e_diù
,

28 'İtimiz”': 
İtimiz”_¡©e_diù
,

29 'be¡_scÜe': 
be¡_scÜe


30 
	}
}, 
	gcheckpošt_·th
)

31 
	gtÜch
.
	$§ve
(
Ãt_¡©e_diù
, 
mod–_·th
)

34 
def
 
	$lßd_checkpošt
(
checkpošt_·th
):

35  
tÜch
.
	$lßd
(
checkpošt_·th
)

38 
def
 
	$ä“ze_Ãt_Ïy”s
(
Ãt
):

39 
·¿m
 
š
 
Ãt
.
	$·¿m‘”s
():

40 
·¿m
.
»quœes_g¿d
 = 
F®£


43 
def
 
	$¡Üe_Ïb–s
(
·th
, 
Ïb–s
):

44 
w™h
 
	`İ’
(
·th
, "w"è
as
 
f
:

45 
f
.
	`wr™e
("\n".
	`još
(
Ïb–s
))

	@vision/utils/model_book.py

1 
äom
 
cŞËùiÚs
 
impÜt
 
Ord”edDiù


2 
impÜt
 
	gtÜch
.
Â
 
as
‚n

5 
şass
 
	gMod–Book
:

8 
Exam¶e
:

9 
book
 = 
	$Mod–Book
(
mod–_á
)

10 
p
, 
m
 
š
 
book
.
	$cÚv2d_moduËs
():

11 
	`´št
('·th:', 
p
, 'num oàf‹rs:', 
m
.
out_chªÃls
)

12 
as£¹
 
m
 
is
 
book
.
	`g‘_moduË
(
p
)

15 
def
 
	$__š™__
(
£lf
, 
mod–
):

16 
£lf
.
_mod–
 = 
mod–


17 
£lf
.
_moduËs
 = 
	$Ord”edDiù
()

18 
£lf
.
_·ths
 = 
	$Ord”edDiù
()

19 
·th
 = []

20 
£lf
.
	$_cÚ¡ruù
(
£lf
.
_mod–
, 
·th
)

22 
def
 
	$_cÚ¡ruù
(
£lf
, 
moduË
, 
·th
):

23 
nÙ
 
moduË
.
_moduËs
:

25 
Çme
, 
m
 
š
 
moduË
.
_moduËs
.
	$™ems
():

26 
cur_·th
 = 
	`tu¶e
(
·th
 + [
Çme
])

27 
£lf
.
_·ths
[
m
] = 
cur_·th


28 
£lf
.
_moduËs
[
cur_·th
] = 
m


29 
£lf
.
	`_cÚ¡ruù
(
m
, 
·th
 + [
Çme
])

31 
def
 
	$cÚv2d_moduËs
(
£lf
):

32  
£lf
.
	$moduËs
(
Â
.
CÚv2d
)

34 
def
 
	$lš—r_moduËs
(
£lf
):

35  
£lf
.
	$moduËs
(
Â
.
Lš—r
)

37 
def
 
	$moduËs
(
£lf
, 
moduË_ty³
=
NÚe
):

38 
p
, 
m
 
š
 
£lf
.
_moduËs
.
	$™ems
():

39 
nÙ
 
moduË_ty³
 
Ü
 
	$isš¡ªû
(
m
, 
moduË_ty³
):

40 
y›ld
 
p
, 
m


42 
def
 
	$num_of_cÚv2d_moduËs
(
£lf
):

43  
£lf
.
	$num_of_moduËs
(
Â
.
CÚv2d
)

45 
def
 
	$num_of_cÚv2d_f‹rs
(
£lf
):

48 
H”e
 
we
 
Œ—t
 
the
 
sub
 
weight
 
w™h
 
size
 
of
 [
š_chªÃls
, 
h
, 
w
] 
as
 
a
 
sšgË
 
f‹r
.

50 
num_f‹rs
 = 0

51 
_
, 
m
 
š
 
£lf
.
	$cÚv2d_moduËs
():

52 
num_f‹rs
 +ğ
m
.
out_chªÃls


53  
num_f‹rs


55 
def
 
	$num_of_lš—r_moduËs
(
£lf
):

56  
£lf
.
	$num_of_moduËs
(
Â
.
Lš—r
)

58 
def
 
	$num_of_lš—r_f‹rs
(
£lf
):

59 
num_f‹rs
 = 0

60 
_
, 
m
 
š
 
£lf
.
	$lš—r_moduËs
():

61 
num_f‹rs
 +ğ
m
.
out_ã©u»s


62  
num_f‹rs


64 
def
 
	$num_of_moduËs
(
£lf
, 
moduË_ty³
=
NÚe
):

65 
num
 = 0

66 
p
, 
m
 
š
 
£lf
.
_moduËs
.
	$™ems
():

67 
nÙ
 
moduË_ty³
 
Ü
 
	$isš¡ªû
(
m
, 
moduË_ty³
):

68 
num
 += 1

69  
num


71 
def
 
	$g‘_moduË
(
£lf
, 
·th
):

72  
£lf
.
_moduËs
.
	$g‘
(
·th
)

74 
def
 
	$g‘_·th
(
£lf
, 
moduË
):

75  
£lf
.
_·ths
.
	$g‘
(
moduË
)

77 
def
 
	$upd©e
(
£lf
, 
·th
, 
moduË
):

78 
Şd_moduË
 = 
£lf
.
_moduËs
[
·th
]

79 
d–
 
£lf
.
_·ths
[
Şd_moduË
]

80 
£lf
.
_·ths
[
moduË
] = 
·th


81 
£lf
.
_moduËs
[
·th
] = 
moduË


	@visual_tf_models.py

1 
impÜt
 
‹nsÜæow
 
as
 
tf


2 
äom
 
	g‹nsÜæow
.
	gpythÚ
.
¶©fÜm
 
impÜt
 
gfe


3 
impÜt
 
sys


4 
impÜt
 
time


6 
Ën
(
sys
.
¬gv
) < 2:

7 
´št
("Usage:…ython visual_tf_model.py <model.pb>")

8 
sys
.
	$ex™
(0)

10 
mod–_fe_Çme
 = 
sys
.
¬gv
[1]

11 
w™h
 
tf
.
	$SessiÚ
(è
as
 
£ss
:

12 
w™h
 
gfe
.
	`Fa¡GFe
(
mod–_fe_Çme
, 'rb'è
as
 
f
:

13 
g¿ph_def
 = 
tf
.
	$G¿phDef
()

14 
g¿ph_def
.
	`P¬£FromSŒšg
(
f
.
	$»ad
())

15 
g_š
 = 
tf
.
	$impÜt_g¿ph_def
(
g¿ph_def
)

16 
LOGDIR
='log'

17 
Œaš_wr™”
 = 
tf
.
summ¬y
.
	$FeWr™”
(
LOGDIR
)

18 
Œaš_wr™”
.
	$add_g¿ph
(
£ss
.
g¿ph
)

20 
True
:

21 
time
.
	`¦“p
(1000)

	@
1
.
1
/usr/include
53
1401
convert_to_caffe2_models.py
draw_eval_results.py
eval_ssd.py
extract_tf_weights.py
open_images_downloader.py
prune_alexnet.py
run_ssd_example.py
run_ssd_live_caffe2.py
run_ssd_live_demo.py
train_ssd.py
translate_tf_mobilenetv1.py
vision/__init__.py
vision/datasets/__init__.py
vision/datasets/collation.py
vision/datasets/how_far_am_i.py
vision/datasets/open_images.py
vision/datasets/voc_dataset.py
vision/nn/__init__.py
vision/nn/alexnet.py
vision/nn/mobilenet.py
vision/nn/mobilenet_v2.py
vision/nn/multibox_loss.py
vision/nn/scaled_l2_norm.py
vision/nn/squeezenet.py
vision/nn/vgg.py
vision/prunning/__init__.py
vision/prunning/prunner.py
vision/ssd/__init__.py
vision/ssd/config/__init__.py
vision/ssd/config/mobilenetv1_ssd_config.py
vision/ssd/config/squeezenet_ssd_config.py
vision/ssd/config/vgg_ssd_config.py
vision/ssd/data_preprocessing.py
vision/ssd/fpn_mobilenetv1_ssd.py
vision/ssd/fpn_ssd.py
vision/ssd/mobilenet_v2_ssd_lite.py
vision/ssd/mobilenetv1_ssd.py
vision/ssd/mobilenetv1_ssd_lite.py
vision/ssd/predictor.py
vision/ssd/squeezenet_ssd_lite.py
vision/ssd/ssd.py
vision/ssd/vgg_ssd.py
vision/test/__init__.py
vision/test/test_vgg_ssd.py
vision/transforms/__init__.py
vision/transforms/transforms.py
vision/utils/__init__.py
vision/utils/box_utils.py
vision/utils/box_utils_numpy.py
vision/utils/measurements.py
vision/utils/misc.py
vision/utils/model_book.py
visual_tf_models.py
